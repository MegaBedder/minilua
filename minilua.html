<div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #75715e">/* This is a heavily customized and minimized copy of Lua 5.1.5. */</span>
<span style="color: #75715e">/* It&#39;s only used to build LuaJIT. It does NOT have all standard functions! */</span>
<span style="color: #75715e">/******************************************************************************</span>
<span style="color: #75715e">* Copyright (C) 1994-2012 Lua.org, PUC-Rio.  All rights reserved.</span>
<span style="color: #75715e">*</span>
<span style="color: #75715e">* Permission is hereby granted, free of charge, to any person obtaining</span>
<span style="color: #75715e">* a copy of this software and associated documentation files (the</span>
<span style="color: #75715e">* &quot;Software&quot;), to deal in the Software without restriction, including</span>
<span style="color: #75715e">* without limitation the rights to use, copy, modify, merge, publish,</span>
<span style="color: #75715e">* distribute, sublicense, and/or sell copies of the Software, and to</span>
<span style="color: #75715e">* permit persons to whom the Software is furnished to do so, subject to</span>
<span style="color: #75715e">* the following conditions:</span>
<span style="color: #75715e">*</span>
<span style="color: #75715e">* The above copyright notice and this permission notice shall be</span>
<span style="color: #75715e">* included in all copies or substantial portions of the Software.</span>
<span style="color: #75715e">*</span>
<span style="color: #75715e">* THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span style="color: #75715e">* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span style="color: #75715e">* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.</span>
<span style="color: #75715e">* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY</span>
<span style="color: #75715e">* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,</span>
<span style="color: #75715e">* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE</span>
<span style="color: #75715e">* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span style="color: #75715e">******************************************************************************/</span>
<span style="color: #75715e">#ifdef _MSC_VER</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">__int64</span> <span style="color: #f8f8f2">U64;</span>
<span style="color: #75715e">#else</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">long</span> <span style="color: #66d9ef">long</span> <span style="color: #f8f8f2">U64;</span>
<span style="color: #75715e">#endif</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">_CRT_glob</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #75715e">#include &lt;stddef.h&gt;</span>
<span style="color: #75715e">#include &lt;stdarg.h&gt;</span>
<span style="color: #75715e">#include &lt;limits.h&gt;</span>
<span style="color: #75715e">#include &lt;math.h&gt;</span>
<span style="color: #75715e">#include &lt;ctype.h&gt;</span>
<span style="color: #75715e">#include &lt;stdio.h&gt;</span>
<span style="color: #75715e">#include &lt;stdlib.h&gt;</span>
<span style="color: #75715e">#include &lt;string.h&gt;</span>
<span style="color: #75715e">#include &lt;setjmp.h&gt;</span>
<span style="color: #75715e">#include &lt;errno.h&gt;</span>
<span style="color: #75715e">#include &lt;time.h&gt;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">enum</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">TM_INDEX,</span>
<span style="color: #f8f8f2">TM_NEWINDEX,</span>
<span style="color: #f8f8f2">TM_GC,</span>
<span style="color: #f8f8f2">TM_MODE,</span>
<span style="color: #f8f8f2">TM_EQ,</span>
<span style="color: #f8f8f2">TM_ADD,</span>
<span style="color: #f8f8f2">TM_SUB,</span>
<span style="color: #f8f8f2">TM_MUL,</span>
<span style="color: #f8f8f2">TM_DIV,</span>
<span style="color: #f8f8f2">TM_MOD,</span>
<span style="color: #f8f8f2">TM_POW,</span>
<span style="color: #f8f8f2">TM_UNM,</span>
<span style="color: #f8f8f2">TM_LEN,</span>
<span style="color: #f8f8f2">TM_LT,</span>
<span style="color: #f8f8f2">TM_LE,</span>
<span style="color: #f8f8f2">TM_CONCAT,</span>
<span style="color: #f8f8f2">TM_CALL,</span>
<span style="color: #f8f8f2">TM_N</span>
<span style="color: #f8f8f2">}TMS;</span>
<span style="color: #66d9ef">enum</span> <span style="color: #f8f8f2">OpMode{iABC,iABx,iAsBx};</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">enum</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">OP_MOVE,</span>
<span style="color: #f8f8f2">OP_LOADK,</span>
<span style="color: #f8f8f2">OP_LOADBOOL,</span>
<span style="color: #f8f8f2">OP_LOADNIL,</span>
<span style="color: #f8f8f2">OP_GETUPVAL,</span>
<span style="color: #f8f8f2">OP_GETGLOBAL,</span>
<span style="color: #f8f8f2">OP_GETTABLE,</span>
<span style="color: #f8f8f2">OP_SETGLOBAL,</span>
<span style="color: #f8f8f2">OP_SETUPVAL,</span>
<span style="color: #f8f8f2">OP_SETTABLE,</span>
<span style="color: #f8f8f2">OP_NEWTABLE,</span>
<span style="color: #f8f8f2">OP_SELF,</span>
<span style="color: #f8f8f2">OP_ADD,</span>
<span style="color: #f8f8f2">OP_SUB,</span>
<span style="color: #f8f8f2">OP_MUL,</span>
<span style="color: #f8f8f2">OP_DIV,</span>
<span style="color: #f8f8f2">OP_MOD,</span>
<span style="color: #f8f8f2">OP_POW,</span>
<span style="color: #f8f8f2">OP_UNM,</span>
<span style="color: #f8f8f2">OP_NOT,</span>
<span style="color: #f8f8f2">OP_LEN,</span>
<span style="color: #f8f8f2">OP_CONCAT,</span>
<span style="color: #f8f8f2">OP_JMP,</span>
<span style="color: #f8f8f2">OP_EQ,</span>
<span style="color: #f8f8f2">OP_LT,</span>
<span style="color: #f8f8f2">OP_LE,</span>
<span style="color: #f8f8f2">OP_TEST,</span>
<span style="color: #f8f8f2">OP_TESTSET,</span>
<span style="color: #f8f8f2">OP_CALL,</span>
<span style="color: #f8f8f2">OP_TAILCALL,</span>
<span style="color: #f8f8f2">OP_RETURN,</span>
<span style="color: #f8f8f2">OP_FORLOOP,</span>
<span style="color: #f8f8f2">OP_FORPREP,</span>
<span style="color: #f8f8f2">OP_TFORLOOP,</span>
<span style="color: #f8f8f2">OP_SETLIST,</span>
<span style="color: #f8f8f2">OP_CLOSE,</span>
<span style="color: #f8f8f2">OP_CLOSURE,</span>
<span style="color: #f8f8f2">OP_VARARG</span>
<span style="color: #f8f8f2">}OpCode;</span>
<span style="color: #66d9ef">enum</span> <span style="color: #f8f8f2">OpArgMask{</span>
<span style="color: #f8f8f2">OpArgN,</span>
<span style="color: #f8f8f2">OpArgU,</span>
<span style="color: #f8f8f2">OpArgR,</span>
<span style="color: #f8f8f2">OpArgK</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">enum</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">VVOID,</span>
<span style="color: #f8f8f2">VNIL,</span>
<span style="color: #f8f8f2">VTRUE,</span>
<span style="color: #f8f8f2">VFALSE,</span>
<span style="color: #f8f8f2">VK,</span>
<span style="color: #f8f8f2">VKNUM,</span>
<span style="color: #f8f8f2">VLOCAL,</span>
<span style="color: #f8f8f2">VUPVAL,</span>
<span style="color: #f8f8f2">VGLOBAL,</span>
<span style="color: #f8f8f2">VINDEXED,</span>
<span style="color: #f8f8f2">VJMP,</span>
<span style="color: #f8f8f2">VRELOCABLE,</span>
<span style="color: #f8f8f2">VNONRELOC,</span>
<span style="color: #f8f8f2">VCALL,</span>
<span style="color: #f8f8f2">VVARARG</span>
<span style="color: #f8f8f2">}expkind;</span>
<span style="color: #66d9ef">enum</span> <span style="color: #f8f8f2">RESERVED{</span>
<span style="color: #f8f8f2">TK_AND</span><span style="color: #f92672">=</span><span style="color: #ae81ff">257</span><span style="color: #f8f8f2">,TK_BREAK,</span>
<span style="color: #f8f8f2">TK_DO,TK_ELSE,TK_ELSEIF,TK_END,TK_FALSE,TK_FOR,TK_FUNCTION,</span>
<span style="color: #f8f8f2">TK_IF,TK_IN,TK_LOCAL,TK_NIL,TK_NOT,TK_OR,TK_REPEAT,</span>
<span style="color: #f8f8f2">TK_RETURN,TK_THEN,TK_TRUE,TK_UNTIL,TK_WHILE,</span>
<span style="color: #f8f8f2">TK_CONCAT,TK_DOTS,TK_EQ,TK_GE,TK_LE,TK_NE,TK_NUMBER,</span>
<span style="color: #f8f8f2">TK_NAME,TK_STRING,TK_EOS</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">enum</span> <span style="color: #f8f8f2">BinOpr{</span>
<span style="color: #f8f8f2">OPR_ADD,OPR_SUB,OPR_MUL,OPR_DIV,OPR_MOD,OPR_POW,</span>
<span style="color: #f8f8f2">OPR_CONCAT,</span>
<span style="color: #f8f8f2">OPR_NE,OPR_EQ,</span>
<span style="color: #f8f8f2">OPR_LT,OPR_LE,OPR_GT,OPR_GE,</span>
<span style="color: #f8f8f2">OPR_AND,OPR_OR,</span>
<span style="color: #f8f8f2">OPR_NOBINOPR</span>
<span style="color: #f8f8f2">}BinOpr;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">enum</span> <span style="color: #f8f8f2">UnOpr{OPR_MINUS,OPR_NOT,OPR_LEN,OPR_NOUNOPR}UnOpr;</span>
<span style="color: #75715e">#define LUA_QL(x)&quot;&#39;&quot;x&quot;&#39;&quot;</span>
<span style="color: #75715e">#define luai_apicheck(L,o){(void)L;}</span>
<span style="color: #75715e">#define lua_number2str(s,n)sprintf((s),&quot;%.14g&quot;,(n))</span>
<span style="color: #75715e">#define lua_str2number(s,p)strtod((s),(p))</span>
<span style="color: #75715e">#define luai_numadd(a,b)((a)+(b))</span>
<span style="color: #75715e">#define luai_numsub(a,b)((a)-(b))</span>
<span style="color: #75715e">#define luai_nummul(a,b)((a)*(b))</span>
<span style="color: #75715e">#define luai_numdiv(a,b)((a)/(b))</span>
<span style="color: #75715e">#define luai_nummod(a,b)((a)-floor((a)/(b))*(b))</span>
<span style="color: #75715e">#define luai_numpow(a,b)(pow(a,b))</span>
<span style="color: #75715e">#define luai_numunm(a)(-(a))</span>
<span style="color: #75715e">#define luai_numeq(a,b)((a)==(b))</span>
<span style="color: #75715e">#define luai_numlt(a,b)((a)&lt;(b))</span>
<span style="color: #75715e">#define luai_numle(a,b)((a)&lt;=(b))</span>
<span style="color: #75715e">#define luai_numisnan(a)(!luai_numeq((a),(a)))</span>
<span style="color: #75715e">#define lua_number2int(i,d)((i)=(int)(d))</span>
<span style="color: #75715e">#define lua_number2integer(i,d)((i)=(lua_Integer)(d))</span>
<span style="color: #75715e">#define LUAI_THROW(L,c)longjmp((c)-&gt;b,1)</span>
<span style="color: #75715e">#define LUAI_TRY(L,c,a)if(setjmp((c)-&gt;b)==0){a}</span>
<span style="color: #75715e">#define lua_pclose(L,file)((void)((void)L,file),0)</span>
<span style="color: #75715e">#define lua_upvalueindex(i)((-10002)-(i))</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_State</span> <span style="color: #f8f8f2">lua_State;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #a6e22e">int</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lua_CFunction)(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L);</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lua_Reader)(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud,</span><span style="color: #66d9ef">size_t</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">sz);</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lua_Alloc)(</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ptr,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">osize,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">nsize);</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">lua_Number;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">lua_Integer;</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_settop</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_type</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span> <span style="color: #a6e22e">lua_tolstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx,</span><span style="color: #66d9ef">size_t</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">len);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">size_t</span> <span style="color: #a6e22e">lua_objlen</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_pushlstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_pushcclosure</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_CFunction</span> <span style="color: #f8f8f2">fn,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_createtable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narr,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nrec);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_setfield</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">k);</span>
<span style="color: #75715e">#define lua_pop(L,n)lua_settop(L,-(n)-1)</span>
<span style="color: #75715e">#define lua_newtable(L)lua_createtable(L,0,0)</span>
<span style="color: #75715e">#define lua_pushcfunction(L,f)lua_pushcclosure(L,(f),0)</span>
<span style="color: #75715e">#define lua_strlen(L,i)lua_objlen(L,(i))</span>
<span style="color: #75715e">#define lua_isfunction(L,n)(lua_type(L,(n))==6)</span>
<span style="color: #75715e">#define lua_istable(L,n)(lua_type(L,(n))==5)</span>
<span style="color: #75715e">#define lua_isnil(L,n)(lua_type(L,(n))==0)</span>
<span style="color: #75715e">#define lua_isboolean(L,n)(lua_type(L,(n))==1)</span>
<span style="color: #75715e">#define lua_isnone(L,n)(lua_type(L,(n))==(-1))</span>
<span style="color: #75715e">#define lua_isnoneornil(L,n)(lua_type(L,(n))&lt;=0)</span>
<span style="color: #75715e">#define lua_pushliteral(L,s)lua_pushlstring(L,&quot;&quot;s,(sizeof(s)/sizeof(char))-1)</span>
<span style="color: #75715e">#define lua_setglobal(L,s)lua_setfield(L,(-10002),(s))</span>
<span style="color: #75715e">#define lua_tostring(L,i)lua_tolstring(L,(i),NULL)</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_Debug</span> <span style="color: #f8f8f2">lua_Debug;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #a6e22e">void</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lua_Hook)(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_Debug</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ar);</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_Debug{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">event;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">namewhat;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">what;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">source;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">currentline;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nups;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">linedefined;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">lastlinedefined;</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">short_src[</span><span style="color: #ae81ff">60</span><span style="color: #f8f8f2">];</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i_ci;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">lu_int32;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">lu_mem;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">l_mem;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">lu_byte;</span>
<span style="color: #75715e">#define IntPoint(p)((unsigned int)(lu_mem)(p))</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">union</span><span style="color: #f8f8f2">{</span><span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">u;</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s;</span><span style="color: #66d9ef">long</span> <span style="color: #f8f8f2">l;}L_Umaxalign;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">l_uacNumber;</span>
<span style="color: #75715e">#define check_exp(c,e)(e)</span>
<span style="color: #75715e">#define UNUSED(x)((void)(x))</span>
<span style="color: #75715e">#define cast(t,exp)((t)(exp))</span>
<span style="color: #75715e">#define cast_byte(i)cast(lu_byte,(i))</span>
<span style="color: #75715e">#define cast_num(i)cast(lua_Number,(i))</span>
<span style="color: #75715e">#define cast_int(i)cast(int,(i))</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #f8f8f2">lu_int32</span> <span style="color: #f8f8f2">Instruction;</span>
<span style="color: #75715e">#define condhardstacktests(x)((void)0)</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">union</span> <span style="color: #f8f8f2">GCObject</span> <span style="color: #f8f8f2">GCObject;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">GCheader{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;lu_byte</span> <span style="color: #f8f8f2">tt;lu_byte</span> <span style="color: #f8f8f2">marked;</span>
<span style="color: #f8f8f2">}GCheader;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">union</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">gc;</span>
<span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #f8f8f2">}Value;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_TValue{</span>
<span style="color: #f8f8f2">Value</span> <span style="color: #f8f8f2">value;</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">tt;</span>
<span style="color: #f8f8f2">}TValue;</span>
<span style="color: #75715e">#define ttisnil(o)(ttype(o)==0)</span>
<span style="color: #75715e">#define ttisnumber(o)(ttype(o)==3)</span>
<span style="color: #75715e">#define ttisstring(o)(ttype(o)==4)</span>
<span style="color: #75715e">#define ttistable(o)(ttype(o)==5)</span>
<span style="color: #75715e">#define ttisfunction(o)(ttype(o)==6)</span>
<span style="color: #75715e">#define ttisboolean(o)(ttype(o)==1)</span>
<span style="color: #75715e">#define ttisuserdata(o)(ttype(o)==7)</span>
<span style="color: #75715e">#define ttisthread(o)(ttype(o)==8)</span>
<span style="color: #75715e">#define ttislightuserdata(o)(ttype(o)==2)</span>
<span style="color: #75715e">#define ttype(o)((o)-&gt;tt)</span>
<span style="color: #75715e">#define gcvalue(o)check_exp(iscollectable(o),(o)-&gt;value.gc)</span>
<span style="color: #75715e">#define pvalue(o)check_exp(ttislightuserdata(o),(o)-&gt;value.p)</span>
<span style="color: #75715e">#define nvalue(o)check_exp(ttisnumber(o),(o)-&gt;value.n)</span>
<span style="color: #75715e">#define rawtsvalue(o)check_exp(ttisstring(o),&amp;(o)-&gt;value.gc-&gt;ts)</span>
<span style="color: #75715e">#define tsvalue(o)(&amp;rawtsvalue(o)-&gt;tsv)</span>
<span style="color: #75715e">#define rawuvalue(o)check_exp(ttisuserdata(o),&amp;(o)-&gt;value.gc-&gt;u)</span>
<span style="color: #75715e">#define uvalue(o)(&amp;rawuvalue(o)-&gt;uv)</span>
<span style="color: #75715e">#define clvalue(o)check_exp(ttisfunction(o),&amp;(o)-&gt;value.gc-&gt;cl)</span>
<span style="color: #75715e">#define hvalue(o)check_exp(ttistable(o),&amp;(o)-&gt;value.gc-&gt;h)</span>
<span style="color: #75715e">#define bvalue(o)check_exp(ttisboolean(o),(o)-&gt;value.b)</span>
<span style="color: #75715e">#define thvalue(o)check_exp(ttisthread(o),&amp;(o)-&gt;value.gc-&gt;th)</span>
<span style="color: #75715e">#define l_isfalse(o)(ttisnil(o)||(ttisboolean(o)&amp;&amp;bvalue(o)==0))</span>
<span style="color: #75715e">#define checkconsistency(obj)</span>
<span style="color: #75715e">#define checkliveness(g,obj)</span>
<span style="color: #75715e">#define setnilvalue(obj)((obj)-&gt;tt=0)</span>
<span style="color: #75715e">#define setnvalue(obj,x){TValue*i_o=(obj);i_o-&gt;value.n=(x);i_o-&gt;tt=3;}</span>
<span style="color: #75715e">#define setbvalue(obj,x){TValue*i_o=(obj);i_o-&gt;value.b=(x);i_o-&gt;tt=1;}</span>
<span style="color: #75715e">#define setsvalue(L,obj,x){TValue*i_o=(obj);i_o-&gt;value.gc=cast(GCObject*,(x));i_o-&gt;tt=4;checkliveness(G(L),i_o);}</span>
<span style="color: #75715e">#define setuvalue(L,obj,x){TValue*i_o=(obj);i_o-&gt;value.gc=cast(GCObject*,(x));i_o-&gt;tt=7;checkliveness(G(L),i_o);}</span>
<span style="color: #75715e">#define setthvalue(L,obj,x){TValue*i_o=(obj);i_o-&gt;value.gc=cast(GCObject*,(x));i_o-&gt;tt=8;checkliveness(G(L),i_o);}</span>
<span style="color: #75715e">#define setclvalue(L,obj,x){TValue*i_o=(obj);i_o-&gt;value.gc=cast(GCObject*,(x));i_o-&gt;tt=6;checkliveness(G(L),i_o);}</span>
<span style="color: #75715e">#define sethvalue(L,obj,x){TValue*i_o=(obj);i_o-&gt;value.gc=cast(GCObject*,(x));i_o-&gt;tt=5;checkliveness(G(L),i_o);}</span>
<span style="color: #75715e">#define setptvalue(L,obj,x){TValue*i_o=(obj);i_o-&gt;value.gc=cast(GCObject*,(x));i_o-&gt;tt=(8+1);checkliveness(G(L),i_o);}</span>
<span style="color: #75715e">#define setobj(L,obj1,obj2){const TValue*o2=(obj2);TValue*o1=(obj1);o1-&gt;value=o2-&gt;value;o1-&gt;tt=o2-&gt;tt;checkliveness(G(L),o1);}</span>
<span style="color: #75715e">#define setttype(obj,tt)(ttype(obj)=(tt))</span>
<span style="color: #75715e">#define iscollectable(o)(ttype(o)&gt;=4)</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">StkId;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">union</span> <span style="color: #f8f8f2">TString{</span>
<span style="color: #f8f8f2">L_Umaxalign</span> <span style="color: #f8f8f2">dummy;</span>
<span style="color: #66d9ef">struct</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;lu_byte</span> <span style="color: #f8f8f2">tt;lu_byte</span> <span style="color: #f8f8f2">marked;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">reserved;</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">hash;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">len;</span>
<span style="color: #f8f8f2">}tsv;</span>
<span style="color: #f8f8f2">}TString;</span>
<span style="color: #75715e">#define getstr(ts)cast(const char*,(ts)+1)</span>
<span style="color: #75715e">#define svalue(o)getstr(rawtsvalue(o))</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">union</span> <span style="color: #f8f8f2">Udata{</span>
<span style="color: #f8f8f2">L_Umaxalign</span> <span style="color: #f8f8f2">dummy;</span>
<span style="color: #66d9ef">struct</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;lu_byte</span> <span style="color: #f8f8f2">tt;lu_byte</span> <span style="color: #f8f8f2">marked;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">metatable;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">env;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">len;</span>
<span style="color: #f8f8f2">}uv;</span>
<span style="color: #f8f8f2">}Udata;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Proto{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;lu_byte</span> <span style="color: #f8f8f2">tt;lu_byte</span> <span style="color: #f8f8f2">marked;</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">k;</span>
<span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">code;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Proto</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">p;</span>
<span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lineinfo;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LocVar</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">locvars;</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">upvalues;</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">source;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sizeupvalues;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sizek;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sizecode;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sizelineinfo;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sizep;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sizelocvars;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">linedefined;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">lastlinedefined;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">gclist;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">nups;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">numparams;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">is_vararg;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">maxstacksize;</span>
<span style="color: #f8f8f2">}Proto;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LocVar{</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">varname;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">startpc;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">endpc;</span>
<span style="color: #f8f8f2">}LocVar;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">UpVal{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;lu_byte</span> <span style="color: #f8f8f2">tt;lu_byte</span> <span style="color: #f8f8f2">marked;</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v;</span>
<span style="color: #66d9ef">union</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">value;</span>
<span style="color: #66d9ef">struct</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">prev;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;</span>
<span style="color: #f8f8f2">}l;</span>
<span style="color: #f8f8f2">}u;</span>
<span style="color: #f8f8f2">}UpVal;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">CClosure{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;lu_byte</span> <span style="color: #f8f8f2">tt;lu_byte</span> <span style="color: #f8f8f2">marked;lu_byte</span> <span style="color: #f8f8f2">isC;lu_byte</span> <span style="color: #f8f8f2">nupvalues;GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">gclist;</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">env;</span>
<span style="color: #f8f8f2">lua_CFunction</span> <span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">upvalue[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">}CClosure;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LClosure{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;lu_byte</span> <span style="color: #f8f8f2">tt;lu_byte</span> <span style="color: #f8f8f2">marked;lu_byte</span> <span style="color: #f8f8f2">isC;lu_byte</span> <span style="color: #f8f8f2">nupvalues;GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">gclist;</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">env;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">upvals[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">}LClosure;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">union</span> <span style="color: #f8f8f2">Closure{</span>
<span style="color: #f8f8f2">CClosure</span> <span style="color: #f8f8f2">c;</span>
<span style="color: #f8f8f2">LClosure</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">}Closure;</span>
<span style="color: #75715e">#define iscfunction(o)(ttype(o)==6&amp;&amp;clvalue(o)-&gt;c.isC)</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">union</span> <span style="color: #f8f8f2">TKey{</span>
<span style="color: #66d9ef">struct</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Value</span> <span style="color: #f8f8f2">value;</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">tt;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;</span>
<span style="color: #f8f8f2">}nk;</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">tvk;</span>
<span style="color: #f8f8f2">}TKey;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Node{</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">i_val;</span>
<span style="color: #f8f8f2">TKey</span> <span style="color: #f8f8f2">i_key;</span>
<span style="color: #f8f8f2">}Node;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Table{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;lu_byte</span> <span style="color: #f8f8f2">tt;lu_byte</span> <span style="color: #f8f8f2">marked;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">flags;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">lsizenode;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">metatable;</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">array;</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">node;</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lastfree;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">gclist;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sizearray;</span>
<span style="color: #f8f8f2">}Table;</span>
<span style="color: #75715e">#define lmod(s,size)(check_exp((size&amp;(size-1))==0,(cast(int,(s)&amp;((size)-1)))))</span>
<span style="color: #75715e">#define twoto(x)((size_t)1&lt;&lt;(x))</span>
<span style="color: #75715e">#define sizenode(t)(twoto((t)-&gt;lsizenode))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">luaO_nilobject_;</span>
<span style="color: #75715e">#define ceillog2(x)(luaO_log2((x)-1)+1)</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaO_log2</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">x);</span>
<span style="color: #75715e">#define gfasttm(g,et,e)((et)==NULL?NULL:((et)-&gt;flags&amp;(1u&lt;&lt;(e)))?NULL:luaT_gettm(et,e,(g)-&gt;tmname[e]))</span>
<span style="color: #75715e">#define fasttm(l,et,e)gfasttm(G(l),et,e)</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaT_gettm</span><span style="color: #f8f8f2">(Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">events,TMS</span> <span style="color: #f8f8f2">event,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ename);</span>
<span style="color: #75715e">#define luaM_reallocv(L,b,on,n,e)((cast(size_t,(n)+1)&lt;=((size_t)(~(size_t)0)-2)/(e))?luaM_realloc_(L,(b),(on)*(e),(n)*(e)):luaM_toobig(L))</span>
<span style="color: #75715e">#define luaM_freemem(L,b,s)luaM_realloc_(L,(b),(s),0)</span>
<span style="color: #75715e">#define luaM_free(L,b)luaM_realloc_(L,(b),sizeof(*(b)),0)</span>
<span style="color: #75715e">#define luaM_freearray(L,b,n,t)luaM_reallocv(L,(b),n,0,sizeof(t))</span>
<span style="color: #75715e">#define luaM_malloc(L,t)luaM_realloc_(L,NULL,0,(t))</span>
<span style="color: #75715e">#define luaM_new(L,t)cast(t*,luaM_malloc(L,sizeof(t)))</span>
<span style="color: #75715e">#define luaM_newvector(L,n,t)cast(t*,luaM_reallocv(L,NULL,0,n,sizeof(t)))</span>
<span style="color: #75715e">#define luaM_growvector(L,v,nelems,size,t,limit,e)if((nelems)+1&gt;(size))((v)=cast(t*,luaM_growaux_(L,v,&amp;(size),sizeof(t),limit,e)))</span>
<span style="color: #75715e">#define luaM_reallocvector(L,v,oldn,n,t)((v)=cast(t*,luaM_reallocv(L,v,oldn,n,sizeof(t))))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaM_realloc_</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">block,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">oldsize,</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">size);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaM_toobig</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaM_growaux_</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">block,</span><span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">size,</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">size_elem,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">limit,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">errormsg);</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Zio</span> <span style="color: #f8f8f2">ZIO;</span>
<span style="color: #75715e">#define char2int(c)cast(int,cast(unsigned char,(c)))</span>
<span style="color: #75715e">#define zgetc(z)(((z)-&gt;n--)&gt;0?char2int(*(z)-&gt;p++):luaZ_fill(z))</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Mbuffer{</span>
<span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">buffer;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">buffsize;</span>
<span style="color: #f8f8f2">}Mbuffer;</span>
<span style="color: #75715e">#define luaZ_initbuffer(L,buff)((buff)-&gt;buffer=NULL,(buff)-&gt;buffsize=0)</span>
<span style="color: #75715e">#define luaZ_buffer(buff)((buff)-&gt;buffer)</span>
<span style="color: #75715e">#define luaZ_sizebuffer(buff)((buff)-&gt;buffsize)</span>
<span style="color: #75715e">#define luaZ_bufflen(buff)((buff)-&gt;n)</span>
<span style="color: #75715e">#define luaZ_resetbuffer(buff)((buff)-&gt;n=0)</span>
<span style="color: #75715e">#define luaZ_resizebuffer(L,buff,size)(luaM_reallocvector(L,(buff)-&gt;buffer,(buff)-&gt;buffsize,size,char),(buff)-&gt;buffsize=size)</span>
<span style="color: #75715e">#define luaZ_freebuffer(L,buff)luaZ_resizebuffer(L,buff,0)</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Zio{</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">lua_Reader</span> <span style="color: #f8f8f2">reader;</span>
<span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">data;</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaZ_fill</span><span style="color: #f8f8f2">(ZIO</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">z);</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_longjmp;</span>
<span style="color: #75715e">#define gt(L)(&amp;L-&gt;l_gt)</span>
<span style="color: #75715e">#define registry(L)(&amp;G(L)-&gt;l_registry)</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">stringtable{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">hash;</span>
<span style="color: #f8f8f2">lu_int32</span> <span style="color: #f8f8f2">nuse;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">size;</span>
<span style="color: #f8f8f2">}stringtable;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">CallInfo{</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">base;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">func;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">top;</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">savedpc;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nresults;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">tailcalls;</span>
<span style="color: #f8f8f2">}CallInfo;</span>
<span style="color: #75715e">#define curr_func(L)(clvalue(L-&gt;ci-&gt;func))</span>
<span style="color: #75715e">#define ci_func(ci)(clvalue((ci)-&gt;func))</span>
<span style="color: #75715e">#define f_isLua(ci)(!ci_func(ci)-&gt;c.isC)</span>
<span style="color: #75715e">#define isLua(ci)(ttisfunction((ci)-&gt;func)&amp;&amp;f_isLua(ci))</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">global_State{</span>
<span style="color: #f8f8f2">stringtable</span> <span style="color: #f8f8f2">strt;</span>
<span style="color: #f8f8f2">lua_Alloc</span> <span style="color: #f8f8f2">frealloc;</span>
<span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">currentwhite;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">gcstate;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sweepstrgc;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rootgc;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">sweepgc;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">gray;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">grayagain;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">weak;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tmudata;</span>
<span style="color: #f8f8f2">Mbuffer</span> <span style="color: #f8f8f2">buff;</span>
<span style="color: #f8f8f2">lu_mem</span> <span style="color: #f8f8f2">GCthreshold;</span>
<span style="color: #f8f8f2">lu_mem</span> <span style="color: #f8f8f2">totalbytes;</span>
<span style="color: #f8f8f2">lu_mem</span> <span style="color: #f8f8f2">estimate;</span>
<span style="color: #f8f8f2">lu_mem</span> <span style="color: #f8f8f2">gcdept;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">gcpause;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">gcstepmul;</span>
<span style="color: #f8f8f2">lua_CFunction</span> <span style="color: #f8f8f2">panic;</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">l_registry;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mainthread;</span>
<span style="color: #f8f8f2">UpVal</span> <span style="color: #f8f8f2">uvhead;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mt[(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)];</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tmname[TM_N];</span>
<span style="color: #f8f8f2">}global_State;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_State{</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next;lu_byte</span> <span style="color: #f8f8f2">tt;lu_byte</span> <span style="color: #f8f8f2">marked;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">top;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">base;</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l_G;</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci;</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">savedpc;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">stack_last;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">stack;</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">end_ci;</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">base_ci;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">stacksize;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">size_ci;</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">short</span> <span style="color: #f8f8f2">nCcalls;</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">short</span> <span style="color: #f8f8f2">baseCcalls;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">hookmask;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">allowhook;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">basehookcount;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">hookcount;</span>
<span style="color: #f8f8f2">lua_Hook</span> <span style="color: #f8f8f2">hook;</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">l_gt;</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">env;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">openupval;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">gclist;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_longjmp</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">errorJmp;</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">errfunc;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #75715e">#define G(L)(L-&gt;l_G)</span>
<span style="color: #66d9ef">union</span> <span style="color: #f8f8f2">GCObject{</span>
<span style="color: #f8f8f2">GCheader</span> <span style="color: #f8f8f2">gch;</span>
<span style="color: #66d9ef">union</span> <span style="color: #f8f8f2">TString</span> <span style="color: #f8f8f2">ts;</span>
<span style="color: #66d9ef">union</span> <span style="color: #f8f8f2">Udata</span> <span style="color: #f8f8f2">u;</span>
<span style="color: #66d9ef">union</span> <span style="color: #f8f8f2">Closure</span> <span style="color: #f8f8f2">cl;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Table</span> <span style="color: #f8f8f2">h;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Proto</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">UpVal</span> <span style="color: #f8f8f2">uv;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_State</span> <span style="color: #f8f8f2">th;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #75715e">#define rawgco2ts(o)check_exp((o)-&gt;gch.tt==4,&amp;((o)-&gt;ts))</span>
<span style="color: #75715e">#define gco2ts(o)(&amp;rawgco2ts(o)-&gt;tsv)</span>
<span style="color: #75715e">#define rawgco2u(o)check_exp((o)-&gt;gch.tt==7,&amp;((o)-&gt;u))</span>
<span style="color: #75715e">#define gco2u(o)(&amp;rawgco2u(o)-&gt;uv)</span>
<span style="color: #75715e">#define gco2cl(o)check_exp((o)-&gt;gch.tt==6,&amp;((o)-&gt;cl))</span>
<span style="color: #75715e">#define gco2h(o)check_exp((o)-&gt;gch.tt==5,&amp;((o)-&gt;h))</span>
<span style="color: #75715e">#define gco2p(o)check_exp((o)-&gt;gch.tt==(8+1),&amp;((o)-&gt;p))</span>
<span style="color: #75715e">#define gco2uv(o)check_exp((o)-&gt;gch.tt==(8+2),&amp;((o)-&gt;uv))</span>
<span style="color: #75715e">#define ngcotouv(o)check_exp((o)==NULL||(o)-&gt;gch.tt==(8+2),&amp;((o)-&gt;uv))</span>
<span style="color: #75715e">#define gco2th(o)check_exp((o)-&gt;gch.tt==8,&amp;((o)-&gt;th))</span>
<span style="color: #75715e">#define obj2gco(v)(cast(GCObject*,(v)))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaE_freethread</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L1);</span>
<span style="color: #75715e">#define pcRel(pc,p)(cast(int,(pc)-(p)-&gt;code)-1)</span>
<span style="color: #75715e">#define getline_(f,pc)(((f)-&gt;lineinfo)?(f)-&gt;lineinfo[pc]:0)</span>
<span style="color: #75715e">#define resethookcount(L)(L-&gt;hookcount=L-&gt;basehookcount)</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaG_typeerror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">opname);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaG_runerror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fmt,...);</span>
<span style="color: #75715e">#define luaD_checkstack(L,n)if((char*)L-&gt;stack_last-(char*)L-&gt;top&lt;=(n)*(int)sizeof(TValue))luaD_growstack(L,n);else condhardstacktests(luaD_reallocstack(L,L-&gt;stacksize-5-1));</span>
<span style="color: #75715e">#define incr_top(L){luaD_checkstack(L,1);L-&gt;top++;}</span>
<span style="color: #75715e">#define savestack(L,p)((char*)(p)-(char*)L-&gt;stack)</span>
<span style="color: #75715e">#define restorestack(L,n)((TValue*)((char*)L-&gt;stack+(n)))</span>
<span style="color: #75715e">#define saveci(L,p)((char*)(p)-(char*)L-&gt;base_ci)</span>
<span style="color: #75715e">#define restoreci(L,n)((CallInfo*)((char*)L-&gt;base_ci+(n)))</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #a6e22e">void</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">Pfunc)(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaD_poscall</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">firstResult);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaD_reallocCI</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">newsize);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaD_reallocstack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">newsize);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaD_growstack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaD_throw</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">errcode);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaM_growaux_</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">block,</span><span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">size,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">size_elems,</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">limit,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">errormsg){</span>
<span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">newblock;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">newsize;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">limit</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">limit)</span>
<span style="color: #f8f8f2">luaG_runerror(L,errormsg);</span>
<span style="color: #f8f8f2">newsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">limit;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">newsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">size)</span><span style="color: #f92672">*</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(newsize</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">newsize</span><span style="color: #f92672">=</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">newblock</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaM_reallocv(L,block,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">size,newsize,size_elems);</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">newsize;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">newblock;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaM_toobig</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;memory allocation error: block too big&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaM_realloc_</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">block,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">osize,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">nsize){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #f8f8f2">block</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">frealloc)(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ud,block,osize,nsize);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(block</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">nsize</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaD_throw(L,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">osize)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">nsize;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">block;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define resetbits(x,m)((x)&amp;=cast(lu_byte,~(m)))</span>
<span style="color: #75715e">#define setbits(x,m)((x)|=(m))</span>
<span style="color: #75715e">#define testbits(x,m)((x)&amp;(m))</span>
<span style="color: #75715e">#define bitmask(b)(1&lt;&lt;(b))</span>
<span style="color: #75715e">#define bit2mask(b1,b2)(bitmask(b1)|bitmask(b2))</span>
<span style="color: #75715e">#define l_setbit(x,b)setbits(x,bitmask(b))</span>
<span style="color: #75715e">#define resetbit(x,b)resetbits(x,bitmask(b))</span>
<span style="color: #75715e">#define testbit(x,b)testbits(x,bitmask(b))</span>
<span style="color: #75715e">#define set2bits(x,b1,b2)setbits(x,(bit2mask(b1,b2)))</span>
<span style="color: #75715e">#define reset2bits(x,b1,b2)resetbits(x,(bit2mask(b1,b2)))</span>
<span style="color: #75715e">#define test2bits(x,b1,b2)testbits(x,(bit2mask(b1,b2)))</span>
<span style="color: #75715e">#define iswhite(x)test2bits((x)-&gt;gch.marked,0,1)</span>
<span style="color: #75715e">#define isblack(x)testbit((x)-&gt;gch.marked,2)</span>
<span style="color: #75715e">#define isgray(x)(!isblack(x)&amp;&amp;!iswhite(x))</span>
<span style="color: #75715e">#define otherwhite(g)(g-&gt;currentwhite^bit2mask(0,1))</span>
<span style="color: #75715e">#define isdead(g,v)((v)-&gt;gch.marked&amp;otherwhite(g)&amp;bit2mask(0,1))</span>
<span style="color: #75715e">#define changewhite(x)((x)-&gt;gch.marked^=bit2mask(0,1))</span>
<span style="color: #75715e">#define gray2black(x)l_setbit((x)-&gt;gch.marked,2)</span>
<span style="color: #75715e">#define valiswhite(x)(iscollectable(x)&amp;&amp;iswhite(gcvalue(x)))</span>
<span style="color: #75715e">#define luaC_white(g)cast(lu_byte,(g)-&gt;currentwhite&amp;bit2mask(0,1))</span>
<span style="color: #75715e">#define luaC_checkGC(L){condhardstacktests(luaD_reallocstack(L,L-&gt;stacksize-5-1));if(G(L)-&gt;totalbytes&gt;=G(L)-&gt;GCthreshold)luaC_step(L);}</span>
<span style="color: #75715e">#define luaC_barrier(L,p,v){if(valiswhite(v)&amp;&amp;isblack(obj2gco(p)))luaC_barrierf(L,obj2gco(p),gcvalue(v));}</span>
<span style="color: #75715e">#define luaC_barriert(L,t,v){if(valiswhite(v)&amp;&amp;isblack(obj2gco(t)))luaC_barrierback(L,t);}</span>
<span style="color: #75715e">#define luaC_objbarrier(L,p,o){if(iswhite(obj2gco(o))&amp;&amp;isblack(obj2gco(p)))luaC_barrierf(L,obj2gco(p),obj2gco(o));}</span>
<span style="color: #75715e">#define luaC_objbarriert(L,t,o){if(iswhite(obj2gco(o))&amp;&amp;isblack(obj2gco(t)))luaC_barrierback(L,t);}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_step</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_link</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o,lu_byte</span> <span style="color: #f8f8f2">tt);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_linkupval</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">uv);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_barrierf</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o,GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_barrierback</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t);</span>
<span style="color: #75715e">#define sizestring(s)(sizeof(union TString)+((s)-&gt;len+1)*sizeof(char))</span>
<span style="color: #75715e">#define sizeudata(u)(sizeof(union Udata)+(u)-&gt;len)</span>
<span style="color: #75715e">#define luaS_new(L,s)(luaS_newlstr(L,s,strlen(s)))</span>
<span style="color: #75715e">#define luaS_newliteral(L,s)(luaS_newlstr(L,&quot;&quot;s,(sizeof(s)/sizeof(char))-1))</span>
<span style="color: #75715e">#define luaS_fix(s)l_setbit((s)-&gt;tsv.marked,5)</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaS_newlstr</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">str,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l);</span>
<span style="color: #75715e">#define tostring(L,o)((ttype(o)==4)||(luaV_tostring(L,o)))</span>
<span style="color: #75715e">#define tonumber(o,n)(ttype(o)==3||(((o)=luaV_tonumber(o,n))!=NULL))</span>
<span style="color: #75715e">#define equalobj(L,o1,o2)(ttype(o1)==ttype(o2)&amp;&amp;luaV_equalval(L,o1,o2))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaV_equalval</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t1,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t2);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaV_tonumber</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">obj,TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaV_tostring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">obj);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaV_execute</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nexeccalls);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaV_concat</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">total,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">last);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">luaO_nilobject_</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{{NULL},</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaO_int2fb</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">x){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(x</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">16</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">x</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(x</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(x</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">x;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">return</span><span style="color: #f8f8f2">((e</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">|</span><span style="color: #f8f8f2">(cast_int(x)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaO_fb2int</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">x){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(x</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">31</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">x;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">return</span><span style="color: #f8f8f2">((x</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaO_log2</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">x){</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">log_2[</span><span style="color: #ae81ff">256</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span>
<span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span>
<span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span>
<span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span>
<span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span>
<span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span>
<span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span>
<span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">8</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">l</span><span style="color: #f92672">=-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(x</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">256</span><span style="color: #f8f8f2">){l</span><span style="color: #f92672">+=</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">;x</span><span style="color: #f92672">&gt;&gt;=</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">;}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">l</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">log_2[x];</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaO_rawequalObj</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t1,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t2){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttype(t1)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">ttype(t2))</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(t1)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">0</span>:
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">3</span>:
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luai_numeq(nvalue(t1),nvalue(t2));</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">1</span>:
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">bvalue(t1)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">bvalue(t2);</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">2</span>:
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pvalue(t1)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">pvalue(t2);</span>
<span style="color: #f8f8f2">default:</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">gcvalue(t1)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">gcvalue(t2);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaO_str2d</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,lua_Number</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">result){</span>
<span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">endptr;</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">result</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_str2number(s,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">endptr);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(endptr</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">s)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">endptr</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;x&#39;</span><span style="color: #f92672">||*</span><span style="color: #f8f8f2">endptr</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;X&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">result</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_num(strtoul(s,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">endptr,</span><span style="color: #ae81ff">16</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">endptr</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(isspace(cast(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">char</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">endptr)))endptr</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">endptr</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">pushstr</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">str){</span>
<span style="color: #f8f8f2">setsvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,luaS_new(L,str));</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaO_pushvfstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fmt,</span><span style="color: #66d9ef">va_list</span> <span style="color: #f8f8f2">argp){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">pushstr(L,</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;;){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strchr(fmt,</span><span style="color: #e6db74">&#39;%&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">setsvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,luaS_newlstr(L,fmt,e</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">fmt));</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;s&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">va_arg(argp,</span><span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(s</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)s</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;(null)&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">pushstr(L,s);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;c&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(</span><span style="color: #66d9ef">char</span><span style="color: #f8f8f2">,va_arg(argp,</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">pushstr(L,buff);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;d&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setnvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,cast_num(va_arg(argp,</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">)));</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;f&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setnvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,cast_num(va_arg(argp,l_uacNumber)));</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;p&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">4</span><span style="color: #f92672">*</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">sprintf(buff,</span><span style="color: #e6db74">&quot;%p&quot;</span><span style="color: #f8f8f2">,va_arg(argp,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">pushstr(L,buff);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;%&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">pushstr(L,</span><span style="color: #e6db74">&quot;%&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;%&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">pushstr(L,buff);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">+=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">fmt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">pushstr(L,fmt);</span>
<span style="color: #f8f8f2">luaV_concat(L,n</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,cast_int(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">svalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaO_pushfstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fmt,...){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">msg;</span>
<span style="color: #66d9ef">va_list</span> <span style="color: #f8f8f2">argp;</span>
<span style="color: #f8f8f2">va_start(argp,fmt);</span>
<span style="color: #f8f8f2">msg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaO_pushvfstring(L,fmt,argp);</span>
<span style="color: #f8f8f2">va_end(argp);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">msg;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaO_chunkid</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">out,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">source,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">bufflen){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">source</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">strncpy(out,source</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,bufflen);</span>
<span style="color: #f8f8f2">out[bufflen</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">source</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;@&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">source</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">bufflen</span><span style="color: #f92672">-=</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot; &#39;...&#39; &quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strlen(source);</span>
<span style="color: #f8f8f2">strcpy(out,</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">bufflen){</span>
<span style="color: #f8f8f2">source</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">bufflen);</span>
<span style="color: #f8f8f2">strcat(out,</span><span style="color: #e6db74">&quot;...&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">strcat(out,source);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strcspn(source,</span><span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\n\r</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">bufflen</span><span style="color: #f92672">-=</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot; [string </span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">...</span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">] &quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(len</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">bufflen)len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">bufflen;</span>
<span style="color: #f8f8f2">strcpy(out,</span><span style="color: #e6db74">&quot;[string </span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(source[len]</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">strncat(out,source,len);</span>
<span style="color: #f8f8f2">strcat(out,</span><span style="color: #e6db74">&quot;...&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">strcat(out,source);</span>
<span style="color: #f8f8f2">strcat(out,</span><span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">]&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define gnode(t,i)(&amp;(t)-&gt;node[i])</span>
<span style="color: #75715e">#define gkey(n)(&amp;(n)-&gt;i_key.nk)</span>
<span style="color: #75715e">#define gval(n)(&amp;(n)-&gt;i_val)</span>
<span style="color: #75715e">#define gnext(n)((n)-&gt;i_key.nk.next)</span>
<span style="color: #75715e">#define key2tval(n)(&amp;(n)-&gt;i_key.tvk)</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaH_setnum</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">key);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaH_getstr</span><span style="color: #f8f8f2">(Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key);</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaH_set</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaT_typenames[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #e6db74">&quot;nil&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;boolean&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;userdata&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;number&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;string&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;table&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;function&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;userdata&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;thread&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;proto&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;upval&quot;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaT_init</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaT_eventname[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #e6db74">&quot;__index&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__newindex&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;__gc&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__mode&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__eq&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;__add&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__sub&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__mul&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__div&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__mod&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;__pow&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__unm&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__len&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__lt&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__le&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;__concat&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__call&quot;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">TM_N;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmname[i]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaS_new(L,luaT_eventname[i]);</span>
<span style="color: #f8f8f2">luaS_fix(G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmname[i]);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaT_gettm</span><span style="color: #f8f8f2">(Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">events,TMS</span> <span style="color: #f8f8f2">event,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ename){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_getstr(events,ename);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(tm)){</span>
<span style="color: #f8f8f2">events</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">flags</span><span style="color: #f92672">|=</span><span style="color: #f8f8f2">cast_byte(</span><span style="color: #ae81ff">1u</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">event);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">tm;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaT_gettmbyobj</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o,TMS</span> <span style="color: #f8f8f2">event){</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mt;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(o)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:
<span style="color: #f8f8f2">mt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">7</span>:
<span style="color: #f8f8f2">mt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">uvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:</span>
<span style="color: #f8f8f2">mt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mt[ttype(o)];</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(mt</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">luaH_getstr(mt,G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmname[event])</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define sizeCclosure(n)(cast(int,sizeof(CClosure))+cast(int,sizeof(TValue)*((n)-1)))</span>
<span style="color: #75715e">#define sizeLclosure(n)(cast(int,sizeof(LClosure))+cast(int,sizeof(TValue*)*((n)-1)))</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaF_newCclosure</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nelems,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,luaM_malloc(L,sizeCclosure(nelems)));</span>
<span style="color: #f8f8f2">luaC_link(L,obj2gco(c),</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.isC</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.env</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e;</span>
<span style="color: #f8f8f2">c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.nupvalues</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(nelems);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">c;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaF_newLclosure</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nelems,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,luaM_malloc(L,sizeLclosure(nelems)));</span>
<span style="color: #f8f8f2">luaC_link(L,obj2gco(c),</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.isC</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.env</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e;</span>
<span style="color: #f8f8f2">c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.nupvalues</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(nelems);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(nelems</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.upvals[nelems]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">c;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaF_newupval</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaM_new(L,UpVal);</span>
<span style="color: #f8f8f2">luaC_link(L,obj2gco(uv),(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.value;</span>
<span style="color: #f8f8f2">setnilvalue(uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">uv;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaF_findupval</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">level){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">pp</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">openupval;</span>
<span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">uv;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pp</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ngcotouv(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pp))</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">level){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">level){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isdead(g,obj2gco(p)))</span>
<span style="color: #f8f8f2">changewhite(obj2gco(p));</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">pp</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">next;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaM_new(L,UpVal);</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">marked</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaC_white(g);</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">level;</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">next</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">pp;</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">pp</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">obj2gco(uv);</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.prev</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uvhead;</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uvhead.u.l.next;</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.next</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.prev</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">uv;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uvhead.u.l.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">uv;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">uv;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">unlinkupval</span><span style="color: #f8f8f2">(UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">uv){</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.next</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.prev</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.prev;</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.prev</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.next;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaF_freeupval</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">uv){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">!=&amp;</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.value)</span>
<span style="color: #f8f8f2">unlinkupval(uv);</span>
<span style="color: #f8f8f2">luaM_free(L,uv);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaF_close</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">level){</span>
<span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">uv;</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">openupval</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">(uv</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ngcotouv(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">openupval))</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">level){</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">obj2gco(uv);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">openupval</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">next;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isdead(g,o))</span>
<span style="color: #f8f8f2">luaF_freeupval(L,uv);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">unlinkupval(uv);</span>
<span style="color: #f8f8f2">setobj(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.value,uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.value;</span>
<span style="color: #f8f8f2">luaC_linkupval(L,uv);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaF_newproto</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaM_new(L,Proto);</span>
<span style="color: #f8f8f2">luaC_link(L,obj2gco(f),(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizek</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizep</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizecode</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelineinfo</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizeupvalues</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">numparams</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">is_vararg</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">maxstacksize</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lineinfo</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelocvars</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">locvars</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linedefined</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastlinedefined</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaF_freeproto</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f){</span>
<span style="color: #f8f8f2">luaM_freearray(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizecode,Instruction);</span>
<span style="color: #f8f8f2">luaM_freearray(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizep,Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaM_freearray(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizek,TValue);</span>
<span style="color: #f8f8f2">luaM_freearray(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lineinfo,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelineinfo,</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaM_freearray(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">locvars,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelocvars,</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LocVar);</span>
<span style="color: #f8f8f2">luaM_freearray(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizeupvalues,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaM_free(L,f);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaF_freeclosure</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">c){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.isC)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">sizeCclosure(c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.nupvalues)</span><span style="color: #f92672">:</span>
<span style="color: #f8f8f2">sizeLclosure(c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.nupvalues);</span>
<span style="color: #f8f8f2">luaM_freemem(L,c,size);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define MASK1(n,p)((~((~(Instruction)0)&lt;&lt;n))&lt;&lt;p)</span>
<span style="color: #75715e">#define MASK0(n,p)(~MASK1(n,p))</span>
<span style="color: #75715e">#define GET_OPCODE(i)(cast(OpCode,((i)&gt;&gt;0)&amp;MASK1(6,0)))</span>
<span style="color: #75715e">#define SET_OPCODE(i,o)((i)=(((i)&amp;MASK0(6,0))|((cast(Instruction,o)&lt;&lt;0)&amp;MASK1(6,0))))</span>
<span style="color: #75715e">#define GETARG_A(i)(cast(int,((i)&gt;&gt;(0+6))&amp;MASK1(8,0)))</span>
<span style="color: #75715e">#define SETARG_A(i,u)((i)=(((i)&amp;MASK0(8,(0+6)))|((cast(Instruction,u)&lt;&lt;(0+6))&amp;MASK1(8,(0+6)))))</span>
<span style="color: #75715e">#define GETARG_B(i)(cast(int,((i)&gt;&gt;(((0+6)+8)+9))&amp;MASK1(9,0)))</span>
<span style="color: #75715e">#define SETARG_B(i,b)((i)=(((i)&amp;MASK0(9,(((0+6)+8)+9)))|((cast(Instruction,b)&lt;&lt;(((0+6)+8)+9))&amp;MASK1(9,(((0+6)+8)+9)))))</span>
<span style="color: #75715e">#define GETARG_C(i)(cast(int,((i)&gt;&gt;((0+6)+8))&amp;MASK1(9,0)))</span>
<span style="color: #75715e">#define SETARG_C(i,b)((i)=(((i)&amp;MASK0(9,((0+6)+8)))|((cast(Instruction,b)&lt;&lt;((0+6)+8))&amp;MASK1(9,((0+6)+8)))))</span>
<span style="color: #75715e">#define GETARG_Bx(i)(cast(int,((i)&gt;&gt;((0+6)+8))&amp;MASK1((9+9),0)))</span>
<span style="color: #75715e">#define SETARG_Bx(i,b)((i)=(((i)&amp;MASK0((9+9),((0+6)+8)))|((cast(Instruction,b)&lt;&lt;((0+6)+8))&amp;MASK1((9+9),((0+6)+8)))))</span>
<span style="color: #75715e">#define GETARG_sBx(i)(GETARG_Bx(i)-(((1&lt;&lt;(9+9))-1)&gt;&gt;1))</span>
<span style="color: #75715e">#define SETARG_sBx(i,b)SETARG_Bx((i),cast(unsigned int,(b)+(((1&lt;&lt;(9+9))-1)&gt;&gt;1)))</span>
<span style="color: #75715e">#define CREATE_ABC(o,a,b,c)((cast(Instruction,o)&lt;&lt;0)|(cast(Instruction,a)&lt;&lt;(0+6))|(cast(Instruction,b)&lt;&lt;(((0+6)+8)+9))|(cast(Instruction,c)&lt;&lt;((0+6)+8)))</span>
<span style="color: #75715e">#define CREATE_ABx(o,a,bc)((cast(Instruction,o)&lt;&lt;0)|(cast(Instruction,a)&lt;&lt;(0+6))|(cast(Instruction,bc)&lt;&lt;((0+6)+8)))</span>
<span style="color: #75715e">#define ISK(x)((x)&amp;(1&lt;&lt;(9-1)))</span>
<span style="color: #75715e">#define INDEXK(r)((int)(r)&amp;~(1&lt;&lt;(9-1)))</span>
<span style="color: #75715e">#define RKASK(x)((x)|(1&lt;&lt;(9-1)))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">luaP_opmodes[(cast(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">,OP_VARARG)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)];</span>
<span style="color: #75715e">#define getBMode(m)(cast(enum OpArgMask,(luaP_opmodes[m]&gt;&gt;4)&amp;3))</span>
<span style="color: #75715e">#define getCMode(m)(cast(enum OpArgMask,(luaP_opmodes[m]&gt;&gt;2)&amp;3))</span>
<span style="color: #75715e">#define testTMode(m)(luaP_opmodes[m]&amp;(1&lt;&lt;7))</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">expdesc{</span>
<span style="color: #f8f8f2">expkind</span> <span style="color: #f8f8f2">k;</span>
<span style="color: #66d9ef">union</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">struct</span><span style="color: #f8f8f2">{</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">info,aux;}s;</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">nval;</span>
<span style="color: #f8f8f2">}u;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">t;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">}expdesc;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">upvaldesc{</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">k;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">info;</span>
<span style="color: #f8f8f2">}upvaldesc;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">BlockCnt;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">FuncState{</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">h;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">prev;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">BlockCnt</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">bl;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pc;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">lasttarget;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">jpc;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">freereg;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nk;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">np;</span>
<span style="color: #66d9ef">short</span> <span style="color: #f8f8f2">nlocvars;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">nactvar;</span>
<span style="color: #f8f8f2">upvaldesc</span> <span style="color: #f8f8f2">upvalues[</span><span style="color: #ae81ff">60</span><span style="color: #f8f8f2">];</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">short</span> <span style="color: #f8f8f2">actvar[</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">}FuncState;</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaY_parser</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,ZIO</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">z,Mbuffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">buff,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name);</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_longjmp{</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_longjmp</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">previous;</span>
<span style="color: #66d9ef">jmp_buf</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #66d9ef">volatile</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaD_seterrorobj</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">errcode,StkId</span> <span style="color: #f8f8f2">oldtop){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(errcode){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">4</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setsvalue(L,oldtop,luaS_newliteral(L,</span><span style="color: #e6db74">&quot;not enough memory&quot;</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setsvalue(L,oldtop,luaS_newliteral(L,</span><span style="color: #e6db74">&quot;error in error handling&quot;</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">3</span>:
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">2</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setobj(L,oldtop,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">oldtop</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">restore_stack_limit</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">20000</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">inuse</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_int(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(inuse</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">20000</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaD_reallocCI(L,</span><span style="color: #ae81ff">20000</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">resetstack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status){</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base;</span>
<span style="color: #f8f8f2">luaF_close(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base);</span>
<span style="color: #f8f8f2">luaD_seterrorobj(L,status,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">baseCcalls;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">allowhook</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">restore_stack_limit(L);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errfunc</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errorJmp</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaD_throw</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">errcode){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errorJmp){</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errorJmp</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">errcode;</span>
<span style="color: #f8f8f2">LUAI_THROW(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errorJmp);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(errcode);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">panic){</span>
<span style="color: #f8f8f2">resetstack(L,errcode);</span>
<span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">panic(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">exit(EXIT_FAILURE);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaD_rawrunprotected</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Pfunc</span> <span style="color: #f8f8f2">f,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud){</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_longjmp</span> <span style="color: #f8f8f2">lj;</span>
<span style="color: #f8f8f2">lj.status</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lj.previous</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errorJmp;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errorJmp</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">lj;</span>
<span style="color: #f8f8f2">LUAI_TRY(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lj,</span>
<span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f)(L,ud);</span>
<span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errorJmp</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lj.previous;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">lj.status;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">correctstack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">oldstack){</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">up;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">oldstack)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(up</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">openupval;up</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL;up</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">up</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next)</span>
<span style="color: #f8f8f2">gco2uv(up)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(gco2uv(up)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">oldstack)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci;ci</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci;ci</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">oldstack)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack;</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">oldstack)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack;</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">oldstack)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">oldstack)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaD_reallocstack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">newsize){</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">oldstack</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">realsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">newsize</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f92672">+</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaM_reallocvector(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize,realsize,TValue);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">realsize;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack_last</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">newsize;</span>
<span style="color: #f8f8f2">correctstack(L,oldstack);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaD_reallocCI</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">newsize){</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">oldci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci;</span>
<span style="color: #f8f8f2">luaM_reallocvector(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci,newsize,CallInfo);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">newsize;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">oldci)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">end_ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaD_growstack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize)</span>
<span style="color: #f8f8f2">luaD_reallocstack(L,</span><span style="color: #ae81ff">2</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">luaD_reallocstack(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #a6e22e">growCI</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">20000</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaD_throw(L,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaD_reallocCI(L,</span><span style="color: #ae81ff">2</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">20000</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;stack overflow&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">StkId</span> <span style="color: #a6e22e">adjust_varargs</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">actual){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nfixargs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">numparams;</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">htab</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">base,fixed;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;actual</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">nfixargs;</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">actual)</span>
<span style="color: #f8f8f2">setnilvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">fixed</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">actual;</span>
<span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">nfixargs;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">,fixed</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">i);</span>
<span style="color: #f8f8f2">setnilvalue(fixed</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">i);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(htab){</span>
<span style="color: #f8f8f2">sethvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">,htab);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">base;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">StkId</span> <span style="color: #a6e22e">tryfuncTM</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">func){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaT_gettmbyobj(L,func,TM_CALL);</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">funcr</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">savestack(L,func);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisfunction(tm))</span>
<span style="color: #f8f8f2">luaG_typeerror(L,func,</span><span style="color: #e6db74">&quot;call&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;p</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">func;p</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)setobj(L,p,p</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">restorestack(L,funcr);</span>
<span style="color: #f8f8f2">setobj(L,func,tm);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">func;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define inc_ci(L)((L-&gt;ci==L-&gt;end_ci)?growCI(L):(condhardstacktests(luaD_reallocCI(L,L-&gt;size_ci)),++L-&gt;ci))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaD_precall</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">func,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nresults){</span>
<span style="color: #f8f8f2">LClosure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cl;</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">funcr;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisfunction(func))</span>
<span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tryfuncTM(L,func);</span>
<span style="color: #f8f8f2">funcr</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">savestack(L,func);</span>
<span style="color: #f8f8f2">cl</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">clvalue(func)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">isC){</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">st,base;</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">luaD_checkstack(L,p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">maxstacksize);</span>
<span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">restorestack(L,funcr);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">is_vararg){</span>
<span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">numparams)</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">numparams;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nargs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_int(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">func)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">adjust_varargs(L,p,nargs);</span>
<span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">restorestack(L,funcr);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">inc_ci(L);</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">func;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">base;</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">maxstacksize;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code;</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tailcalls</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nresults</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nresults;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(st</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;st</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;st</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">setnilvalue(st);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">luaD_checkstack(L,</span><span style="color: #ae81ff">20</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">inc_ci(L);</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">restorestack(L,funcr);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #ae81ff">20</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nresults</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nresults;</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">curr_func(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.f)(L);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaD_poscall(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">n);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaD_poscall</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">firstResult){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">wanted,i;</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci;</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func;</span>
<span style="color: #f8f8f2">wanted</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nresults;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(ci</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(ci</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">wanted;i</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">firstResult</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">setobj(L,res</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">,firstResult</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">--&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">setnilvalue(res</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(wanted</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaD_call</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">func,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nResults){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls</span><span style="color: #f92672">==</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;C stack overflow&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">200</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">200</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)))</span>
<span style="color: #f8f8f2">luaD_throw(L,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaD_precall(L,func,nResults)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaV_execute(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaD_pcall</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Pfunc</span> <span style="color: #f8f8f2">func,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">u,</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">old_top,</span><span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">ef){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">short</span> <span style="color: #f8f8f2">oldnCcalls</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls;</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">old_ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">saveci(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci);</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">old_allowhooks</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">allowhook;</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">old_errfunc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errfunc;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errfunc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ef;</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaD_rawrunprotected(L,func,u);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(status</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">oldtop</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">restorestack(L,old_top);</span>
<span style="color: #f8f8f2">luaF_close(L,oldtop);</span>
<span style="color: #f8f8f2">luaD_seterrorobj(L,status,oldtop);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">oldnCcalls;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">restoreci(L,old_ci);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">allowhook</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">old_allowhooks;</span>
<span style="color: #f8f8f2">restore_stack_limit(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errfunc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">old_errfunc;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">SParser{</span>
<span style="color: #f8f8f2">ZIO</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">z;</span>
<span style="color: #f8f8f2">Mbuffer</span> <span style="color: #f8f8f2">buff;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">f_parser</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tf;</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cl;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">SParser</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">SParser</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,ud);</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">tf</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaY_parser(L,p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">z,</span>
<span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff,p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">name);</span>
<span style="color: #f8f8f2">cl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaF_newLclosure(L,tf</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups,hvalue(gt(L)));</span>
<span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tf;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">tf</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.upvals[i]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaF_newupval(L);</span>
<span style="color: #f8f8f2">setclvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,cl);</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaD_protectedparser</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,ZIO</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">z,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name){</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">SParser</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">p.z</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">z;p.name</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">name;</span>
<span style="color: #f8f8f2">luaZ_initbuffer(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">p.buff);</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaD_pcall(L,f_parser,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">p,savestack(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top),L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errfunc);</span>
<span style="color: #f8f8f2">luaZ_freebuffer(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">p.buff);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaS_resize</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">newsize){</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">newhash;</span>
<span style="color: #f8f8f2">stringtable</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tb;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">==</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">newhash</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaM_newvector(L,newsize,GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">tb</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">newsize;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)newhash[i]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">hash[i];</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(p){</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next;</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">h</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gco2ts(p)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">hash;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">h1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lmod(h,newsize);</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">newhash[h1];</span>
<span style="color: #f8f8f2">newhash[h1]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">next;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaM_freearray(L,tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">hash,tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">newsize;</span>
<span style="color: #f8f8f2">tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">hash</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">newhash;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #a6e22e">newlstr</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">str,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l,</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">h){</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ts;</span>
<span style="color: #f8f8f2">stringtable</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tb;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(((</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)(</span><span style="color: #f92672">~</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(TString))</span><span style="color: #f92672">/</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">char</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaM_toobig(L);</span>
<span style="color: #f8f8f2">ts</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,luaM_malloc(L,(l</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">*</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">char</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(TString)));</span>
<span style="color: #f8f8f2">ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.hash</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">h;</span>
<span style="color: #f8f8f2">ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.marked</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaC_white(G(L));</span>
<span style="color: #f8f8f2">ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.tt</span><span style="color: #f92672">=</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.reserved</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">memcpy(ts</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,str,l</span><span style="color: #f92672">*</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">char</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">((</span><span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)(ts</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))[l]</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">tb</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt;</span>
<span style="color: #f8f8f2">h</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lmod(h,tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size);</span>
<span style="color: #f8f8f2">ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">hash[h];</span>
<span style="color: #f8f8f2">tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">hash[h]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">obj2gco(ts);</span>
<span style="color: #f8f8f2">tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nuse</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nuse</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">cast(lu_int32,tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">(INT_MAX</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaS_resize(L,tb</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">*</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">ts;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaS_newlstr</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">str,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l){</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o;</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">h</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span><span style="color: #f8f8f2">,l);</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">step</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l1;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(l1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l;l1</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">step;l1</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">step)</span>
<span style="color: #f8f8f2">h</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">^</span><span style="color: #f8f8f2">((h</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">(h</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">cast(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">char</span><span style="color: #f8f8f2">,str[l1</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]));</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.hash[lmod(h,G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.size)];</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next){</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ts</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">rawgco2ts(o);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.len</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">(memcmp(str,getstr(ts),l)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isdead(G(L),o))changewhite(o);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">ts;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">newlstr(L,str,l,h);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Udata</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaS_newudata</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">s,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">Udata</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">u;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(s</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">((</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)(</span><span style="color: #f92672">~</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(Udata))</span>
<span style="color: #f8f8f2">luaM_toobig(L);</span>
<span style="color: #f8f8f2">u</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(Udata</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,luaM_malloc(L,s</span><span style="color: #f92672">+</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(Udata)));</span>
<span style="color: #f8f8f2">u</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uv.marked</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaC_white(G(L));</span>
<span style="color: #f8f8f2">u</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uv.tt</span><span style="color: #f92672">=</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">u</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uv.len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">s;</span>
<span style="color: #f8f8f2">u</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uv.metatable</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">u</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uv.env</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e;</span>
<span style="color: #f8f8f2">u</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uv.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mainthread</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">next;</span>
<span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mainthread</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">obj2gco(u);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">u;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define hashpow2(t,n)(gnode(t,lmod((n),sizenode(t))))</span>
<span style="color: #75715e">#define hashstr(t,str)hashpow2(t,(str)-&gt;tsv.hash)</span>
<span style="color: #75715e">#define hashboolean(t,p)hashpow2(t,p)</span>
<span style="color: #75715e">#define hashmod(t,n)(gnode(t,((n)%((sizenode(t)-1)|1))))</span>
<span style="color: #75715e">#define hashpointer(t,p)hashmod(t,IntPoint(p))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">Node</span> <span style="color: #f8f8f2">dummynode_</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">{{NULL},</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">},</span>
<span style="color: #f8f8f2">{{{NULL},</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,NULL}}</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #a6e22e">hashnum</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,lua_Number</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">a[cast_int(</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(lua_Number)</span><span style="color: #f92672">/</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">))];</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luai_numeq(n,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">gnode(t,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">memcpy(a,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">n,</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(a));</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">cast_int(</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(lua_Number)</span><span style="color: #f92672">/</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">));i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)a[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">a[i];</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">hashmod(t,a[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #a6e22e">mainposition</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(key)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">3</span>:
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">hashnum(t,nvalue(key));</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">4</span>:
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">hashstr(t,rawtsvalue(key));</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">1</span>:
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">hashboolean(t,bvalue(key));</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">2</span>:
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">hashpointer(t,pvalue(key));</span>
<span style="color: #f8f8f2">default:</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">hashpointer(t,gcvalue(key));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">arrayindex</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnumber(key)){</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nvalue(key);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">k;</span>
<span style="color: #f8f8f2">lua_number2int(k,n);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luai_numeq(cast_num(k),n))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">k;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">findindex</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,StkId</span> <span style="color: #f8f8f2">key){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(key))</span><span style="color: #66d9ef">return</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">arrayindex(key);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">mainposition(t,key);</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaO_rawequalObj(key2tval(n),key)</span><span style="color: #f92672">||</span>
<span style="color: #f8f8f2">(ttype(gkey(n))</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">iscollectable(key)</span><span style="color: #f92672">&amp;&amp;</span>
<span style="color: #f8f8f2">gcvalue(gkey(n))</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">gcvalue(key))){</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_int(n</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">gnode(t,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gnext(n);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(n);</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;invalid key to &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;next&quot;</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaH_next</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,StkId</span> <span style="color: #f8f8f2">key){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">findindex(L,t,key);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[i])){</span>
<span style="color: #f8f8f2">setnvalue(key,cast_num(i</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">setobj(L,key</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[i]);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">)sizenode(t);i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(gval(gnode(t,i)))){</span>
<span style="color: #f8f8f2">setobj(L,key,key2tval(gnode(t,i)));</span>
<span style="color: #f8f8f2">setobj(L,key</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,gval(gnode(t,i)));</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">computesizes</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nums[],</span><span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">narray){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">twotoi;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">a</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">na</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,twotoi</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;twotoi</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f92672">&lt;*</span><span style="color: #f8f8f2">narray;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">,twotoi</span><span style="color: #f92672">*=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nums[i]</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">a</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">nums[i];</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(a</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">twotoi</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">twotoi;</span>
<span style="color: #f8f8f2">na</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">a;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(a</span><span style="color: #f92672">==*</span><span style="color: #f8f8f2">narray)</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">narray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">na;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">countint</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key,</span><span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">nums){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">arrayindex(key);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">32</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))){</span>
<span style="color: #f8f8f2">nums[ceillog2(k)]</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">numusearray</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">nums){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">lg;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">ttlg;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">ause</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(lg</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,ttlg</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;lg</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">32</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);lg</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">,ttlg</span><span style="color: #f92672">*=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">lc</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">lim</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ttlg;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lim</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray){</span>
<span style="color: #f8f8f2">lim</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">lim)</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;i</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">lim;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[i</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]))</span>
<span style="color: #f8f8f2">lc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">nums[lg]</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">lc;</span>
<span style="color: #f8f8f2">ause</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">lc;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">ause;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">numusehash</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">nums,</span><span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pnasize){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">totaluse</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">ause</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">sizenode(t);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">node[i];</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(gval(n))){</span>
<span style="color: #f8f8f2">ause</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">countint(key2tval(n),nums);</span>
<span style="color: #f8f8f2">totaluse</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">pnasize</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">ause;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">totaluse;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">setarrayvector</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">size){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">luaM_reallocvector(L,t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array,t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray,size,TValue);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">size;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">setnilvalue(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[i]);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">size;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">setnodevector</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">size){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">lsize;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(size</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">node</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">dummynode_));</span>
<span style="color: #f8f8f2">lsize</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">lsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ceillog2(size);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lsize</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">32</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;table overflow&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">twoto(lsize);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">node</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaM_newvector(L,size,Node);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">size;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gnode(t,i);</span>
<span style="color: #f8f8f2">gnext(n)</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">setnilvalue(gkey(n));</span>
<span style="color: #f8f8f2">setnilvalue(gval(n));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lsizenode</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(lsize);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastfree</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gnode(t,size);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">resize</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nasize,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nhsize){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">oldasize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">oldhsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lsizenode;</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">nold</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">node;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nasize</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">oldasize)</span>
<span style="color: #f8f8f2">setarrayvector(L,t,nasize);</span>
<span style="color: #f8f8f2">setnodevector(L,t,nhsize);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nasize</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">oldasize){</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nasize;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nasize;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">oldasize;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[i]))</span>
<span style="color: #f8f8f2">setobj(L,luaH_setnum(L,t,i</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[i]);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaM_reallocvector(L,t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array,oldasize,nasize,TValue);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">twoto(oldhsize)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">old</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nold</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(gval(old)))</span>
<span style="color: #f8f8f2">setobj(L,luaH_set(L,t,key2tval(old)),gval(old));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nold</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">dummynode_))</span>
<span style="color: #f8f8f2">luaM_freearray(L,nold,twoto(oldhsize),Node);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaH_resizearray</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nasize){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">node</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">dummynode_))</span><span style="color: #f92672">?</span><span style="color: #ae81ff">0</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">sizenode(t);</span>
<span style="color: #f8f8f2">resize(L,t,nasize,nsize);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">rehash</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ek){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nasize,na;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nums[(</span><span style="color: #ae81ff">32</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">];</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">totaluse;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">32</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)nums[i]</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">nasize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">numusearray(t,nums);</span>
<span style="color: #f8f8f2">totaluse</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nasize;</span>
<span style="color: #f8f8f2">totaluse</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">numusehash(t,nums,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">nasize);</span>
<span style="color: #f8f8f2">nasize</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">countint(ek,nums);</span>
<span style="color: #f8f8f2">totaluse</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">na</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">computesizes(nums,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">nasize);</span>
<span style="color: #f8f8f2">resize(L,t,nasize,totaluse</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">na);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaH_new</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narray,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nhash){</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaM_new(L,Table);</span>
<span style="color: #f8f8f2">luaC_link(L,obj2gco(t),</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">flags</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(</span><span style="color: #f92672">~</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lsizenode</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">node</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">dummynode_));</span>
<span style="color: #f8f8f2">setarrayvector(L,t,narray);</span>
<span style="color: #f8f8f2">setnodevector(L,t,nhash);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">t;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaH_free</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">node</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">dummynode_))</span>
<span style="color: #f8f8f2">luaM_freearray(L,t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">node,sizenode(t),Node);</span>
<span style="color: #f8f8f2">luaM_freearray(L,t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array,t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray,TValue);</span>
<span style="color: #f8f8f2">luaM_free(L,t);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #a6e22e">getfreepos</span><span style="color: #f8f8f2">(Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t){</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastfree</span><span style="color: #f92672">--&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">node){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(gkey(t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastfree)))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastfree;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">newkey</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key){</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mp</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">mainposition(t,key);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(gval(mp))</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">mp</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">dummynode_)){</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">othern;</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getfreepos(t);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">rehash(L,t,key);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaH_set(L,t,key);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">othern</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">mainposition(t,key2tval(mp));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(othern</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">mp){</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(gnext(othern)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">mp)othern</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gnext(othern);</span>
<span style="color: #f8f8f2">gnext(othern)</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">n;</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">mp;</span>
<span style="color: #f8f8f2">gnext(mp)</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">setnilvalue(gval(mp));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">gnext(n)</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gnext(mp);</span>
<span style="color: #f8f8f2">gnext(mp)</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">mp</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">gkey(mp)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">value</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">key</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">value;gkey(mp)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">key</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tt;</span>
<span style="color: #f8f8f2">luaC_barriert(L,t,key);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">gval(mp);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaH_getnum</span><span style="color: #f8f8f2">(Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">key){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(cast(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span><span style="color: #f8f8f2">,key)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">cast(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span><span style="color: #f8f8f2">,t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray))</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[key</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">];</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">nk</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_num(key);</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hashnum(t,nk);</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnumber(gkey(n))</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">luai_numeq(nvalue(gkey(n)),nk))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">gval(n);</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gnext(n);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(n);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaH_getstr</span><span style="color: #f8f8f2">(Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key){</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hashstr(t,key);</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisstring(gkey(n))</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">rawtsvalue(gkey(n))</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">key)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">gval(n);</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gnext(n);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(n);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaH_get</span><span style="color: #f8f8f2">(Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(key)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">0</span>:<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_);</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">4</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaH_getstr(t,rawtsvalue(key));</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">3</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">k;</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nvalue(key);</span>
<span style="color: #f8f8f2">lua_number2int(k,n);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luai_numeq(cast_num(k),nvalue(key)))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaH_getnum(t,k);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">mainposition(t,key);</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaO_rawequalObj(key2tval(n),key))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">gval(n);</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gnext(n);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(n);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaH_set</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_get(t,key);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">flags</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">cast(TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,p);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(key))luaG_runerror(L,</span><span style="color: #e6db74">&quot;table index is nil&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnumber(key)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">luai_numisnan(nvalue(key)))</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;table index is NaN&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">newkey(L,t,key);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaH_setnum</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">key){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_getnum(t,key);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">cast(TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,p);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">k;</span>
<span style="color: #f8f8f2">setnvalue(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">k,cast_num(key));</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">newkey(L,t,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">k);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaH_setstr</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_getstr(t,key);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">cast(TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,p);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">k;</span>
<span style="color: #f8f8f2">setsvalue(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">k,key);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">newkey(L,t,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">k);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">unbound_search</span><span style="color: #f8f8f2">(Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">j){</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">j;</span>
<span style="color: #f8f8f2">j</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(luaH_getnum(t,j))){</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">j;</span>
<span style="color: #f8f8f2">j</span><span style="color: #f92672">*=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(j</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">cast(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span><span style="color: #f8f8f2">,(INT_MAX</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))){</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(luaH_getnum(t,i)))i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(j</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">m</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">j)</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(luaH_getnum(t,m)))j</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">m;</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">m;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaH_getn</span><span style="color: #f8f8f2">(Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t){</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">j</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(j</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">ttisnil(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[j</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">])){</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(j</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">m</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">j)</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[m</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]))j</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">m;</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">m;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">node</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">dummynode_))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">j;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">unbound_search(t,j);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define makewhite(g,x)((x)-&gt;gch.marked=cast_byte(((x)-&gt;gch.marked&amp;cast_byte(~(bitmask(2)|bit2mask(0,1))))|luaC_white(g)))</span>
<span style="color: #75715e">#define white2gray(x)reset2bits((x)-&gt;gch.marked,0,1)</span>
<span style="color: #75715e">#define black2gray(x)resetbit((x)-&gt;gch.marked,2)</span>
<span style="color: #75715e">#define stringmark(s)reset2bits((s)-&gt;tsv.marked,0,1)</span>
<span style="color: #75715e">#define isfinalized(u)testbit((u)-&gt;marked,3)</span>
<span style="color: #75715e">#define markfinalized(u)l_setbit((u)-&gt;marked,3)</span>
<span style="color: #75715e">#define markvalue(g,o){checkconsistency(o);if(iscollectable(o)&amp;&amp;iswhite(gcvalue(o)))reallymarkobject(g,gcvalue(o));}</span>
<span style="color: #75715e">#define markobject(g,t){if(iswhite(obj2gco(t)))reallymarkobject(g,obj2gco(t));}</span>
<span style="color: #75715e">#define setthreshold(g)(g-&gt;GCthreshold=(g-&gt;estimate/100)*g-&gt;gcpause)</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">removeentry</span><span style="color: #f8f8f2">(Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(iscollectable(gkey(n)))</span>
<span style="color: #f8f8f2">setttype(gkey(n),(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">reallymarkobject</span><span style="color: #f8f8f2">(global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g,GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o){</span>
<span style="color: #f8f8f2">white2gray(o);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(o</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.tt){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">4</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">7</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gco2u(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable;</span>
<span style="color: #f8f8f2">gray2black(o);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(mt)markobject(g,mt);</span>
<span style="color: #f8f8f2">markobject(g,gco2u(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">env);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gco2uv(o);</span>
<span style="color: #f8f8f2">markvalue(g,uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">==&amp;</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.value)</span>
<span style="color: #f8f8f2">gray2black(o);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">6</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">gco2cl(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.gclist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">gco2h(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gclist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">8</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">gco2th(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gclist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">gco2p(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gclist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">marktmu</span><span style="color: #f8f8f2">(global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g){</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">u</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(u){</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">u</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">u</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next;</span>
<span style="color: #f8f8f2">makewhite(g,u);</span>
<span style="color: #f8f8f2">reallymarkobject(g,u);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(u</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">size_t</span> <span style="color: #a6e22e">luaC_separateudata</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">all){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">deadmem</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mainthread</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">next;</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">curr;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">((curr</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">p)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">(iswhite(curr)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">all)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">isfinalized(gco2u(curr)))</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">curr</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fasttm(L,gco2u(curr)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable,TM_GC)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">markfinalized(gco2u(curr));</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">curr</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">deadmem</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">sizeudata(gco2u(curr));</span>
<span style="color: #f8f8f2">markfinalized(gco2u(curr));</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">curr</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">deadmem;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">traversetable</span><span style="color: #f8f8f2">(global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">h){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">weakkey</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">weakvalue</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mode;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable)</span>
<span style="color: #f8f8f2">markobject(g,h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable);</span>
<span style="color: #f8f8f2">mode</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gfasttm(g,h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable,TM_MODE);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(mode</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">ttisstring(mode)){</span>
<span style="color: #f8f8f2">weakkey</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(strchr(svalue(mode),</span><span style="color: #e6db74">&#39;k&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL);</span>
<span style="color: #f8f8f2">weakvalue</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(strchr(svalue(mode),</span><span style="color: #e6db74">&#39;v&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(weakkey</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">weakvalue){</span>
<span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">marked</span><span style="color: #f92672">&amp;=~</span><span style="color: #f8f8f2">(bitmask(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">|</span><span style="color: #f8f8f2">bitmask(</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">marked</span><span style="color: #f92672">|=</span><span style="color: #f8f8f2">cast_byte((weakkey</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">|</span>
<span style="color: #f8f8f2">(weakvalue</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gclist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">weak;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">weak</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">obj2gco(h);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(weakkey</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">weakvalue)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">weakvalue){</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">markvalue(g,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[i]);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">sizenode(h);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gnode(h,i);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(gval(n)))</span>
<span style="color: #f8f8f2">removeentry(n);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">weakkey)markvalue(g,gkey(n));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">weakvalue)markvalue(g,gval(n));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">weakkey</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">weakvalue;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">traverseproto</span><span style="color: #f8f8f2">(global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g,Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source)stringmark(f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizek;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">markvalue(g,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k[i]);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizeupvalues;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues[i])</span>
<span style="color: #f8f8f2">stringmark(f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues[i]);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizep;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p[i])</span>
<span style="color: #f8f8f2">markobject(g,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p[i]);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelocvars;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">locvars[i].varname)</span>
<span style="color: #f8f8f2">stringmark(f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">locvars[i].varname);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">traverseclosure</span><span style="color: #f8f8f2">(global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g,Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cl){</span>
<span style="color: #f8f8f2">markobject(g,cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.env);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.isC){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.nupvalues;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">markvalue(g,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.upvalue[i]);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">markobject(g,cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.nupvalues;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">markobject(g,cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.upvals[i]);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">checkstacksizes</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">max){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">ci_used</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_int(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">s_used</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_int(max</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">20000</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">4</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci_used</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #ae81ff">2</span><span style="color: #f92672">*</span><span style="color: #ae81ff">8</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci)</span>
<span style="color: #f8f8f2">luaD_reallocCI(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">condhardstacktests(luaD_reallocCI(L,ci_used</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">4</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s_used</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize</span><span style="color: #f92672">&amp;&amp;</span>
<span style="color: #ae81ff">2</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">((</span><span style="color: #ae81ff">2</span><span style="color: #f92672">*</span><span style="color: #ae81ff">20</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize)</span>
<span style="color: #f8f8f2">luaD_reallocstack(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">condhardstacktests(luaD_reallocstack(L,s_used));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">traversestack</span><span style="color: #f8f8f2">(global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g,lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o,lim;</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci;</span>
<span style="color: #f8f8f2">markvalue(g,gt(l));</span>
<span style="color: #f8f8f2">lim</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci;ci</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci;ci</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lim</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top)lim</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack;o</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;o</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">markvalue(g,o);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;o</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">lim;o</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">setnilvalue(o);</span>
<span style="color: #f8f8f2">checkstacksizes(l,lim);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">l_mem</span> <span style="color: #a6e22e">propagatemark</span><span style="color: #f8f8f2">(global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g){</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray;</span>
<span style="color: #f8f8f2">gray2black(o);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(o</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.tt){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gco2h(o);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gclist;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(traversetable(g,h))</span>
<span style="color: #f8f8f2">black2gray(o);</span>
<span style="color: #66d9ef">return</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(Table)</span><span style="color: #f92672">+</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(TValue)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray</span><span style="color: #f92672">+</span>
<span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(Node)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">sizenode(h);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">6</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gco2cl(o);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.gclist;</span>
<span style="color: #f8f8f2">traverseclosure(g,cl);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.isC)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">sizeCclosure(cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.nupvalues)</span><span style="color: #f92672">:</span>
<span style="color: #f8f8f2">sizeLclosure(cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.nupvalues);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">8</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">th</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gco2th(o);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">th</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gclist;</span>
<span style="color: #f8f8f2">th</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gclist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">grayagain;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">grayagain</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">black2gray(o);</span>
<span style="color: #f8f8f2">traversestack(g,th);</span>
<span style="color: #66d9ef">return</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(lua_State)</span><span style="color: #f92672">+</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(TValue)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">th</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize</span><span style="color: #f92672">+</span>
<span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(CallInfo)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">th</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gco2p(o);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gclist;</span>
<span style="color: #f8f8f2">traverseproto(g,p);</span>
<span style="color: #66d9ef">return</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(Proto)</span><span style="color: #f92672">+</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(Instruction)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizecode</span><span style="color: #f92672">+</span>
<span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizep</span><span style="color: #f92672">+</span>
<span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(TValue)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizek</span><span style="color: #f92672">+</span>
<span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelineinfo</span><span style="color: #f92672">+</span>
<span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(LocVar)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelocvars</span><span style="color: #f92672">+</span>
<span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizeupvalues;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">size_t</span> <span style="color: #a6e22e">propagateall</span><span style="color: #f8f8f2">(global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">m</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray)m</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">propagatemark(g);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">m;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">iscleared</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">iskey){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">iscollectable(o))</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisstring(o)){</span>
<span style="color: #f8f8f2">stringmark(rawtsvalue(o));</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">iswhite(gcvalue(o))</span><span style="color: #f92672">||</span>
<span style="color: #f8f8f2">(ttisuserdata(o)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">iskey</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">isfinalized(uvalue(o))));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">cleartable</span><span style="color: #f8f8f2">(GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l){</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(l){</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gco2h(l);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(testbit(h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">marked,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">array[i];</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(iscleared(o,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">setnilvalue(o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">sizenode(h);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">gnode(h,i);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(gval(n))</span><span style="color: #f92672">&amp;&amp;</span>
<span style="color: #f8f8f2">(iscleared(key2tval(n),</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">iscleared(gval(n),</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">))){</span>
<span style="color: #f8f8f2">setnilvalue(gval(n));</span>
<span style="color: #f8f8f2">removeentry(n);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gclist;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">freeobj</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(o</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.tt){</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>:<span style="color: #f8f8f2">luaF_freeproto(L,gco2p(o));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">6</span>:<span style="color: #f8f8f2">luaF_freeclosure(L,gco2cl(o));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span>:<span style="color: #f8f8f2">luaF_freeupval(L,gco2uv(o));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:<span style="color: #f8f8f2">luaH_free(L,gco2h(o));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">8</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaE_freethread(L,gco2th(o));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">4</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.nuse</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaM_freemem(L,o,sizestring(gco2ts(o)));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">7</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaM_freemem(L,o,sizeudata(gco2u(o)));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define sweepwholelist(L,p)sweeplist(L,p,((lu_mem)(~(lu_mem)0)-2))</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">**</span><span style="color: #a6e22e">sweeplist</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,GCObject</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">p,lu_mem</span> <span style="color: #f8f8f2">count){</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">curr;</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">deadmask</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">otherwhite(g);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">((curr</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">p)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">count</span><span style="color: #f92672">--&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(curr</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.tt</span><span style="color: #f92672">==</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">sweepwholelist(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">gco2th(curr)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">openupval);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((curr</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.marked</span><span style="color: #f92672">^</span><span style="color: #f8f8f2">bit2mask(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">deadmask){</span>
<span style="color: #f8f8f2">makewhite(g,curr);</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">curr</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(curr</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">rootgc)</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">rootgc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next;</span>
<span style="color: #f8f8f2">freeobj(L,curr);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">checkSizes</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.nuse</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">cast(lu_int32,g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.size</span><span style="color: #f92672">/</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;&amp;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.size</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">32</span><span style="color: #f92672">*</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaS_resize(L,g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.size</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaZ_sizebuffer(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff)</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">32</span><span style="color: #f92672">*</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">newsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaZ_sizebuffer(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff)</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaZ_resizebuffer(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff,newsize);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">GCTM</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next;</span>
<span style="color: #f8f8f2">Udata</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">udata</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">rawgco2u(o);</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(o</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata)</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">udata</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uv.next;</span>
<span style="color: #f8f8f2">udata</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uv.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mainthread</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">next;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mainthread</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">makewhite(g,o);</span>
<span style="color: #f8f8f2">tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fasttm(L,udata</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uv.metatable,TM_GC);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(tm</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">oldah</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">allowhook;</span>
<span style="color: #f8f8f2">lu_mem</span> <span style="color: #f8f8f2">oldt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">GCthreshold;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">allowhook</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">GCthreshold</span><span style="color: #f92672">=</span><span style="color: #ae81ff">2</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes;</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,tm);</span>
<span style="color: #f8f8f2">setuvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,udata);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaD_call(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">allowhook</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">oldah;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">GCthreshold</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">oldt;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_callGCTM</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata)</span>
<span style="color: #f8f8f2">GCTM(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_freeall</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">currentwhite</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">bit2mask(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">|</span><span style="color: #f8f8f2">bitmask(</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">sweepwholelist(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">rootgc);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.size;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">sweepwholelist(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.hash[i]);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">markmt</span><span style="color: #f8f8f2">(global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mt[i])markobject(g,g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mt[i]);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">markroot</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">grayagain</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">weak</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">markobject(g,g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mainthread);</span>
<span style="color: #f8f8f2">markvalue(g,gt(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mainthread));</span>
<span style="color: #f8f8f2">markvalue(g,registry(L));</span>
<span style="color: #f8f8f2">markmt(g);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">remarkupvals</span><span style="color: #f8f8f2">(global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g){</span>
<span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">uv;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(uv</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uvhead.u.l.next;uv</span><span style="color: #f92672">!=&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uvhead;uv</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.l.next){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isgray(obj2gco(uv)))</span>
<span style="color: #f8f8f2">markvalue(g,uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">atomic</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">udsize;</span>
<span style="color: #f8f8f2">remarkupvals(g);</span>
<span style="color: #f8f8f2">propagateall(g);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">weak;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">weak</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">markobject(g,L);</span>
<span style="color: #f8f8f2">markmt(g);</span>
<span style="color: #f8f8f2">propagateall(g);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">grayagain;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">grayagain</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">propagateall(g);</span>
<span style="color: #f8f8f2">udsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaC_separateudata(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">marktmu(g);</span>
<span style="color: #f8f8f2">udsize</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">propagateall(g);</span>
<span style="color: #f8f8f2">cleartable(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">weak);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">currentwhite</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(otherwhite(g));</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sweepstrgc</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sweepgc</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">rootgc;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">estimate</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">udsize;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">l_mem</span> <span style="color: #a6e22e">singlestep</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">0</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">markroot(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">1</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">propagatemark(g);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">atomic(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">2</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lu_mem</span> <span style="color: #f8f8f2">old</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes;</span>
<span style="color: #f8f8f2">sweepwholelist(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.hash[g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sweepstrgc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">]);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sweepstrgc</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.size)</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">=</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">estimate</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">old</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">3</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lu_mem</span> <span style="color: #f8f8f2">old</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sweepgc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">sweeplist(L,g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sweepgc,</span><span style="color: #ae81ff">40</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sweepgc</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">checkSizes(L);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">=</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">estimate</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">old</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">40</span><span style="color: #f92672">*</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">4</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata){</span>
<span style="color: #f8f8f2">GCTM(L);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">estimate</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">100</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">estimate</span><span style="color: #f92672">-=</span><span style="color: #ae81ff">100</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">100</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcdept</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_step</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #f8f8f2">l_mem</span> <span style="color: #f8f8f2">lim</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">1024u</span><span style="color: #f92672">/</span><span style="color: #ae81ff">100</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstepmul;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lim</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">lim</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(((lu_mem)(</span><span style="color: #f92672">~</span><span style="color: #f8f8f2">(lu_mem)</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcdept</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">GCthreshold;</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lim</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">singlestep(L);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(lim</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcdept</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">1024u</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">GCthreshold</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1024u</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcdept</span><span style="color: #f92672">-=</span><span style="color: #ae81ff">1024u</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">GCthreshold</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setthreshold(g);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_barrierf</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o,GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">==</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">reallymarkobject(g,v);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">makewhite(g,o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_barrierback</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">obj2gco(t);</span>
<span style="color: #f8f8f2">black2gray(o);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gclist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">grayagain;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">grayagain</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_link</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o,lu_byte</span> <span style="color: #f8f8f2">tt){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">rootgc;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">rootgc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.marked</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaC_white(g);</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.tt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tt;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaC_linkupval</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">uv){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #f8f8f2">GCObject</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">obj2gco(uv);</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gch.next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">rootgc;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">rootgc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isgray(o)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">==</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">gray2black(o);</span>
<span style="color: #f8f8f2">luaC_barrier(L,uv,uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">makewhite(g,o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">union</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">r;</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ts;</span>
<span style="color: #f8f8f2">}SemInfo;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Token{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">token;</span>
<span style="color: #f8f8f2">SemInfo</span> <span style="color: #f8f8f2">seminfo;</span>
<span style="color: #f8f8f2">}Token;</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LexState{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">current;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">linenumber;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">lastline;</span>
<span style="color: #f8f8f2">Token</span> <span style="color: #f8f8f2">t;</span>
<span style="color: #f8f8f2">Token</span> <span style="color: #f8f8f2">lookahead;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">ZIO</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">z;</span>
<span style="color: #f8f8f2">Mbuffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">buff;</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">source;</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">decpoint;</span>
<span style="color: #f8f8f2">}LexState;</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaX_init</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaX_lexerror</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">msg,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">token);</span>
<span style="color: #75715e">#define state_size(x)(sizeof(x)+0)</span>
<span style="color: #75715e">#define fromstate(l)(cast(lu_byte*,(l))-0)</span>
<span style="color: #75715e">#define tostate(l)(cast(lua_State*,cast(lu_byte*,l)+0))</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LG{</span>
<span style="color: #f8f8f2">lua_State</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">global_State</span> <span style="color: #f8f8f2">g;</span>
<span style="color: #f8f8f2">}LG;</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">stack_init</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L1,lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaM_newvector(L,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">,CallInfo);</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci;</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">=</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">end_ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaM_newvector(L,(</span><span style="color: #ae81ff">2</span><span style="color: #f92672">*</span><span style="color: #ae81ff">20</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,TValue);</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">2</span><span style="color: #f92672">*</span><span style="color: #ae81ff">20</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack;</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack_last</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">(L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize</span><span style="color: #f92672">-</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;</span>
<span style="color: #f8f8f2">setnilvalue(L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;</span>
<span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #ae81ff">20</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">freestack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L1){</span>
<span style="color: #f8f8f2">luaM_freearray(L,L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci,L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci,CallInfo);</span>
<span style="color: #f8f8f2">luaM_freearray(L,L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack,L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize,TValue);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">f_luaopen</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #f8f8f2">UNUSED(ud);</span>
<span style="color: #f8f8f2">stack_init(L,L);</span>
<span style="color: #f8f8f2">sethvalue(L,gt(L),luaH_new(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">sethvalue(L,registry(L),luaH_new(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">luaS_resize(L,</span><span style="color: #ae81ff">32</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaT_init(L);</span>
<span style="color: #f8f8f2">luaX_init(L);</span>
<span style="color: #f8f8f2">luaS_fix(luaS_newliteral(L,</span><span style="color: #e6db74">&quot;not enough memory&quot;</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">GCthreshold</span><span style="color: #f92672">=</span><span style="color: #ae81ff">4</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">preinit_state</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g){</span>
<span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">g;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stacksize</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errorJmp</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">hook</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">hookmask</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">basehookcount</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">allowhook</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">resethookcount(L);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">openupval</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size_ci</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">baseCcalls</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errfunc</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">setnilvalue(gt(L));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">close_state</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L);</span>
<span style="color: #f8f8f2">luaF_close(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack);</span>
<span style="color: #f8f8f2">luaC_freeall(L);</span>
<span style="color: #f8f8f2">luaM_freearray(L,G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.hash,G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.size,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaZ_freebuffer(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff);</span>
<span style="color: #f8f8f2">freestack(L,L);</span>
<span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">frealloc)(g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ud,fromstate(L),state_size(LG),</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaE_freethread</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L1){</span>
<span style="color: #f8f8f2">luaF_close(L1,L1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack);</span>
<span style="color: #f8f8f2">freestack(L,L1);</span>
<span style="color: #f8f8f2">luaM_freemem(L,fromstate(L1),state_size(lua_State));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #a6e22e">lua_newstate</span><span style="color: #f8f8f2">(lua_Alloc</span> <span style="color: #f8f8f2">f,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">global_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">g;</span>
<span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f)(ud,NULL,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,state_size(LG));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tostate(l);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">((LG</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">g;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tt</span><span style="color: #f92672">=</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">currentwhite</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">bit2mask(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">marked</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaC_white(g);</span>
<span style="color: #f8f8f2">set2bits(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">marked,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">preinit_state(L,g);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">frealloc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ud</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ud;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mainthread</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uvhead.u.l.prev</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uvhead;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uvhead.u.l.next</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">uvhead;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">GCthreshold</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.size</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.nuse</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">strt.hash</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">setnilvalue(registry(L));</span>
<span style="color: #f8f8f2">luaZ_initbuffer(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">panic</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstate</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">rootgc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">obj2gco(L);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sweepstrgc</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sweepgc</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">rootgc;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">grayagain</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">weak</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tmudata</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">totalbytes</span><span style="color: #f92672">=</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(LG);</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcpause</span><span style="color: #f92672">=</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcstepmul</span><span style="color: #f92672">=</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">gcdept</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">8</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)g</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mt[i]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaD_rawrunprotected(L,f_luaopen,NULL)</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">close_state(L);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">{}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">callallgcTM</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud){</span>
<span style="color: #f8f8f2">UNUSED(ud);</span>
<span style="color: #f8f8f2">luaC_callGCTM(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_close</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mainthread;</span>
<span style="color: #f8f8f2">luaF_close(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack);</span>
<span style="color: #f8f8f2">luaC_separateudata(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errfunc</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">baseCcalls</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(luaD_rawrunprotected(L,callallgcTM,NULL)</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">close_state(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define getcode(fs,e)((fs)-&gt;f-&gt;code[(e)-&gt;u.s.info])</span>
<span style="color: #75715e">#define luaK_codeAsBx(fs,o,A,sBx)luaK_codeABx(fs,o,A,(sBx)+(((1&lt;&lt;(9+9))-1)&gt;&gt;1))</span>
<span style="color: #75715e">#define luaK_setmultret(fs,e)luaK_setreturns(fs,e,(-1))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_codeABx</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,OpCode</span> <span style="color: #f8f8f2">o,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">A,</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">Bx);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_codeABC</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,OpCode</span> <span style="color: #f8f8f2">o,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">A,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">B,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">C);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_setreturns</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nresults);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_patchtohere</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">list);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_concat</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l1,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">l2);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">currentpc</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">isLua(ci))</span><span style="color: #66d9ef">return</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ci</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci)</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pcRel(ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc,ci_func(ci)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">currentline</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">currentpc(L,ci);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(pc</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">getline_(ci_func(ci)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p,pc);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_getstack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">level,lua_Debug</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ar){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci;level</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci;ci</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">level</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f_isLua(ci))</span>
<span style="color: #f8f8f2">level</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tailcalls;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(level</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci){</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">i_ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_int(ci</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(level</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">i_ci</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #a6e22e">getluaproto</span><span style="color: #f8f8f2">(CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci){</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(isLua(ci)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">ci_func(ci)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">NULL);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">funcinfo</span><span style="color: #f8f8f2">(lua_Debug</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ar,Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cl){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.isC){</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;=[C]&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linedefined</span><span style="color: #f92672">=-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastlinedefined</span><span style="color: #f92672">=-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">what</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;C&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getstr(cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source);</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linedefined</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linedefined;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastlinedefined</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastlinedefined;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">what</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linedefined</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">?</span><span style="color: #e6db74">&quot;main&quot;</span><span style="color: #f92672">:</span><span style="color: #e6db74">&quot;Lua&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaO_chunkid(ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">short_src,ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source,</span><span style="color: #ae81ff">60</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">info_tailcall</span><span style="color: #f8f8f2">(lua_Debug</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ar){</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">name</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">namewhat</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">what</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;tail&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastlinedefined</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linedefined</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">currentline</span><span style="color: #f92672">=-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;=(tail call)&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaO_chunkid(ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">short_src,ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source,</span><span style="color: #ae81ff">60</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">collectvalidlines</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.isC){</span>
<span style="color: #f8f8f2">setnilvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_new(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lineinfo</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lineinfo;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelineinfo;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">setbvalue(luaH_setnum(L,t,lineinfo[i]),</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">sethvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,t);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">auxgetinfo</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">what,lua_Debug</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ar,</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f,CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">info_tailcall(ar);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">what;what</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">what){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;S&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">funcinfo(ar,f);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;l&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">currentline</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(ci)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">currentline(L,ci)</span><span style="color: #f92672">:-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;u&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.nupvalues;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;n&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">namewhat</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(ci)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">NULL</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">namewhat</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">namewhat</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">name</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;L&#39;</span>:
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;f&#39;</span>:
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:status</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_getinfo</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">what,lua_Debug</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ar){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">what</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;&gt;&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luai_apicheck(L,ttisfunction(func));</span>
<span style="color: #f8f8f2">what</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">clvalue(func);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">i_ci</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">ar</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">i_ci;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">clvalue(ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">auxgetinfo(L,what,ar,f,ci);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(strchr(what,</span><span style="color: #e6db74">&#39;f&#39;</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)setnilvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top);</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">setclvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,f);</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(strchr(what,</span><span style="color: #e6db74">&#39;L&#39;</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">collectvalidlines(L,f);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">isinstack</span><span style="color: #f8f8f2">(CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base;p</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(o</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">p)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaG_typeerror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">op){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaT_typenames[ttype(o)];</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">kind</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(isinstack(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci,o))</span><span style="color: #f92672">?</span>
<span style="color: #f8f8f2">NULL:</span>
<span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(kind)</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;attempt to %s %s &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; (a %s value)&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">op,kind,name,t);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;attempt to %s a %s value&quot;</span><span style="color: #f8f8f2">,op,t);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaG_concaterror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">p1,StkId</span> <span style="color: #f8f8f2">p2){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisstring(p1)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">ttisnumber(p1))p1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">p2;</span>
<span style="color: #f8f8f2">luaG_typeerror(L,p1,</span><span style="color: #e6db74">&quot;concatenate&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaG_aritherror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p1,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p2){</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">temp;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaV_tonumber(p1,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">temp)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">p2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">p1;</span>
<span style="color: #f8f8f2">luaG_typeerror(L,p2,</span><span style="color: #e6db74">&quot;perform arithmetic on&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaG_ordererror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p1,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p2){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaT_typenames[ttype(p1)];</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaT_typenames[ttype(p2)];</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(t1[</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">t2[</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">])</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;attempt to compare two %s values&quot;</span><span style="color: #f8f8f2">,t1);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;attempt to compare %s with %s&quot;</span><span style="color: #f8f8f2">,t1,t2);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">addinfo</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">msg){</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isLua(ci)){</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">60</span><span style="color: #f8f8f2">];</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">currentline(L,ci);</span>
<span style="color: #f8f8f2">luaO_chunkid(buff,getstr(getluaproto(ci)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source),</span><span style="color: #ae81ff">60</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaO_pushfstring(L,</span><span style="color: #e6db74">&quot;%s:%d: %s&quot;</span><span style="color: #f8f8f2">,buff,line,msg);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaG_errormsg</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errfunc</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">errfunc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">restorestack(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">errfunc);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisfunction(errfunc))luaD_throw(L,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,errfunc);</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #f8f8f2">luaD_call(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaD_throw(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaG_runerror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fmt,...){</span>
<span style="color: #66d9ef">va_list</span> <span style="color: #f8f8f2">argp;</span>
<span style="color: #f8f8f2">va_start(argp,fmt);</span>
<span style="color: #f8f8f2">addinfo(L,luaO_pushvfstring(L,fmt,argp));</span>
<span style="color: #f8f8f2">va_end(argp);</span>
<span style="color: #f8f8f2">luaG_errormsg(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaZ_fill</span><span style="color: #f8f8f2">(ZIO</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">z){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">size;</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">buff;</span>
<span style="color: #f8f8f2">buff</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">reader(L,z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">data,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">size);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(buff</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">buff;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">char2int(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaZ_init</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,ZIO</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">z,lua_Reader</span> <span style="color: #f8f8f2">reader,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">data){</span>
<span style="color: #f8f8f2">z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">reader</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">reader;</span>
<span style="color: #f8f8f2">z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">data</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">data;</span>
<span style="color: #f8f8f2">z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">z</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaZ_openspace</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Mbuffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">buff,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">buff</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buffsize){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">32</span><span style="color: #f8f8f2">)n</span><span style="color: #f92672">=</span><span style="color: #ae81ff">32</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaZ_resizebuffer(L,buff,n);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">buff</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buffer;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define opmode(t,a,b,c,m)(((t)&lt;&lt;7)|((a)&lt;&lt;6)|((b)&lt;&lt;4)|((c)&lt;&lt;2)|(m))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">luaP_opmodes[(cast(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">,OP_VARARG)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgN,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgK,OpArgN,iABx)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgU,OpArgU,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgN,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgU,OpArgN,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgK,OpArgN,iABx)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgK,OpArgN,iABx)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgU,OpArgN,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgK,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgU,OpArgU,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgK,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgK,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgK,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgK,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgK,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgK,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgN,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgN,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgN,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgR,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgR,OpArgN,iAsBx)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgK,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgK,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgK,OpArgK,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgU,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgU,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgU,OpArgU,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgU,OpArgU,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgU,OpArgN,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgN,iAsBx)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgR,OpArgN,iAsBx)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgN,OpArgU,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgU,OpArgU,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,OpArgN,OpArgN,iABC)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgU,OpArgN,iABx)</span>
<span style="color: #f8f8f2">,opmode(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,OpArgU,OpArgN,iABC)</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #75715e">#define next(ls)(ls-&gt;current=zgetc(ls-&gt;z))</span>
<span style="color: #75715e">#define currIsNewline(ls)(ls-&gt;current==&#39;\n&#39;||ls-&gt;current==&#39;\r&#39;)</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaX_tokens[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #e6db74">&quot;and&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;break&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;do&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;else&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;elseif&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;end&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;false&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;for&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;function&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;if&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;in&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;local&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;nil&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;not&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;or&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;repeat&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;return&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;then&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;true&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;until&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;while&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;..&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;...&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;==&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;&gt;=&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;&lt;=&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;~=&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;&lt;number&gt;&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;&lt;name&gt;&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;&lt;string&gt;&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;&lt;eof&gt;&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">NULL</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #75715e">#define save_and_next(ls)(save(ls,ls-&gt;current),next(ls))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">save</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c){</span>
<span style="color: #f8f8f2">Mbuffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(b</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">b</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buffsize){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">newsize;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(b</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buffsize</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">((</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)(</span><span style="color: #f92672">~</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaX_lexerror(ls,</span><span style="color: #e6db74">&quot;lexical element too long&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">newsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">b</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buffsize</span><span style="color: #f92672">*</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaZ_resizebuffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,b,newsize);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">b</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buffer[b</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(</span><span style="color: #66d9ef">char</span><span style="color: #f8f8f2">,c);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaX_init</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">(cast(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">,TK_WHILE</span><span style="color: #f92672">-</span><span style="color: #ae81ff">257</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ts</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaS_new(L,luaX_tokens[i]);</span>
<span style="color: #f8f8f2">luaS_fix(ts);</span>
<span style="color: #f8f8f2">ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.reserved</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(i</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaX_token2str</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">token){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(token</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">257</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(iscntrl(token))</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">luaO_pushfstring(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;char(%d)&quot;</span><span style="color: #f8f8f2">,token)</span><span style="color: #f92672">:</span>
<span style="color: #f8f8f2">luaO_pushfstring(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;%c&quot;</span><span style="color: #f8f8f2">,token);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaX_tokens[token</span><span style="color: #f92672">-</span><span style="color: #ae81ff">257</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">txtToken</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">token){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(token){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_NAME</span>:
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_STRING</span>:
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_NUMBER</span>:
<span style="color: #f8f8f2">save(ls,</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaZ_buffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff);</span>
<span style="color: #f8f8f2">default:</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaX_token2str(ls,token);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaX_lexerror</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">msg,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">token){</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">80</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">luaO_chunkid(buff,getstr(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source),</span><span style="color: #ae81ff">80</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">msg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaO_pushfstring(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;%s:%d: %s&quot;</span><span style="color: #f8f8f2">,buff,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber,msg);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(token)</span>
<span style="color: #f8f8f2">luaO_pushfstring(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;%s near &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">),msg,txtToken(ls,token));</span>
<span style="color: #f8f8f2">luaD_throw(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaX_syntaxerror</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">msg){</span>
<span style="color: #f8f8f2">luaX_lexerror(ls,msg,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaX_newstring</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">str,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l){</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ts</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaS_newlstr(L,str,l);</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_setstr(L,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">h,ts);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(o)){</span>
<span style="color: #f8f8f2">setbvalue(o,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">ts;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">inclinenumber</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">old</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current;</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(currIsNewline(ls)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">old)</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">(INT_MAX</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaX_syntaxerror(ls,</span><span style="color: #e6db74">&quot;chunk has too many lines&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaX_setinput</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,ZIO</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">z,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">source){</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">decpoint</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;.&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lookahead.token</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">TK_EOS;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">z</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">z;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastline</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">source;</span>
<span style="color: #f8f8f2">luaZ_resizebuffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff,</span><span style="color: #ae81ff">32</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">check_next</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">set){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">strchr(set,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current))</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">buffreplace</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">from,</span><span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">to){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaZ_bufflen(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff);</span>
<span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaZ_buffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(p[n]</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">from)p[n]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">to;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">read_numeral</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,SemInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">seminfo){</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(isdigit(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;.&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(check_next(ls,</span><span style="color: #e6db74">&quot;Ee&quot;</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">check_next(ls,</span><span style="color: #e6db74">&quot;+-&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(isalnum(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;_&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #f8f8f2">save(ls,</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">buffreplace(ls,</span><span style="color: #e6db74">&#39;.&#39;</span><span style="color: #f8f8f2">,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">decpoint);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">luaO_str2d(luaZ_buffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff),</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">seminfo</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">r))</span>
<span style="color: #f8f8f2">luaX_lexerror(ls,</span><span style="color: #e6db74">&quot;malformed number&quot;</span><span style="color: #f8f8f2">,TK_NUMBER);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">skip_sep</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">count</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current;</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #f8f8f2">count</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">s)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">count</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">count)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">read_long_string</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,SemInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">seminfo,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sep){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">cont</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">)(cont);</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(currIsNewline(ls))</span>
<span style="color: #f8f8f2">inclinenumber(ls);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;;){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current){</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>:
<span style="color: #f8f8f2">luaX_lexerror(ls,(seminfo)</span><span style="color: #f92672">?</span><span style="color: #e6db74">&quot;unfinished long string&quot;</span><span style="color: #f92672">:</span>
<span style="color: #e6db74">&quot;unfinished long comment&quot;</span><span style="color: #f8f8f2">,TK_EOS);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;]&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(skip_sep(ls)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">sep){</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">endloop;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\n&#39;</span>:
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\r&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">save(ls,</span><span style="color: #e6db74">&#39;\n&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">inclinenumber(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">seminfo)luaZ_resetbuffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(seminfo)save_and_next(ls);</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">next(ls);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}endloop</span><span style="color: #f92672">:</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(seminfo)</span>
<span style="color: #f8f8f2">seminfo</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ts</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaX_newstring(ls,luaZ_buffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">2</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">sep),</span>
<span style="color: #f8f8f2">luaZ_bufflen(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">2</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">sep));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">read_string</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">del,SemInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">seminfo){</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">del){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current){</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>:
<span style="color: #f8f8f2">luaX_lexerror(ls,</span><span style="color: #e6db74">&quot;unfinished string&quot;</span><span style="color: #f8f8f2">,TK_EOS);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\n&#39;</span>:
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\r&#39;</span>:
<span style="color: #f8f8f2">luaX_lexerror(ls,</span><span style="color: #e6db74">&quot;unfinished string&quot;</span><span style="color: #f8f8f2">,TK_STRING);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\\&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c;</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;a&#39;</span>:<span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\a&#39;</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;b&#39;</span>:<span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\b&#39;</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;f&#39;</span>:<span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\f&#39;</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;n&#39;</span>:<span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\n&#39;</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;r&#39;</span>:<span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\r&#39;</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;t&#39;</span>:<span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\t&#39;</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;v&#39;</span>:<span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\v&#39;</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\n&#39;</span>:
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\r&#39;</span>:<span style="color: #f8f8f2">save(ls,</span><span style="color: #e6db74">&#39;\n&#39;</span><span style="color: #f8f8f2">);inclinenumber(ls);</span><span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>:<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">isdigit(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current))</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #ae81ff">10</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">c</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">-</span><span style="color: #e6db74">&#39;0&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">3</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">isdigit(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(c</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">UCHAR_MAX)</span>
<span style="color: #f8f8f2">luaX_lexerror(ls,</span><span style="color: #e6db74">&quot;escape sequence too large&quot;</span><span style="color: #f8f8f2">,TK_STRING);</span>
<span style="color: #f8f8f2">save(ls,c);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">save(ls,c);</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #f8f8f2">seminfo</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ts</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaX_newstring(ls,luaZ_buffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">luaZ_bufflen(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">llex</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,SemInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">seminfo){</span>
<span style="color: #f8f8f2">luaZ_resetbuffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;;){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\n&#39;</span>:
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\r&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">inclinenumber(ls);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;-&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;-&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span><span style="color: #e6db74">&#39;-&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;[&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sep</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">skip_sep(ls);</span>
<span style="color: #f8f8f2">luaZ_resetbuffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(sep</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">read_long_string(ls,NULL,sep);</span>
<span style="color: #f8f8f2">luaZ_resetbuffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">currIsNewline(ls)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;[&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sep</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">skip_sep(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(sep</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">read_long_string(ls,seminfo,sep);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_STRING;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(sep</span><span style="color: #f92672">==-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span><span style="color: #e6db74">&#39;[&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">luaX_lexerror(ls,</span><span style="color: #e6db74">&quot;invalid long string delimiter&quot;</span><span style="color: #f8f8f2">,TK_STRING);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;=&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{next(ls);</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_EQ;}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;&lt;&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span><span style="color: #e6db74">&#39;&lt;&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{next(ls);</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_LE;}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;&gt;&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span><span style="color: #e6db74">&#39;&gt;&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{next(ls);</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_GE;}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;~&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span><span style="color: #e6db74">&#39;~&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{next(ls);</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_NE;}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;&quot;&#39;</span>:
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\&#39;&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">read_string(ls,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current,seminfo);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_STRING;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;.&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(check_next(ls,</span><span style="color: #e6db74">&quot;.&quot;</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(check_next(ls,</span><span style="color: #e6db74">&quot;.&quot;</span><span style="color: #f8f8f2">))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_DOTS;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_CONCAT;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">isdigit(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current))</span><span style="color: #66d9ef">return</span><span style="color: #e6db74">&#39;.&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">read_numeral(ls,seminfo);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_NUMBER;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_EOS;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isspace(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current)){</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isdigit(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current)){</span>
<span style="color: #f8f8f2">read_numeral(ls,seminfo);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_NUMBER;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isalpha(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;_&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ts;</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">save_and_next(ls);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(isalnum(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;_&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">ts</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaX_newstring(ls,luaZ_buffer(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff),</span>
<span style="color: #f8f8f2">luaZ_bufflen(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.reserved</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.reserved</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f92672">+</span><span style="color: #ae81ff">257</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">seminfo</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ts</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ts;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">TK_NAME;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">current;</span>
<span style="color: #f8f8f2">next(ls);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">c;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaX_next</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastline</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lookahead.token</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">TK_EOS){</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lookahead;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lookahead.token</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">TK_EOS;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">llex(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.seminfo);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaX_lookahead</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lookahead.token</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">llex(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lookahead.seminfo);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define hasjumps(e)((e)-&gt;t!=(e)-&gt;f)</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">isnumeral</span><span style="color: #f8f8f2">(expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VKNUM</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_nil</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">from,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">previous;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lasttarget){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(from</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar)</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">previous</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code[fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">];</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(GET_OPCODE(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">previous)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">OP_LOADNIL){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pfrom</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_A(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">previous);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pto</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_B(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">previous);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(pfrom</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">from</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">from</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">pto</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(from</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">pto)</span>
<span style="color: #f8f8f2">SETARG_B(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">previous,from</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_LOADNIL,from,from</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_jump</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">jpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">jpc;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">j;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">jpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">j</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_codeAsBx(fs,OP_JMP,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">j,jpc);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">j;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_ret</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">first,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nret){</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_RETURN,first,nret</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">condjump</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,OpCode</span> <span style="color: #f8f8f2">op,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">A,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">B,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">C){</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,op,A,B,C);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaK_jump(fs);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">fixjump</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pc,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">dest){</span>
<span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">jmp</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code[pc];</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">offset</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">dest</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">(pc</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(abs(offset)</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">9</span><span style="color: #f92672">+</span><span style="color: #ae81ff">9</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaX_syntaxerror(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ls,</span><span style="color: #e6db74">&quot;control structure too long&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">SETARG_sBx(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">jmp,offset);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_getlabel</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs){</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lasttarget</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">getjump</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pc){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">offset</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_sBx(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code[pc]);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(offset</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(pc</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">offset;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #a6e22e">getjumpcontrol</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pc){</span>
<span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pi</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code[pc];</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(pc</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">testTMode(GET_OPCODE(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(pi</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pi</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pi;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">need_value</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">list){</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;list</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);list</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getjump(fs,list)){</span>
<span style="color: #f8f8f2">Instruction</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">getjumpcontrol(fs,list);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(GET_OPCODE(i)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">OP_TESTSET)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">patchtestreg</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">node,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">reg){</span>
<span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getjumpcontrol(fs,node);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(GET_OPCODE(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">i)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">OP_TESTSET)</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(reg</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">reg</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">GETARG_B(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">i))</span>
<span style="color: #f8f8f2">SETARG_A(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">i,reg);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">CREATE_ABC(OP_TEST,GETARG_B(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">i),</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,GETARG_C(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">i));</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">removevalues</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">list){</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;list</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);list</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getjump(fs,list))</span>
<span style="color: #f8f8f2">patchtestreg(fs,list,((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">patchlistaux</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">list,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">vtarget,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">reg,</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">dtarget){</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(list</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getjump(fs,list);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(patchtestreg(fs,list,reg))</span>
<span style="color: #f8f8f2">fixjump(fs,list,vtarget);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">fixjump(fs,list,dtarget);</span>
<span style="color: #f8f8f2">list</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">next;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">dischargejpc</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs){</span>
<span style="color: #f8f8f2">patchlistaux(fs,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">jpc,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc,((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">jpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_patchlist</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">list,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">target){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(target</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc)</span>
<span style="color: #f8f8f2">luaK_patchtohere(fs,list);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">patchlistaux(fs,list,target,((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),target);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_patchtohere</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">list){</span>
<span style="color: #f8f8f2">luaK_getlabel(fs);</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">jpc,list);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_concat</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l1,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">l2){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l2</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l1</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">l1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l2;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">list</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">l1;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">next;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">((next</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getjump(fs,list))</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">list</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">next;</span>
<span style="color: #f8f8f2">fixjump(fs,list,l2);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_checkstack</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">newstack</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(newstack</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">maxstacksize){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(newstack</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">250</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaX_syntaxerror(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ls,</span><span style="color: #e6db74">&quot;function or expression too complex&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">maxstacksize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(newstack);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_reserveregs</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">luaK_checkstack(fs,n);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">freereg</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">reg){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ISK(reg)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">reg</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar){</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">freeexp</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VNONRELOC)</span>
<span style="color: #f8f8f2">freereg(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">addk</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">k,TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">idx</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_set(L,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">h,k);</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">oldsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizek;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnumber(idx)){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">cast_int(nvalue(idx));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setnvalue(idx,cast_num(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nk));</span>
<span style="color: #f8f8f2">luaM_growvector(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nk,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizek,TValue,</span>
<span style="color: #f8f8f2">((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">9</span><span style="color: #f92672">+</span><span style="color: #ae81ff">9</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),</span><span style="color: #e6db74">&quot;constant table overflow&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(oldsize</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizek)setnilvalue(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k[oldsize</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">]);</span>
<span style="color: #f8f8f2">setobj(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k[fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nk],v);</span>
<span style="color: #f8f8f2">luaC_barrier(L,f,v);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nk</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_stringK</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s){</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">setsvalue(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">o,s);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">addk(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">o,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_numberK</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,lua_Number</span> <span style="color: #f8f8f2">r){</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">setnvalue(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">o,r);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">addk(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">o,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">boolK</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b){</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">setbvalue(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">o,b);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">addk(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">o,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">nilK</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs){</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">k,v;</span>
<span style="color: #f8f8f2">setnilvalue(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #f8f8f2">sethvalue(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">k,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">h);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">addk(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">k,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_setreturns</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nresults){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VCALL){</span>
<span style="color: #f8f8f2">SETARG_C(getcode(fs,e),nresults</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VVARARG){</span>
<span style="color: #f8f8f2">SETARG_B(getcode(fs,e),nresults</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">SETARG_A(getcode(fs,e),fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg);</span>
<span style="color: #f8f8f2">luaK_reserveregs(fs,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_setoneret</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VCALL){</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VNONRELOC;</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_A(getcode(fs,e));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VVARARG){</span>
<span style="color: #f8f8f2">SETARG_B(getcode(fs,e),</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VRELOCABLE;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_dischargevars</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VLOCAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VNONRELOC;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VUPVAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_codeABC(fs,OP_GETUPVAL,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VRELOCABLE;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VGLOBAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_codeABx(fs,OP_GETGLOBAL,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VRELOCABLE;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VINDEXED</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">freereg(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.aux);</span>
<span style="color: #f8f8f2">freereg(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_codeABC(fs,OP_GETTABLE,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.aux);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VRELOCABLE;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VVARARG</span>:
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VCALL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_setoneret(fs,e);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">code_label</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">A,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">jump){</span>
<span style="color: #f8f8f2">luaK_getlabel(fs);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaK_codeABC(fs,OP_LOADBOOL,A,b,jump);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">discharge2reg</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">reg){</span>
<span style="color: #f8f8f2">luaK_dischargevars(fs,e);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VNIL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_nil(fs,reg,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VFALSE</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VTRUE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_LOADBOOL,reg,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VTRUE,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VK</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_codeABx(fs,OP_LOADK,reg,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VKNUM</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_codeABx(fs,OP_LOADK,reg,luaK_numberK(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.nval));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VRELOCABLE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">getcode(fs,e);</span>
<span style="color: #f8f8f2">SETARG_A(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc,reg);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VNONRELOC</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(reg</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info)</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_MOVE,reg,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">reg;</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VNONRELOC;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">discharge2anyreg</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">VNONRELOC){</span>
<span style="color: #f8f8f2">luaK_reserveregs(fs,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">discharge2reg(fs,e,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">exp2reg</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">reg){</span>
<span style="color: #f8f8f2">discharge2reg(fs,e,reg);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VJMP)</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(hasjumps(e)){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">final;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">p_f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">int</span> <span style="color: #66d9ef">p_t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(need_value(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">need_value(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f)){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">fj</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VJMP)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">luaK_jump(fs);</span>
<span style="color: #f8f8f2">p_f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">code_label(fs,reg,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">p_t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">code_label(fs,reg,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaK_patchtohere(fs,fj);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">final</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_getlabel(fs);</span>
<span style="color: #f8f8f2">patchlistaux(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f,final,reg,p_f);</span>
<span style="color: #f8f8f2">patchlistaux(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t,final,reg,</span><span style="color: #66d9ef">p_t</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">reg;</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VNONRELOC;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_exp2nextreg</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">luaK_dischargevars(fs,e);</span>
<span style="color: #f8f8f2">freeexp(fs,e);</span>
<span style="color: #f8f8f2">luaK_reserveregs(fs,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">exp2reg(fs,e,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_exp2anyreg</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">luaK_dischargevars(fs,e);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VNONRELOC){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">hasjumps(e))</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar){</span>
<span style="color: #f8f8f2">exp2reg(fs,e,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(fs,e);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_exp2val</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(hasjumps(e))</span>
<span style="color: #f8f8f2">luaK_exp2anyreg(fs,e);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">luaK_dischargevars(fs,e);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_exp2RK</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">luaK_exp2val(fs,e);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VKNUM</span>:
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VTRUE</span>:
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VFALSE</span>:
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VNIL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nk</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">9</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VNIL)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">nilK(fs)</span><span style="color: #f92672">:</span>
<span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VKNUM)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">luaK_numberK(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.nval)</span><span style="color: #f92672">:</span>
<span style="color: #f8f8f2">boolK(fs,(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VTRUE));</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VK;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">RKASK(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VK</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">9</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">RKASK(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaK_exp2anyreg(fs,e);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_storevar</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">var,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ex){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(var</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VLOCAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">freeexp(fs,ex);</span>
<span style="color: #f8f8f2">exp2reg(fs,ex,var</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VUPVAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_exp2anyreg(fs,ex);</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_SETUPVAL,e,var</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VGLOBAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_exp2anyreg(fs,ex);</span>
<span style="color: #f8f8f2">luaK_codeABx(fs,OP_SETGLOBAL,e,var</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VINDEXED</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_exp2RK(fs,ex);</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_SETTABLE,var</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,var</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.aux,e);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">freeexp(fs,ex);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_self</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">func;</span>
<span style="color: #f8f8f2">luaK_exp2anyreg(fs,e);</span>
<span style="color: #f8f8f2">freeexp(fs,e);</span>
<span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg;</span>
<span style="color: #f8f8f2">luaK_reserveregs(fs,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_SELF,func,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,luaK_exp2RK(fs,key));</span>
<span style="color: #f8f8f2">freeexp(fs,key);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">func;</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VNONRELOC;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">invertjump</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getjumpcontrol(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #f8f8f2">SETARG_A(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc,</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">(GETARG_A(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc)));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">jumponcond</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">cond){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VRELOCABLE){</span>
<span style="color: #f8f8f2">Instruction</span> <span style="color: #f8f8f2">ie</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getcode(fs,e);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(GET_OPCODE(ie)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">OP_NOT){</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">condjump(fs,OP_TEST,GETARG_B(ie),</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">cond);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">discharge2anyreg(fs,e);</span>
<span style="color: #f8f8f2">freeexp(fs,e);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">condjump(fs,OP_TESTSET,((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,cond);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_goiftrue</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pc;</span>
<span style="color: #f8f8f2">luaK_dischargevars(fs,e);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VK</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VKNUM</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VTRUE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VJMP</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">invertjump(fs,e);</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">jumponcond(fs,e,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f,pc);</span>
<span style="color: #f8f8f2">luaK_patchtohere(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_goiffalse</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pc;</span>
<span style="color: #f8f8f2">luaK_dischargevars(fs,e);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VNIL</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VFALSE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VJMP</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">jumponcond(fs,e,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t,pc);</span>
<span style="color: #f8f8f2">luaK_patchtohere(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">codenot</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">luaK_dischargevars(fs,e);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VNIL</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VFALSE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VTRUE;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VK</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VKNUM</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VTRUE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VFALSE;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VJMP</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">invertjump(fs,e);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VRELOCABLE</span>:
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">VNONRELOC</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">discharge2anyreg(fs,e);</span>
<span style="color: #f8f8f2">freeexp(fs,e);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_codeABC(fs,OP_NOT,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VRELOCABLE;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">{</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">temp</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f;e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t;e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">temp;}</span>
<span style="color: #f8f8f2">removevalues(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f);</span>
<span style="color: #f8f8f2">removevalues(fs,e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_indexed</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">k){</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.aux</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_exp2RK(fs,k);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VINDEXED;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">constfolding</span><span style="color: #f8f8f2">(OpCode</span> <span style="color: #f8f8f2">op,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e1,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e2){</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">v1,v2,r;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">isnumeral(e1)</span><span style="color: #f92672">||!</span><span style="color: #f8f8f2">isnumeral(e2))</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">v1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.nval;</span>
<span style="color: #f8f8f2">v2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e2</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.nval;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(op){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_ADD</span>:<span style="color: #f8f8f2">r</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luai_numadd(v1,v2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_SUB</span>:<span style="color: #f8f8f2">r</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luai_numsub(v1,v2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_MUL</span>:<span style="color: #f8f8f2">r</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luai_nummul(v1,v2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_DIV</span>:
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(v2</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">r</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luai_numdiv(v1,v2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_MOD</span>:
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(v2</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">r</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luai_nummod(v1,v2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_POW</span>:<span style="color: #f8f8f2">r</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luai_numpow(v1,v2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_UNM</span>:<span style="color: #f8f8f2">r</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luai_numunm(v1);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_LEN</span>:<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:r</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luai_numisnan(r))</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.nval</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">r;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">codearith</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,OpCode</span> <span style="color: #f8f8f2">op,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e1,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e2){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(constfolding(op,e1,e2))</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">o2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(op</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">OP_UNM</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">op</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">OP_LEN)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">luaK_exp2RK(fs,e2)</span><span style="color: #f92672">:</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">o1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_exp2RK(fs,e1);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(o1</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">o2){</span>
<span style="color: #f8f8f2">freeexp(fs,e1);</span>
<span style="color: #f8f8f2">freeexp(fs,e2);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">freeexp(fs,e2);</span>
<span style="color: #f8f8f2">freeexp(fs,e1);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_codeABC(fs,op,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,o1,o2);</span>
<span style="color: #f8f8f2">e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VRELOCABLE;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">codecomp</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,OpCode</span> <span style="color: #f8f8f2">op,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">cond,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e1,</span>
<span style="color: #f8f8f2">expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e2){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">o1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_exp2RK(fs,e1);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">o2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_exp2RK(fs,e2);</span>
<span style="color: #f8f8f2">freeexp(fs,e2);</span>
<span style="color: #f8f8f2">freeexp(fs,e1);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(cond</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">op</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">OP_EQ){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">temp;</span>
<span style="color: #f8f8f2">temp</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o1;o1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">o2;o2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">temp;</span>
<span style="color: #f8f8f2">cond</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">condjump(fs,op,cond,o1,o2);</span>
<span style="color: #f8f8f2">e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VJMP;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_prefix</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,UnOpr</span> <span style="color: #f8f8f2">op,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">e2;</span>
<span style="color: #f8f8f2">e2.t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e2.f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);e2.k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VKNUM;e2.u.nval</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(op){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_MINUS</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">isnumeral(e))</span>
<span style="color: #f8f8f2">luaK_exp2anyreg(fs,e);</span>
<span style="color: #f8f8f2">codearith(fs,OP_UNM,e,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e2);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_NOT</span>:<span style="color: #f8f8f2">codenot(fs,e);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_LEN</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_exp2anyreg(fs,e);</span>
<span style="color: #f8f8f2">codearith(fs,OP_LEN,e,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e2);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_infix</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,BinOpr</span> <span style="color: #f8f8f2">op,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(op){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_AND</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_goiftrue(fs,v);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_OR</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_goiffalse(fs,v);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_CONCAT</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(fs,v);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_ADD</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_SUB</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_MUL</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_DIV</span>:
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_MOD</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_POW</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">isnumeral(v))luaK_exp2RK(fs,v);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">luaK_exp2RK(fs,v);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_posfix</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,BinOpr</span> <span style="color: #f8f8f2">op,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e1,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e2){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(op){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_AND</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_dischargevars(fs,e2);</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e2</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f,e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f);</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">e1</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">e2;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_OR</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_dischargevars(fs,e2);</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e2</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t,e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t);</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">e1</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">e2;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_CONCAT</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_exp2val(fs,e2);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e2</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VRELOCABLE</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">GET_OPCODE(getcode(fs,e2))</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">OP_CONCAT){</span>
<span style="color: #f8f8f2">freeexp(fs,e1);</span>
<span style="color: #f8f8f2">SETARG_B(getcode(fs,e2),e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #f8f8f2">e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VRELOCABLE;e1</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e2</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(fs,e2);</span>
<span style="color: #f8f8f2">codearith(fs,OP_CONCAT,e1,e2);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_ADD</span>:<span style="color: #f8f8f2">codearith(fs,OP_ADD,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_SUB</span>:<span style="color: #f8f8f2">codearith(fs,OP_SUB,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_MUL</span>:<span style="color: #f8f8f2">codearith(fs,OP_MUL,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_DIV</span>:<span style="color: #f8f8f2">codearith(fs,OP_DIV,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_MOD</span>:<span style="color: #f8f8f2">codearith(fs,OP_MOD,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_POW</span>:<span style="color: #f8f8f2">codearith(fs,OP_POW,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_EQ</span>:<span style="color: #f8f8f2">codecomp(fs,OP_EQ,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_NE</span>:<span style="color: #f8f8f2">codecomp(fs,OP_EQ,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_LT</span>:<span style="color: #f8f8f2">codecomp(fs,OP_LT,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_LE</span>:<span style="color: #f8f8f2">codecomp(fs,OP_LE,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_GT</span>:<span style="color: #f8f8f2">codecomp(fs,OP_LT,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OPR_GE</span>:<span style="color: #f8f8f2">codecomp(fs,OP_LE,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,e1,e2);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_fixline</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line){</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lineinfo[fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">line;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_code</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,Instruction</span> <span style="color: #f8f8f2">i,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line){</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">dischargejpc(fs);</span>
<span style="color: #f8f8f2">luaM_growvector(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizecode,Instruction,</span>
<span style="color: #f8f8f2">(INT_MAX</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">),</span><span style="color: #e6db74">&quot;code size overflow&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code[fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">luaM_growvector(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lineinfo,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelineinfo,</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">(INT_MAX</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">),</span><span style="color: #e6db74">&quot;code size overflow&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lineinfo[fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">line;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_codeABC</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,OpCode</span> <span style="color: #f8f8f2">o,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">a,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaK_code(fs,CREATE_ABC(o,a,b,c),fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastline);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaK_codeABx</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,OpCode</span> <span style="color: #f8f8f2">o,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">a,</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">bc){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaK_code(fs,CREATE_ABx(o,a,bc),fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastline);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaK_setlist</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">base,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nelems,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">tostore){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(nelems</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">/</span><span style="color: #ae81ff">50</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(tostore</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">?</span><span style="color: #ae81ff">0</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">tostore;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(c</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">9</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_SETLIST,base,b,c);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_SETLIST,base,b,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaK_code(fs,cast(Instruction,c),fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastline);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define hasmultret(k)((k)==VCALL||(k)==VVARARG)</span>
<span style="color: #75715e">#define getlocvar(fs,i)((fs)-&gt;f-&gt;locvars[(fs)-&gt;actvar[i]])</span>
<span style="color: #75715e">#define luaY_checklimit(fs,v,l,m)if((v)&gt;(l))errorlimit(fs,l,m)</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">BlockCnt{</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">BlockCnt</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">previous;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">breaklist;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">nactvar;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">upval;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">isbreakable;</span>
<span style="color: #f8f8f2">}BlockCnt;</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">chunk</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">expr</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">anchor_token</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">TK_NAME</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">TK_STRING){</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ts</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.seminfo.ts;</span>
<span style="color: #f8f8f2">luaX_newstring(ls,getstr(ts),ts</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.len);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">error_expected</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">token){</span>
<span style="color: #f8f8f2">luaX_syntaxerror(ls,</span>
<span style="color: #f8f8f2">luaO_pushfstring(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,LUA_QL(</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; expected&quot;</span><span style="color: #f8f8f2">,luaX_token2str(ls,token)));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">errorlimit</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">limit,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">what){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">msg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linedefined</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">?</span>
<span style="color: #f8f8f2">luaO_pushfstring(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;main function has more than %d %s&quot;</span><span style="color: #f8f8f2">,limit,what)</span><span style="color: #f92672">:</span>
<span style="color: #f8f8f2">luaO_pushfstring(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;function at line %d has more than %d %s&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linedefined,limit,what);</span>
<span style="color: #f8f8f2">luaX_lexerror(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ls,msg,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">testnext</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">c){</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">check</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">c)</span>
<span style="color: #f8f8f2">error_expected(ls,c);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">checknext</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c){</span>
<span style="color: #f8f8f2">check(ls,c);</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define check_condition(ls,c,msg){if(!(c))luaX_syntaxerror(ls,msg);}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">check_match</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">what,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">who,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">where){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">testnext(ls,what)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(where</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber)</span>
<span style="color: #f8f8f2">error_expected(ls,what);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaX_syntaxerror(ls,luaO_pushfstring(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span>
<span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; expected (to close &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; at line %d)&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">luaX_token2str(ls,what),luaX_token2str(ls,who),where));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #a6e22e">str_checkname</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ts;</span>
<span style="color: #f8f8f2">check(ls,TK_NAME);</span>
<span style="color: #f8f8f2">ts</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.seminfo.ts;</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">ts;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">init_exp</span><span style="color: #f8f8f2">(expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e,expkind</span> <span style="color: #f8f8f2">k,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i){</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">k;</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">codestring</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s){</span>
<span style="color: #f8f8f2">init_exp(e,VK,luaK_stringK(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,s));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">checkname</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">codestring(ls,e,str_checkname(ls));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">registerlocalvar</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">varname){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">oldsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelocvars;</span>
<span style="color: #f8f8f2">luaM_growvector(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">locvars,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nlocvars,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelocvars,</span>
<span style="color: #f8f8f2">LocVar,SHRT_MAX,</span><span style="color: #e6db74">&quot;too many local variables&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(oldsize</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelocvars)f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">locvars[oldsize</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">].varname</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">locvars[fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nlocvars].varname</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">varname;</span>
<span style="color: #f8f8f2">luaC_objbarrier(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,f,varname);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nlocvars</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define new_localvarliteral(ls,v,n)new_localvar(ls,luaX_newstring(ls,&quot;&quot;v,(sizeof(v)/sizeof(char))-1),n)</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">new_localvar</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">luaY_checklimit(fs,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;local variables&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">actvar[fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">short</span><span style="color: #f8f8f2">,registerlocalvar(ls,name));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">adjustlocalvars</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nvars){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">nvars);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;nvars;nvars</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">getlocvar(fs,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">nvars).startpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">removevars</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">tolevel){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">tolevel)</span>
<span style="color: #f8f8f2">getlocvar(fs,</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar).endpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">indexupvalue</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">oldsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizeupvalues;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues[i].k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues[i].info</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaY_checklimit(fs,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">60</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;upvalues&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaM_growvector(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizeupvalues,</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,(INT_MAX</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">),</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(oldsize</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizeupvalues)f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues[oldsize</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues[f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">name;</span>
<span style="color: #f8f8f2">luaC_objbarrier(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,f,name);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues[f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups].k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(v</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues[f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups].info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(v</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">searchvar</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">getlocvar(fs,i).varname)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">markupval</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">level){</span>
<span style="color: #f8f8f2">BlockCnt</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">bl;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(bl</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">level)bl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">previous;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(bl)bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upval</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">singlevaraux</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">var,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">base){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fs</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">init_exp(var,VGLOBAL,((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">VGLOBAL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">v</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">searchvar(fs,n);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(v</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">init_exp(var,VLOCAL,v);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">base)</span>
<span style="color: #f8f8f2">markupval(fs,v);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">VLOCAL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(singlevaraux(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">prev,n,var,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VGLOBAL)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">VGLOBAL;</span>
<span style="color: #f8f8f2">var</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">indexupvalue(fs,n,var);</span>
<span style="color: #f8f8f2">var</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VUPVAL;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">VUPVAL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">singlevar</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">var){</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">varname</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">str_checkname(ls);</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(singlevaraux(fs,varname,var,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VGLOBAL)</span>
<span style="color: #f8f8f2">var</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_stringK(fs,varname);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">adjust_assign</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nvars,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nexps,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">extra</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nvars</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">nexps;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(hasmultret(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k)){</span>
<span style="color: #f8f8f2">extra</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(extra</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)extra</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaK_setreturns(fs,e,extra);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(extra</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)luaK_reserveregs(fs,extra</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">VVOID)luaK_exp2nextreg(fs,e);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(extra</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">reg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg;</span>
<span style="color: #f8f8f2">luaK_reserveregs(fs,extra);</span>
<span style="color: #f8f8f2">luaK_nil(fs,reg,extra);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">enterlevel</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaX_lexerror(ls,</span><span style="color: #e6db74">&quot;chunk has too many syntax levels&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define leavelevel(ls)((ls)-&gt;L-&gt;nCcalls--)</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">enterblock</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,BlockCnt</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">bl,lu_byte</span> <span style="color: #f8f8f2">isbreakable){</span>
<span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">breaklist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">isbreakable</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">isbreakable;</span>
<span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar;</span>
<span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upval</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">previous</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">bl;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">bl;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">leaveblock</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs){</span>
<span style="color: #f8f8f2">BlockCnt</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">bl;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">previous;</span>
<span style="color: #f8f8f2">removevars(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ls,bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upval)</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_CLOSE,bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar;</span>
<span style="color: #f8f8f2">luaK_patchtohere(fs,bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">breaklist);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">pushclosure</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">func,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">oldsize</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizep;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">luaM_growvector(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">np,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizep,Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">((</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">9</span><span style="color: #f92672">+</span><span style="color: #ae81ff">9</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),</span><span style="color: #e6db74">&quot;constant table overflow&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(oldsize</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizep)f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p[oldsize</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p[fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">np</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">luaC_objbarrier(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,f,func</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f);</span>
<span style="color: #f8f8f2">init_exp(v,VRELOCABLE,luaK_codeABx(fs,OP_CLOSURE,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">np</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">OpCode</span> <span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(func</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues[i].k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VLOCAL)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">OP_MOVE</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">OP_GETUPVAL;</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,o,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,func</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues[i].info,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">open_func</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs){</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaF_newproto(L);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">prev</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lasttarget</span><span style="color: #f92672">=-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">jpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nk</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">np</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nlocvars</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">source;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">maxstacksize</span><span style="color: #f92672">=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_new(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">sethvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">h);</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #f8f8f2">setptvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,f);</span>
<span style="color: #f8f8f2">incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">close_func</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">removevars(ls,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaK_ret(fs,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaM_reallocvector(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizecode,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc,Instruction);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizecode</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #f8f8f2">luaM_reallocvector(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lineinfo,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelineinfo,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc,</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelineinfo</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #f8f8f2">luaM_reallocvector(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizek,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nk,TValue);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizek</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nk;</span>
<span style="color: #f8f8f2">luaM_reallocvector(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizep,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">np,Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizep</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">np;</span>
<span style="color: #f8f8f2">luaM_reallocvector(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">locvars,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelocvars,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nlocvars,LocVar);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizelocvars</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nlocvars;</span>
<span style="color: #f8f8f2">luaM_reallocvector(L,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvalues,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizeupvalues,f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizeupvalues</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">prev;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fs)anchor_token(ls);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaY_parser</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,ZIO</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">z,Mbuffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">buff,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name){</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LexState</span> <span style="color: #f8f8f2">lexstate;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">FuncState</span> <span style="color: #f8f8f2">funcstate;</span>
<span style="color: #f8f8f2">lexstate.buff</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">buff;</span>
<span style="color: #f8f8f2">luaX_setinput(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lexstate,z,luaS_new(L,name));</span>
<span style="color: #f8f8f2">open_func(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lexstate,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">funcstate);</span>
<span style="color: #f8f8f2">funcstate.f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">is_vararg</span><span style="color: #f92672">=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaX_next(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lexstate);</span>
<span style="color: #f8f8f2">chunk(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lexstate);</span>
<span style="color: #f8f8f2">check(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lexstate,TK_EOS);</span>
<span style="color: #f8f8f2">close_func(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lexstate);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">funcstate.f;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">field</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">key;</span>
<span style="color: #f8f8f2">luaK_exp2anyreg(fs,v);</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">checkname(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key);</span>
<span style="color: #f8f8f2">luaK_indexed(fs,v,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">yindex</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">expr(ls,v);</span>
<span style="color: #f8f8f2">luaK_exp2val(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,v);</span>
<span style="color: #f8f8f2">checknext(ls,</span><span style="color: #e6db74">&#39;]&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">ConsControl{</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">v;</span>
<span style="color: #f8f8f2">expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nh;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">na;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">tostore;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">recfield</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">ConsControl</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cc){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">reg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg;</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">key,val;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">rkkey;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">TK_NAME){</span>
<span style="color: #f8f8f2">luaY_checklimit(fs,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nh,(INT_MAX</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">),</span><span style="color: #e6db74">&quot;items in a constructor&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">checkname(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">yindex(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key);</span>
<span style="color: #f8f8f2">cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nh</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">checknext(ls,</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">rkkey</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_exp2RK(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key);</span>
<span style="color: #f8f8f2">expr(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">val);</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_SETTABLE,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,rkkey,luaK_exp2RK(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">val));</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">reg;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">closelistfield</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">ConsControl</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cc){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VVOID)</span><span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #f8f8f2">cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VVOID;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tostore</span><span style="color: #f92672">==</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">luaK_setlist(fs,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">na,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tostore);</span>
<span style="color: #f8f8f2">cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tostore</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lastlistfield</span><span style="color: #f8f8f2">(FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs,</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">ConsControl</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cc){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tostore</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(hasmultret(cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.k)){</span>
<span style="color: #f8f8f2">luaK_setmultret(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #f8f8f2">luaK_setlist(fs,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">na,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">na</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.k</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">VVOID)</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #f8f8f2">luaK_setlist(fs,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">na,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tostore);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">listfield</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">ConsControl</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cc){</span>
<span style="color: #f8f8f2">expr(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #f8f8f2">luaY_checklimit(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">na,(INT_MAX</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">),</span><span style="color: #e6db74">&quot;items in a constructor&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">na</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">cc</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tostore</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">constructor</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_codeABC(fs,OP_NEWTABLE,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">ConsControl</span> <span style="color: #f8f8f2">cc;</span>
<span style="color: #f8f8f2">cc.na</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cc.nh</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cc.tostore</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">cc.t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">t;</span>
<span style="color: #f8f8f2">init_exp(t,VRELOCABLE,pc);</span>
<span style="color: #f8f8f2">init_exp(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc.v,VVOID,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,t);</span>
<span style="color: #f8f8f2">checknext(ls,</span><span style="color: #e6db74">&#39;{&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;}&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">closelistfield(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_NAME</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaX_lookahead(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lookahead.token</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">listfield(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">recfield(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;[&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">recfield(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">listfield(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(testnext(ls,</span><span style="color: #e6db74">&#39;,&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">testnext(ls,</span><span style="color: #e6db74">&#39;;&#39;</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">check_match(ls,</span><span style="color: #e6db74">&#39;}&#39;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&#39;{&#39;</span><span style="color: #f8f8f2">,line);</span>
<span style="color: #f8f8f2">lastlistfield(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cc);</span>
<span style="color: #f8f8f2">SETARG_B(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code[pc],luaO_int2fb(cc.na));</span>
<span style="color: #f8f8f2">SETARG_C(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">code[pc],luaO_int2fb(cc.nh));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">parlist</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nparams</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">is_vararg</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;)&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_NAME</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">new_localvar(ls,str_checkname(ls),nparams</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_DOTS</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">is_vararg</span><span style="color: #f92672">|=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:luaX_syntaxerror(ls,</span><span style="color: #e6db74">&quot;&lt;name&gt; or &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;...&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; expected&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">is_vararg</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">testnext(ls,</span><span style="color: #e6db74">&#39;,&#39;</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">adjustlocalvars(ls,nparams);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">numparams</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_byte(fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">is_vararg</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">luaK_reserveregs(fs,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">body</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">needself,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line){</span>
<span style="color: #f8f8f2">FuncState</span> <span style="color: #f8f8f2">new_fs;</span>
<span style="color: #f8f8f2">open_func(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">new_fs);</span>
<span style="color: #f8f8f2">new_fs.f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linedefined</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">line;</span>
<span style="color: #f8f8f2">checknext(ls,</span><span style="color: #e6db74">&#39;(&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(needself){</span>
<span style="color: #f8f8f2">new_localvarliteral(ls,</span><span style="color: #e6db74">&quot;self&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">adjustlocalvars(ls,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">parlist(ls);</span>
<span style="color: #f8f8f2">checknext(ls,</span><span style="color: #e6db74">&#39;)&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">chunk(ls);</span>
<span style="color: #f8f8f2">new_fs.f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastlinedefined</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber;</span>
<span style="color: #f8f8f2">check_match(ls,TK_END,TK_FUNCTION,line);</span>
<span style="color: #f8f8f2">close_func(ls);</span>
<span style="color: #f8f8f2">pushclosure(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">new_fs,e);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">explist1</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">expr(ls,v);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(testnext(ls,</span><span style="color: #e6db74">&#39;,&#39;</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,v);</span>
<span style="color: #f8f8f2">expr(ls,v);</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">funcargs</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">args;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">base,nparams;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;(&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(line</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lastline)</span>
<span style="color: #f8f8f2">luaX_syntaxerror(ls,</span><span style="color: #e6db74">&quot;ambiguous syntax (function call x new statement)&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;)&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">args.k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VVOID;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">explist1(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">args);</span>
<span style="color: #f8f8f2">luaK_setmultret(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">args);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">check_match(ls,</span><span style="color: #e6db74">&#39;)&#39;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&#39;(&#39;</span><span style="color: #f8f8f2">,line);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;{&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">constructor(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">args);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_STRING</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">codestring(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">args,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.seminfo.ts);</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">luaX_syntaxerror(ls,</span><span style="color: #e6db74">&quot;function arguments expected&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(hasmultret(args.k))</span>
<span style="color: #f8f8f2">nparams</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(args.k</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">VVOID)</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">args);</span>
<span style="color: #f8f8f2">nparams</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">(base</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">init_exp(f,VCALL,luaK_codeABC(fs,OP_CALL,base,nparams</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">luaK_fixline(fs,line);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">prefixexp</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;(&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber;</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">expr(ls,v);</span>
<span style="color: #f8f8f2">check_match(ls,</span><span style="color: #e6db74">&#39;)&#39;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&#39;(&#39;</span><span style="color: #f8f8f2">,line);</span>
<span style="color: #f8f8f2">luaK_dischargevars(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,v);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_NAME</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">singlevar(ls,v);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">luaX_syntaxerror(ls,</span><span style="color: #e6db74">&quot;unexpected symbol&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">primaryexp</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">prefixexp(ls,v);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;;){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;.&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">field(ls,v);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;[&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">key;</span>
<span style="color: #f8f8f2">luaK_exp2anyreg(fs,v);</span>
<span style="color: #f8f8f2">yindex(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key);</span>
<span style="color: #f8f8f2">luaK_indexed(fs,v,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #960050; background-color: #1e0010">&#39;</span>:<span style="color: #960050; background-color: #1e0010">&#39;</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">key;</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">checkname(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key);</span>
<span style="color: #f8f8f2">luaK_self(fs,v,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key);</span>
<span style="color: #f8f8f2">funcargs(ls,v);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;(&#39;</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_STRING</span>:<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;{&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(fs,v);</span>
<span style="color: #f8f8f2">funcargs(ls,v);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">simpleexp</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_NUMBER</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">init_exp(v,VKNUM,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">v</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.nval</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.seminfo.r;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_STRING</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">codestring(ls,v,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.seminfo.ts);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_NIL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">init_exp(v,VNIL,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_TRUE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">init_exp(v,VTRUE,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_FALSE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">init_exp(v,VFALSE,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_DOTS</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">check_condition(ls,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">is_vararg,</span>
<span style="color: #e6db74">&quot;cannot use &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;...&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; outside a vararg function&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">is_vararg</span><span style="color: #f92672">&amp;=~</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">init_exp(v,VVARARG,luaK_codeABC(fs,OP_VARARG,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;{&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">constructor(ls,v);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_FUNCTION</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">body(ls,v,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">primaryexp(ls,v);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">UnOpr</span> <span style="color: #a6e22e">getunopr</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">op){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(op){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_NOT</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_NOT;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;-&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_MINUS;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;#&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_LEN;</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_NOUNOPR;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">BinOpr</span> <span style="color: #a6e22e">getbinopr</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">op){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(op){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;+&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_ADD;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;-&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_SUB;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;*&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_MUL;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;/&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_DIV;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;%&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_MOD;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;^&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_POW;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_CONCAT</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_CONCAT;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_NE</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_NE;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_EQ</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_EQ;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;&lt;&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_LT;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_LE</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_LE;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;&gt;&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_GT;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_GE</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_GE;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_AND</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_AND;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_OR</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_OR;</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">OPR_NOBINOPR;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">struct</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">left;</span>
<span style="color: #f8f8f2">lu_byte</span> <span style="color: #f8f8f2">right;</span>
<span style="color: #f8f8f2">}priority[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">{</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">},{</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">},{</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">},{</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">},{</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">},</span>
<span style="color: #f8f8f2">{</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">9</span><span style="color: #f8f8f2">},{</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">},</span>
<span style="color: #f8f8f2">{</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">},{</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">},</span>
<span style="color: #f8f8f2">{</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">},{</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">},{</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">},{</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">},</span>
<span style="color: #f8f8f2">{</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">},{</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">BinOpr</span> <span style="color: #a6e22e">subexpr</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v,</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">limit){</span>
<span style="color: #f8f8f2">BinOpr</span> <span style="color: #f8f8f2">op;</span>
<span style="color: #f8f8f2">UnOpr</span> <span style="color: #f8f8f2">uop;</span>
<span style="color: #f8f8f2">enterlevel(ls);</span>
<span style="color: #f8f8f2">uop</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getunopr(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(uop</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">OPR_NOUNOPR){</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">subexpr(ls,v,</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaK_prefix(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,uop,v);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">simpleexp(ls,v);</span>
<span style="color: #f8f8f2">op</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getbinopr(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(op</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">OPR_NOBINOPR</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">priority[op].left</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">limit){</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">v2;</span>
<span style="color: #f8f8f2">BinOpr</span> <span style="color: #f8f8f2">nextop;</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">luaK_infix(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,op,v);</span>
<span style="color: #f8f8f2">nextop</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">subexpr(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v2,priority[op].right);</span>
<span style="color: #f8f8f2">luaK_posfix(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,op,v,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v2);</span>
<span style="color: #f8f8f2">op</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nextop;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">leavelevel(ls);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">op;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">expr</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #f8f8f2">subexpr(ls,v,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">block_follow</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">token){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(token){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_ELSE</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_ELSEIF</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_END</span>:
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_UNTIL</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_EOS</span>:
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">block</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">BlockCnt</span> <span style="color: #f8f8f2">bl;</span>
<span style="color: #f8f8f2">enterblock(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">bl,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">chunk(ls);</span>
<span style="color: #f8f8f2">leaveblock(fs);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LHS_assign{</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LHS_assign</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">prev;</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">v;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">check_conflict</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LHS_assign</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lh,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">extra</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">conflict</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;lh;lh</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lh</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">prev){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lh</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VINDEXED){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lh</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.u.s.info</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info){</span>
<span style="color: #f8f8f2">conflict</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lh</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.u.s.info</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">extra;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lh</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.u.s.aux</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">v</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info){</span>
<span style="color: #f8f8f2">conflict</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lh</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.u.s.aux</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">extra;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(conflict){</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_MOVE,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg,v</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">u.s.info,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaK_reserveregs(fs,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">assignment</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LHS_assign</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lh,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nvars){</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">e;</span>
<span style="color: #f8f8f2">check_condition(ls,VLOCAL</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">lh</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.k</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">lh</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v.k</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">VINDEXED,</span>
<span style="color: #e6db74">&quot;syntax error&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(testnext(ls,</span><span style="color: #e6db74">&#39;,&#39;</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LHS_assign</span> <span style="color: #f8f8f2">nv;</span>
<span style="color: #f8f8f2">nv.prev</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lh;</span>
<span style="color: #f8f8f2">primaryexp(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">nv.v);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nv.v.k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VLOCAL)</span>
<span style="color: #f8f8f2">check_conflict(ls,lh,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">nv.v);</span>
<span style="color: #f8f8f2">luaY_checklimit(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,nvars,</span><span style="color: #ae81ff">200</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nCcalls,</span>
<span style="color: #e6db74">&quot;variables in assignment&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">assignment(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">nv,nvars</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nexps;</span>
<span style="color: #f8f8f2">checknext(ls,</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">nexps</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">explist1(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nexps</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">nvars){</span>
<span style="color: #f8f8f2">adjust_assign(ls,nvars,nexps,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nexps</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">nvars)</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">nexps</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">nvars;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_setoneret(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #f8f8f2">luaK_storevar(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lh</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">init_exp(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e,VNONRELOC,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaK_storevar(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lh</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">cond</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">v;</span>
<span style="color: #f8f8f2">expr(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(v.k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VNIL)v.k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VFALSE;</span>
<span style="color: #f8f8f2">luaK_goiftrue(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">v.f;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">breakstat</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">BlockCnt</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">bl;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">upval</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(bl</span><span style="color: #f92672">&amp;&amp;!</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">isbreakable){</span>
<span style="color: #f8f8f2">upval</span><span style="color: #f92672">|=</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upval;</span>
<span style="color: #f8f8f2">bl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">previous;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">bl)</span>
<span style="color: #f8f8f2">luaX_syntaxerror(ls,</span><span style="color: #e6db74">&quot;no loop to break&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(upval)</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_CLOSE,bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">bl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">breaklist,luaK_jump(fs));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">whilestat</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">whileinit;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">condexit;</span>
<span style="color: #f8f8f2">BlockCnt</span> <span style="color: #f8f8f2">bl;</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">whileinit</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_getlabel(fs);</span>
<span style="color: #f8f8f2">condexit</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cond(ls);</span>
<span style="color: #f8f8f2">enterblock(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">bl,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">checknext(ls,TK_DO);</span>
<span style="color: #f8f8f2">block(ls);</span>
<span style="color: #f8f8f2">luaK_patchlist(fs,luaK_jump(fs),whileinit);</span>
<span style="color: #f8f8f2">check_match(ls,TK_END,TK_WHILE,line);</span>
<span style="color: #f8f8f2">leaveblock(fs);</span>
<span style="color: #f8f8f2">luaK_patchtohere(fs,condexit);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">repeatstat</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">condexit;</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">repeat_init</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_getlabel(fs);</span>
<span style="color: #f8f8f2">BlockCnt</span> <span style="color: #f8f8f2">bl1,bl2;</span>
<span style="color: #f8f8f2">enterblock(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">bl1,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">enterblock(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">bl2,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">chunk(ls);</span>
<span style="color: #f8f8f2">check_match(ls,TK_UNTIL,TK_REPEAT,line);</span>
<span style="color: #f8f8f2">condexit</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cond(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">bl2.upval){</span>
<span style="color: #f8f8f2">leaveblock(fs);</span>
<span style="color: #f8f8f2">luaK_patchlist(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,condexit,repeat_init);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">breakstat(ls);</span>
<span style="color: #f8f8f2">luaK_patchtohere(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,condexit);</span>
<span style="color: #f8f8f2">leaveblock(fs);</span>
<span style="color: #f8f8f2">luaK_patchlist(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,luaK_jump(fs),repeat_init);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">leaveblock(fs);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">exp1</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">e;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">k;</span>
<span style="color: #f8f8f2">expr(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e.k;</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">k;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">forbody</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">base,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nvars,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">isnum){</span>
<span style="color: #f8f8f2">BlockCnt</span> <span style="color: #f8f8f2">bl;</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">prep,endfor;</span>
<span style="color: #f8f8f2">adjustlocalvars(ls,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">checknext(ls,TK_DO);</span>
<span style="color: #f8f8f2">prep</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">isnum</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">luaK_codeAsBx(fs,OP_FORPREP,base,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">luaK_jump(fs);</span>
<span style="color: #f8f8f2">enterblock(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">bl,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">adjustlocalvars(ls,nvars);</span>
<span style="color: #f8f8f2">luaK_reserveregs(fs,nvars);</span>
<span style="color: #f8f8f2">block(ls);</span>
<span style="color: #f8f8f2">leaveblock(fs);</span>
<span style="color: #f8f8f2">luaK_patchtohere(fs,prep);</span>
<span style="color: #f8f8f2">endfor</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(isnum)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">luaK_codeAsBx(fs,OP_FORLOOP,base,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">:</span>
<span style="color: #f8f8f2">luaK_codeABC(fs,OP_TFORLOOP,base,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,nvars);</span>
<span style="color: #f8f8f2">luaK_fixline(fs,line);</span>
<span style="color: #f8f8f2">luaK_patchlist(fs,(isnum</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">endfor</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">luaK_jump(fs)),prep</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">fornum</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">varname,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg;</span>
<span style="color: #f8f8f2">new_localvarliteral(ls,</span><span style="color: #e6db74">&quot;(for index)&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">new_localvarliteral(ls,</span><span style="color: #e6db74">&quot;(for limit)&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">new_localvarliteral(ls,</span><span style="color: #e6db74">&quot;(for step)&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">new_localvar(ls,varname,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">checknext(ls,</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">exp1(ls);</span>
<span style="color: #f8f8f2">checknext(ls,</span><span style="color: #e6db74">&#39;,&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">exp1(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(testnext(ls,</span><span style="color: #e6db74">&#39;,&#39;</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">exp1(ls);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_codeABx(fs,OP_LOADK,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg,luaK_numberK(fs,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">luaK_reserveregs(fs,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">forbody(ls,base,line,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">forlist</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">indexname){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">e;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nvars</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg;</span>
<span style="color: #f8f8f2">new_localvarliteral(ls,</span><span style="color: #e6db74">&quot;(for generator)&quot;</span><span style="color: #f8f8f2">,nvars</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">new_localvarliteral(ls,</span><span style="color: #e6db74">&quot;(for state)&quot;</span><span style="color: #f8f8f2">,nvars</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">new_localvarliteral(ls,</span><span style="color: #e6db74">&quot;(for control)&quot;</span><span style="color: #f8f8f2">,nvars</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">new_localvar(ls,indexname,nvars</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(testnext(ls,</span><span style="color: #e6db74">&#39;,&#39;</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">new_localvar(ls,str_checkname(ls),nvars</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">checknext(ls,TK_IN);</span>
<span style="color: #f8f8f2">line</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber;</span>
<span style="color: #f8f8f2">adjust_assign(ls,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,explist1(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e),</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #f8f8f2">luaK_checkstack(fs,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">forbody(ls,base,line,nvars</span><span style="color: #f92672">-</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">forstat</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">varname;</span>
<span style="color: #f8f8f2">BlockCnt</span> <span style="color: #f8f8f2">bl;</span>
<span style="color: #f8f8f2">enterblock(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">bl,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">varname</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">str_checkname(ls);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;=&#39;</span>:<span style="color: #f8f8f2">fornum(ls,varname,line);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;,&#39;</span>:<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_IN</span>:<span style="color: #f8f8f2">forlist(ls,varname);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:luaX_syntaxerror(ls,LUA_QL(</span><span style="color: #e6db74">&quot;=&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; or &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;in&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; expected&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">check_match(ls,TK_END,TK_FOR,line);</span>
<span style="color: #f8f8f2">leaveblock(fs);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">test_then_block</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">condexit;</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">condexit</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cond(ls);</span>
<span style="color: #f8f8f2">checknext(ls,TK_THEN);</span>
<span style="color: #f8f8f2">block(ls);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">condexit;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">ifstat</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">flist;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">escapelist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">flist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">test_then_block(ls);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">TK_ELSEIF){</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">escapelist,luaK_jump(fs));</span>
<span style="color: #f8f8f2">luaK_patchtohere(fs,flist);</span>
<span style="color: #f8f8f2">flist</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">test_then_block(ls);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">TK_ELSE){</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">escapelist,luaK_jump(fs));</span>
<span style="color: #f8f8f2">luaK_patchtohere(fs,flist);</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">block(ls);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">luaK_concat(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">escapelist,flist);</span>
<span style="color: #f8f8f2">luaK_patchtohere(fs,escapelist);</span>
<span style="color: #f8f8f2">check_match(ls,TK_END,TK_IF,line);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">localfunc</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">v,b;</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">new_localvar(ls,str_checkname(ls),</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">init_exp(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v,VLOCAL,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg);</span>
<span style="color: #f8f8f2">luaK_reserveregs(fs,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">adjustlocalvars(ls,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">body(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber);</span>
<span style="color: #f8f8f2">luaK_storevar(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #f8f8f2">getlocvar(fs,fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">).startpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">localstat</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nvars</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nexps;</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">e;</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">new_localvar(ls,str_checkname(ls),nvars</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(testnext(ls,</span><span style="color: #e6db74">&#39;,&#39;</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(testnext(ls,</span><span style="color: #e6db74">&#39;=&#39;</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">nexps</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">explist1(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">e.k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">VVOID;</span>
<span style="color: #f8f8f2">nexps</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">adjust_assign(ls,nvars,nexps,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #f8f8f2">adjustlocalvars(ls,nvars);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">funcname</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,expdesc</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">v){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">needself</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">singlevar(ls,v);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;.&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">field(ls,v);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;:&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">needself</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">field(ls,v);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">needself;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">funcstat</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">needself;</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">v,b;</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">needself</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">funcname(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #f8f8f2">body(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,needself,line);</span>
<span style="color: #f8f8f2">luaK_storevar(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #f8f8f2">luaK_fixline(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs,line);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">exprstat</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LHS_assign</span> <span style="color: #f8f8f2">v;</span>
<span style="color: #f8f8f2">primaryexp(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v.v);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(v.v.k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VCALL)</span>
<span style="color: #f8f8f2">SETARG_C(getcode(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v.v),</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">v.prev</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">assignment(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">v,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">retstat</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #f8f8f2">FuncState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs;</span>
<span style="color: #f8f8f2">expdesc</span> <span style="color: #f8f8f2">e;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">first,nret;</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(block_follow(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;;&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">first</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nret</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">nret</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">explist1(ls,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(hasmultret(e.k)){</span>
<span style="color: #f8f8f2">luaK_setmultret(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e.k</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">VCALL</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">nret</span><span style="color: #f92672">==</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">SET_OPCODE(getcode(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e),OP_TAILCALL);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">first</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar;</span>
<span style="color: #f8f8f2">nret</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nret</span><span style="color: #f92672">==</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">first</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaK_exp2anyreg(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaK_exp2nextreg(fs,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">e);</span>
<span style="color: #f8f8f2">first</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaK_ret(fs,first,nret);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">statement</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">line</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">linenumber;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_IF</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">ifstat(ls,line);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_WHILE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">whilestat(ls,line);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_DO</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">block(ls);</span>
<span style="color: #f8f8f2">check_match(ls,TK_END,TK_DO,line);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_FOR</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">forstat(ls,line);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_REPEAT</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">repeatstat(ls,line);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_FUNCTION</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">funcstat(ls,line);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_LOCAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(testnext(ls,TK_FUNCTION))</span>
<span style="color: #f8f8f2">localfunc(ls);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">localstat(ls);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_RETURN</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">retstat(ls);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TK_BREAK</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaX_next(ls);</span>
<span style="color: #f8f8f2">breakstat(ls);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">exprstat(ls);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">chunk</span><span style="color: #f8f8f2">(LexState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">islast</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">enterlevel(ls);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">islast</span><span style="color: #f92672">&amp;&amp;!</span><span style="color: #f8f8f2">block_follow(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">t.token)){</span>
<span style="color: #f8f8f2">islast</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">statement(ls);</span>
<span style="color: #f8f8f2">testnext(ls,</span><span style="color: #e6db74">&#39;;&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">freereg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nactvar;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">leavelevel(ls);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaV_tonumber</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">obj,TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">num;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnumber(obj))</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">obj;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisstring(obj)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">luaO_str2d(svalue(obj),</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">num)){</span>
<span style="color: #f8f8f2">setnvalue(n,num);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaV_tostring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">obj){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnumber(obj))</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">s[</span><span style="color: #ae81ff">32</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nvalue(obj);</span>
<span style="color: #f8f8f2">lua_number2str(s,n);</span>
<span style="color: #f8f8f2">setsvalue(L,obj,luaS_new(L,s));</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">callTMres</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">res,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f,</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p1,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p2){</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">result</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">savestack(L,res);</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,f);</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,p1);</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,p2);</span>
<span style="color: #f8f8f2">luaD_checkstack(L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+=</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaD_call(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">restorestack(L,result);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">setobj(L,res,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">callTM</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p1,</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p2,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p3){</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,f);</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,p1);</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,p2);</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,p3);</span>
<span style="color: #f8f8f2">luaD_checkstack(L,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+=</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaD_call(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaV_gettable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key,StkId</span> <span style="color: #f8f8f2">val){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">loop;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(loop</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;loop</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">100</span><span style="color: #f8f8f2">;loop</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttistable(t)){</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hvalue(t);</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_get(h,key);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(res)</span><span style="color: #f92672">||</span>
<span style="color: #f8f8f2">(tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fasttm(L,h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable,TM_INDEX))</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">setobj(L,val,res);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaT_gettmbyobj(L,t,TM_INDEX)))</span>
<span style="color: #f8f8f2">luaG_typeerror(L,t,</span><span style="color: #e6db74">&quot;index&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisfunction(tm)){</span>
<span style="color: #f8f8f2">callTMres(L,val,tm,t,key);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tm;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;loop in gettable&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaV_settable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t,TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">key,StkId</span> <span style="color: #f8f8f2">val){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">loop;</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">temp;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(loop</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;loop</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">100</span><span style="color: #f8f8f2">;loop</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttistable(t)){</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hvalue(t);</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">oldval</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_set(L,h,key);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(oldval)</span><span style="color: #f92672">||</span>
<span style="color: #f8f8f2">(tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fasttm(L,h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable,TM_NEWINDEX))</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">setobj(L,oldval,val);</span>
<span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">flags</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaC_barriert(L,h,val);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaT_gettmbyobj(L,t,TM_NEWINDEX)))</span>
<span style="color: #f8f8f2">luaG_typeerror(L,t,</span><span style="color: #e6db74">&quot;index&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisfunction(tm)){</span>
<span style="color: #f8f8f2">callTM(L,tm,t,key,val);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">setobj(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">temp,tm);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">temp;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;loop in settable&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">call_binTM</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p1,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p2,</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">res,TMS</span> <span style="color: #f8f8f2">event){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaT_gettmbyobj(L,p1,event);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(tm))</span>
<span style="color: #f8f8f2">tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaT_gettmbyobj(L,p2,event);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(tm))</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">callTMres(L,res,tm,p1,p2);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">get_compTM</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mt1,Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mt2,</span>
<span style="color: #f8f8f2">TMS</span> <span style="color: #f8f8f2">event){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fasttm(L,mt1,event);</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm2;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(tm1</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(mt1</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">mt2)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">tm1;</span>
<span style="color: #f8f8f2">tm2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fasttm(L,mt2,event);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(tm2</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaO_rawequalObj(tm1,tm2))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">tm1;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">call_orderTM</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p1,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p2,</span>
<span style="color: #f8f8f2">TMS</span> <span style="color: #f8f8f2">event){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaT_gettmbyobj(L,p1,event);</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm2;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(tm1))</span><span style="color: #66d9ef">return</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">tm2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaT_gettmbyobj(L,p2,event);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">luaO_rawequalObj(tm1,tm2))</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">callTMres(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,tm1,p1,p2);</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">l_isfalse(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">l_strcmp</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TString</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rs){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getstr(ls);</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">ll</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.len;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">r</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getstr(rs);</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">lr</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">rs</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tsv.len;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;;){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">temp</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strcoll(l,r);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(temp</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">temp;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strlen(l);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(len</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">lr)</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(len</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">ll)</span><span style="color: #f92672">?</span><span style="color: #ae81ff">0</span><span style="color: #f92672">:</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(len</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">ll)</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">len</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">l</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">len;ll</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">len;r</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">len;lr</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">len;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaV_lessthan</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">r){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttype(l)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">ttype(r))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaG_ordererror(L,l,r);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnumber(l))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luai_numlt(nvalue(l),nvalue(r));</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisstring(l))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">l_strcmp(rawtsvalue(l),rawtsvalue(r))</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">call_orderTM(L,l,r,TM_LT))</span><span style="color: #f92672">!=-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaG_ordererror(L,l,r);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lessequal</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">r){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttype(l)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">ttype(r))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaG_ordererror(L,l,r);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnumber(l))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luai_numle(nvalue(l),nvalue(r));</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisstring(l))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">l_strcmp(rawtsvalue(l),rawtsvalue(r))</span><span style="color: #f92672">&lt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">call_orderTM(L,l,r,TM_LE))</span><span style="color: #f92672">!=-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">call_orderTM(L,r,l,TM_LT))</span><span style="color: #f92672">!=-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaG_ordererror(L,l,r);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaV_equalval</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t1,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">t2){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tm;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(t1)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">0</span>:<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">3</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luai_numeq(nvalue(t1),nvalue(t2));</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">1</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">bvalue(t1)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">bvalue(t2);</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">2</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pvalue(t1)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">pvalue(t2);</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">7</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(uvalue(t1)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">uvalue(t2))</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">get_compTM(L,uvalue(t1)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable,uvalue(t2)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable,</span>
<span style="color: #f8f8f2">TM_EQ);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(hvalue(t1)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">hvalue(t2))</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">tm</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">get_compTM(L,hvalue(t1)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable,hvalue(t2)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable,TM_EQ);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">gcvalue(t1)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">gcvalue(t2);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(tm</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">callTMres(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,tm,t1,t2);</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">l_isfalse(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaV_concat</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">total,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">last){</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">last</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">(ttisstring(top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">ttisnumber(top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">||!</span><span style="color: #f8f8f2">tostring(L,top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">call_binTM(L,top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,TM_CONCAT))</span>
<span style="color: #f8f8f2">luaG_concaterror(L,top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(tsvalue(top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">len</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">)tostring(L,top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">tl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tsvalue(top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">len;</span>
<span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">buffer;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;n</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">total</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">tostring(L,top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);n</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tsvalue(top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">len;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">((</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)(</span><span style="color: #f92672">~</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">tl)luaG_runerror(L,</span><span style="color: #e6db74">&quot;string length overflow&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">tl</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">buffer</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaZ_openspace(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff,tl);</span>
<span style="color: #f8f8f2">tl</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">n;i</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tsvalue(top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">i)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">len;</span>
<span style="color: #f8f8f2">memcpy(buffer</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">tl,svalue(top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">i),l);</span>
<span style="color: #f8f8f2">tl</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">setsvalue(L,top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">n,luaS_newlstr(L,buffer,tl));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">total</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">last</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(total</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">Arith</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,StkId</span> <span style="color: #f8f8f2">ra,</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rb,</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rc,TMS</span> <span style="color: #f8f8f2">op){</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">tempb,tempc;</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">b,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">c;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaV_tonumber(rb,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">tempb))</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL</span><span style="color: #f92672">&amp;&amp;</span>
<span style="color: #f8f8f2">(c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaV_tonumber(rc,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">tempc))</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">nb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nvalue(b),nc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nvalue(c);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(op){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TM_ADD</span>:<span style="color: #f8f8f2">setnvalue(ra,luai_numadd(nb,nc));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TM_SUB</span>:<span style="color: #f8f8f2">setnvalue(ra,luai_numsub(nb,nc));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TM_MUL</span>:<span style="color: #f8f8f2">setnvalue(ra,luai_nummul(nb,nc));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TM_DIV</span>:<span style="color: #f8f8f2">setnvalue(ra,luai_numdiv(nb,nc));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TM_MOD</span>:<span style="color: #f8f8f2">setnvalue(ra,luai_nummod(nb,nc));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TM_POW</span>:<span style="color: #f8f8f2">setnvalue(ra,luai_numpow(nb,nc));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">TM_UNM</span>:<span style="color: #f8f8f2">setnvalue(ra,luai_numunm(nb));</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">call_binTM(L,rb,rc,ra,op))</span>
<span style="color: #f8f8f2">luaG_aritherror(L,rb,rc);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define runtime_check(L,c){if(!(c))break;}</span>
<span style="color: #75715e">#define RA(i)(base+GETARG_A(i))</span>
<span style="color: #75715e">#define RB(i)check_exp(getBMode(GET_OPCODE(i))==OpArgR,base+GETARG_B(i))</span>
<span style="color: #75715e">#define RKB(i)check_exp(getBMode(GET_OPCODE(i))==OpArgK,ISK(GETARG_B(i))?k+INDEXK(GETARG_B(i)):base+GETARG_B(i))</span>
<span style="color: #75715e">#define RKC(i)check_exp(getCMode(GET_OPCODE(i))==OpArgK,ISK(GETARG_C(i))?k+INDEXK(GETARG_C(i)):base+GETARG_C(i))</span>
<span style="color: #75715e">#define KBx(i)check_exp(getBMode(GET_OPCODE(i))==OpArgK,k+GETARG_Bx(i))</span>
<span style="color: #75715e">#define dojump(L,pc,i){(pc)+=(i);}</span>
<span style="color: #75715e">#define Protect(x){L-&gt;savedpc=pc;{x;};base=L-&gt;base;}</span>
<span style="color: #75715e">#define arith_op(op,tm){TValue*rb=RKB(i);TValue*rc=RKC(i);if(ttisnumber(rb)&amp;&amp;ttisnumber(rc)){lua_Number nb=nvalue(rb),nc=nvalue(rc);setnvalue(ra,op(nb,nc));}else Protect(Arith(L,ra,rb,rc,tm));}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaV_execute</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nexeccalls){</span>
<span style="color: #f8f8f2">LClosure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cl;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">base;</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">k;</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">Instruction</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #f8f8f2">reentry:</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc;</span>
<span style="color: #f8f8f2">cl</span><span style="color: #f92672">=&amp;</span><span style="color: #f8f8f2">clvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base;</span>
<span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">k;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;;){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">Instruction</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">ra;</span>
<span style="color: #f8f8f2">ra</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">RA(i);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(GET_OPCODE(i)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_MOVE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setobj(L,ra,RB(i));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_LOADK</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setobj(L,ra,KBx(i));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_LOADBOOL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setbvalue(ra,GETARG_B(i));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(GETARG_C(i))pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_LOADNIL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">RB(i);</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setnilvalue(rb</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(rb</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">ra);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_GETUPVAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_B(i);</span>
<span style="color: #f8f8f2">setobj(L,ra,cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvals[b]</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_GETGLOBAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">g;</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">KBx(i);</span>
<span style="color: #f8f8f2">sethvalue(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g,cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">env);</span>
<span style="color: #f8f8f2">Protect(luaV_gettable(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g,rb,ra));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_GETTABLE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Protect(luaV_gettable(L,RB(i),RKC(i),ra));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_SETGLOBAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">g;</span>
<span style="color: #f8f8f2">sethvalue(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g,cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">env);</span>
<span style="color: #f8f8f2">Protect(luaV_settable(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">g,KBx(i),ra));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_SETUPVAL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">UpVal</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">uv</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvals[GETARG_B(i)];</span>
<span style="color: #f8f8f2">setobj(L,uv</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">v,ra);</span>
<span style="color: #f8f8f2">luaC_barrier(L,uv,ra);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_SETTABLE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Protect(luaV_settable(L,ra,RKB(i),RKC(i)));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_NEWTABLE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_B(i);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_C(i);</span>
<span style="color: #f8f8f2">sethvalue(L,ra,luaH_new(L,luaO_fb2int(b),luaO_fb2int(c)));</span>
<span style="color: #f8f8f2">Protect(luaC_checkGC(L));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_SELF</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">rb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">RB(i);</span>
<span style="color: #f8f8f2">setobj(L,ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,rb);</span>
<span style="color: #f8f8f2">Protect(luaV_gettable(L,rb,RKC(i),ra));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_ADD</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">arith_op(luai_numadd,TM_ADD);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_SUB</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">arith_op(luai_numsub,TM_SUB);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_MUL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">arith_op(luai_nummul,TM_MUL);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_DIV</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">arith_op(luai_numdiv,TM_DIV);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_MOD</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">arith_op(luai_nummod,TM_MOD);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_POW</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">arith_op(luai_numpow,TM_POW);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_UNM</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">RB(i);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnumber(rb)){</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">nb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nvalue(rb);</span>
<span style="color: #f8f8f2">setnvalue(ra,luai_numunm(nb));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Protect(Arith(L,ra,rb,rb,TM_UNM));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_NOT</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l_isfalse(RB(i));</span>
<span style="color: #f8f8f2">setbvalue(ra,res);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_LEN</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">RB(i);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(rb)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setnvalue(ra,cast_num(luaH_getn(hvalue(rb))));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">4</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setnvalue(ra,cast_num(tsvalue(rb)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">len));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">Protect(</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">call_binTM(L,rb,(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_),ra,TM_LEN))</span>
<span style="color: #f8f8f2">luaG_typeerror(L,rb,</span><span style="color: #e6db74">&quot;get length of&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_CONCAT</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_B(i);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_C(i);</span>
<span style="color: #f8f8f2">Protect(luaV_concat(L,c</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">b</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,c);luaC_checkGC(L));</span>
<span style="color: #f8f8f2">setobj(L,RA(i),base</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_JMP</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">dojump(L,pc,GETARG_sBx(i));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_EQ</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">RKB(i);</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">RKC(i);</span>
<span style="color: #f8f8f2">Protect(</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(equalobj(L,rb,rc)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">GETARG_A(i))</span>
<span style="color: #f8f8f2">dojump(L,pc,GETARG_sBx(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc));</span>
<span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_LT</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Protect(</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaV_lessthan(L,RKB(i),RKC(i))</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">GETARG_A(i))</span>
<span style="color: #f8f8f2">dojump(L,pc,GETARG_sBx(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc));</span>
<span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_LE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Protect(</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lessequal(L,RKB(i),RKC(i))</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">GETARG_A(i))</span>
<span style="color: #f8f8f2">dojump(L,pc,GETARG_sBx(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc));</span>
<span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_TEST</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l_isfalse(ra)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">GETARG_C(i))</span>
<span style="color: #f8f8f2">dojump(L,pc,GETARG_sBx(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc));</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_TESTSET</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">RB(i);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l_isfalse(rb)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">GETARG_C(i)){</span>
<span style="color: #f8f8f2">setobj(L,ra,rb);</span>
<span style="color: #f8f8f2">dojump(L,pc,GETARG_sBx(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_CALL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_B(i);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nresults</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_C(i)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(b</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ra</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">b;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(luaD_precall(L,ra,nresults)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">0</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">nexeccalls</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">reentry;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">1</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nresults</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;</span>
<span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base;</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_TAILCALL</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_B(i);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(b</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ra</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">b;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(luaD_precall(L,ra,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">0</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">aux;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">pfunc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(ci</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">openupval)luaF_close(L,ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">((ci</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">pfunc);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(aux</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;pfunc</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">aux</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;aux</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">setobj(L,func</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">aux,pfunc</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">aux);</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">aux;</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc;</span>
<span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">tailcalls</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">reentry;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">1</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base;</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_RETURN</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_B(i);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(b</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ra</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">b</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">openupval)luaF_close(L,base);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaD_poscall(L,ra);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">nexeccalls</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(b)L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;</span>
<span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">reentry;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_FORLOOP</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">step</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nvalue(ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">idx</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luai_numadd(nvalue(ra),step);</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">limit</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nvalue(ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luai_numlt(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,step)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">luai_numle(idx,limit)</span>
<span style="color: #f92672">:</span><span style="color: #f8f8f2">luai_numle(limit,idx)){</span>
<span style="color: #f8f8f2">dojump(L,pc,GETARG_sBx(i));</span>
<span style="color: #f8f8f2">setnvalue(ra,idx);</span>
<span style="color: #f8f8f2">setnvalue(ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,idx);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_FORPREP</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">init</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ra;</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">plimit</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pstep</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">savedpc</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">pc;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">tonumber(init,ra))</span>
<span style="color: #f8f8f2">luaG_runerror(L,LUA_QL(</span><span style="color: #e6db74">&quot;for&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; initial value must be a number&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">tonumber(plimit,ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaG_runerror(L,LUA_QL(</span><span style="color: #e6db74">&quot;for&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; limit must be a number&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">tonumber(pstep,ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaG_runerror(L,LUA_QL(</span><span style="color: #e6db74">&quot;for&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; step must be a number&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">setnvalue(ra,luai_numsub(nvalue(ra),nvalue(pstep)));</span>
<span style="color: #f8f8f2">dojump(L,pc,GETARG_sBx(i));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_TFORLOOP</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">cb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">setobj(L,cb</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">setobj(L,cb</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,ra</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">setobj(L,cb,ra);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cb</span><span style="color: #f92672">+</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">Protect(luaD_call(L,cb,GETARG_C(i)));</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;</span>
<span style="color: #f8f8f2">cb</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">RA(i)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisnil(cb)){</span>
<span style="color: #f8f8f2">setobj(L,cb</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,cb);</span>
<span style="color: #f8f8f2">dojump(L,pc,GETARG_sBx(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_SETLIST</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_B(i);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_C(i);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">last;</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">h;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_int(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">ra)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(c</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_int(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">runtime_check(L,ttistable(ra));</span>
<span style="color: #f8f8f2">h</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hvalue(ra);</span>
<span style="color: #f8f8f2">last</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">((c</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">*</span><span style="color: #ae81ff">50</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(last</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">sizearray)</span>
<span style="color: #f8f8f2">luaH_resizearray(L,h,last);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;n</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;n</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">val</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ra</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">setobj(L,luaH_setnum(L,h,last</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">),val);</span>
<span style="color: #f8f8f2">luaC_barriert(L,h,val);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_CLOSE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaF_close(L,ra);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_CLOSURE</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Proto</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ncl;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nup,j;</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p[GETARG_Bx(i)];</span>
<span style="color: #f8f8f2">nup</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nups;</span>
<span style="color: #f8f8f2">ncl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaF_newLclosure(L,nup,cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">env);</span>
<span style="color: #f8f8f2">ncl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">p;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(j</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;j</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">nup;j</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">,pc</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(GET_OPCODE(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">OP_GETUPVAL)</span>
<span style="color: #f8f8f2">ncl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.upvals[j]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">upvals[GETARG_B(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc)];</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">ncl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">l.upvals[j]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaF_findupval(L,base</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">GETARG_B(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pc));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">setclvalue(L,ra,ncl);</span>
<span style="color: #f8f8f2">Protect(luaC_checkGC(L));</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">OP_VARARG</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">GETARG_B(i)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">j;</span>
<span style="color: #f8f8f2">CallInfo</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast_int(ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func)</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">numparams</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(b</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">Protect(luaD_checkstack(L,n));</span>
<span style="color: #f8f8f2">ra</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">RA(i);</span>
<span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ra</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(j</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;j</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">b;j</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(j</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">setobj(L,ra</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">j,ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">j);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setnilvalue(ra</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">j);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define api_checknelems(L,n)luai_apicheck(L,(n)&lt;=(L-&gt;top-L-&gt;base))</span>
<span style="color: #75715e">#define api_checkvalidindex(L,i)luai_apicheck(L,(i)!=(&amp;luaO_nilobject_))</span>
<span style="color: #75715e">#define api_incr_top(L){luai_apicheck(L,L-&gt;top&lt;L-&gt;ci-&gt;top);L-&gt;top++;}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #a6e22e">index2adr</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(idx</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">(idx</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luai_apicheck(L,idx</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(o</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">cast(TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_));</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(idx</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10000</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">luai_apicheck(L,idx</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;-</span><span style="color: #f8f8f2">idx</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">idx;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(idx){</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10000</span><span style="color: #f8f8f2">)</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">registry(L);</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10001</span><span style="color: #f8f8f2">)</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr_func(L);</span>
<span style="color: #f8f8f2">sethvalue(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">env,func</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.env);</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">env;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10002</span><span style="color: #f8f8f2">)</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">gt(L);</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr_func(L);</span>
<span style="color: #f8f8f2">idx</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10002</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">idx;</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(idx</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.nupvalues)</span>
<span style="color: #f92672">?&amp;</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.upvalue[idx</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]</span>
<span style="color: #f92672">:</span><span style="color: #f8f8f2">cast(TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #a6e22e">getcurrenv</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">hvalue(gt(L));</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr_func(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">func</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.env;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_checkstack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">size){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(size</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">8000</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">size)</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">8000</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(size</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">luaD_checkstack(L,size);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">size)</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">size;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_CFunction</span> <span style="color: #a6e22e">lua_atpanic</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_CFunction</span> <span style="color: #f8f8f2">panicf){</span>
<span style="color: #f8f8f2">lua_CFunction</span> <span style="color: #f8f8f2">old;</span>
<span style="color: #f8f8f2">old</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">panic;</span>
<span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">panic</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">panicf;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">old;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_gettop</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">cast_int(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_settop</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(idx</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">luai_apicheck(L,idx</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">stack_last</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">idx)</span>
<span style="color: #f8f8f2">setnilvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">idx;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luai_apicheck(L,</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">(idx</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base));</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">idx</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_remove</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,p);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top)setobj(L,p</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,p);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_insert</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">q;</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,p);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(q</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top;q</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">p;q</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)setobj(L,q,q</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">setobj(L,p,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_replace</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(idx</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10001</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">ci</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base_ci)</span>
<span style="color: #f8f8f2">luaG_runerror(L,</span><span style="color: #e6db74">&quot;no calling environment&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">api_checknelems(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,o);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(idx</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10001</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">curr_func(L);</span>
<span style="color: #f8f8f2">luai_apicheck(L,ttistable(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">func</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.env</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaC_barrier(L,func,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">setobj(L,o,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(idx</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10002</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaC_barrier(L,curr_func(L),L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_pushvalue</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,index2adr(L,idx));</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_type</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(o</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_))</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">ttype(o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">lua_typename</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">t){</span>
<span style="color: #f8f8f2">UNUSED(L);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(t</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">?</span><span style="color: #e6db74">&quot;no value&quot;</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">luaT_typenames[t];</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_iscfunction</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">iscfunction(o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_isnumber</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">tonumber(o,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">n);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_isstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_type(L,idx);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(t</span><span style="color: #f92672">==</span><span style="color: #ae81ff">4</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">==</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_rawequal</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">index1,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">index2){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,index1);</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,index2);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(o1</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">o2</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_))</span><span style="color: #f92672">?</span><span style="color: #ae81ff">0</span>
<span style="color: #f92672">:</span><span style="color: #f8f8f2">luaO_rawequalObj(o1,o2);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_lessthan</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">index1,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">index2){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o1,o2;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">o1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,index1);</span>
<span style="color: #f8f8f2">o2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,index2);</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(o1</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">o2</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">luaO_nilobject_))</span><span style="color: #f92672">?</span><span style="color: #ae81ff">0</span>
<span style="color: #f92672">:</span><span style="color: #f8f8f2">luaV_lessthan(L,o1,o2);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_Number</span> <span style="color: #a6e22e">lua_tonumber</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(tonumber(o,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">n))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">nvalue(o);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_Integer</span> <span style="color: #a6e22e">lua_tointeger</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(tonumber(o,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">n)){</span>
<span style="color: #f8f8f2">lua_Integer</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">num</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nvalue(o);</span>
<span style="color: #f8f8f2">lua_number2integer(res,num);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_toboolean</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">l_isfalse(o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">lua_tolstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx,</span><span style="color: #66d9ef">size_t</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">len){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">ttisstring(o)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">luaV_tostring(L,o)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(len</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">len</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(len</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL)</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tsvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">len;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">svalue(o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">size_t</span> <span style="color: #a6e22e">lua_objlen</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(o)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">4</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">tsvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">len;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">7</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">uvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">len;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaH_getn(hvalue(o));</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">3</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(luaV_tostring(L,o)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">tsvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">len</span><span style="color: #f92672">:</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_CFunction</span> <span style="color: #a6e22e">lua_tocfunction</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">iscfunction(o))</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">NULL</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">clvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.f;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #a6e22e">lua_touserdata</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(o)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">7</span>:<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(rawuvalue(o)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">2</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pvalue(o);</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_pushnil</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">setnilvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top);</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_pushnumber</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_Number</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">setnvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,n);</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_pushinteger</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_Integer</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">setnvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,cast_num(n));</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_pushlstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">len){</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">setsvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,luaS_newlstr(L,s,len));</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_pushstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(s</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">lua_pushlstring(L,s,strlen(s));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">lua_pushvfstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fmt,</span>
<span style="color: #66d9ef">va_list</span> <span style="color: #f8f8f2">argp){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ret;</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">ret</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaO_pushvfstring(L,fmt,argp);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">ret;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">lua_pushfstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fmt,...){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ret;</span>
<span style="color: #66d9ef">va_list</span> <span style="color: #f8f8f2">argp;</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">va_start(argp,fmt);</span>
<span style="color: #f8f8f2">ret</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaO_pushvfstring(L,fmt,argp);</span>
<span style="color: #f8f8f2">va_end(argp);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">ret;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_pushcclosure</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_CFunction</span> <span style="color: #f8f8f2">fn,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">Closure</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">cl;</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">api_checknelems(L,n);</span>
<span style="color: #f8f8f2">cl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaF_newCclosure(L,n,getcurrenv(L));</span>
<span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fn;</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">n;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">setobj(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">cl</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.upvalue[n],L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n);</span>
<span style="color: #f8f8f2">setclvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,cl);</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_pushboolean</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b){</span>
<span style="color: #f8f8f2">setbvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,(b</span><span style="color: #f92672">!=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_pushthread</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">setthvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,L);</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mainthread</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_gettable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">t;</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,t);</span>
<span style="color: #f8f8f2">luaV_gettable(L,t,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_getfield</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">k){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">t;</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">key;</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,t);</span>
<span style="color: #f8f8f2">setsvalue(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key,luaS_new(L,k));</span>
<span style="color: #f8f8f2">luaV_gettable(L,t,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top);</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_rawget</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">t;</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">luai_apicheck(L,ttistable(t));</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,luaH_get(hvalue(t),L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_rawgeti</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">luai_apicheck(L,ttistable(o));</span>
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,luaH_getnum(hvalue(o),n));</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_createtable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narray,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nrec){</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">sethvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,luaH_new(L,narray,nrec));</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_getmetatable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">objindex){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">obj;</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">obj</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,objindex);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(obj)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:
<span style="color: #f8f8f2">mt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hvalue(obj)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">7</span>:
<span style="color: #f8f8f2">mt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">uvalue(obj)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:</span>
<span style="color: #f8f8f2">mt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mt[ttype(obj)];</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(mt</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">sethvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,mt);</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_getfenv</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,o);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(o)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">6</span>:
<span style="color: #f8f8f2">sethvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,clvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.env);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">7</span>:
<span style="color: #f8f8f2">sethvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,uvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">env);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">8</span>:
<span style="color: #f8f8f2">setobj(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,gt(thvalue(o)));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:</span>
<span style="color: #f8f8f2">setnilvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_settable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">t;</span>
<span style="color: #f8f8f2">api_checknelems(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,t);</span>
<span style="color: #f8f8f2">luaV_settable(L,t,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_setfield</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">k){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">t;</span>
<span style="color: #f8f8f2">TValue</span> <span style="color: #f8f8f2">key;</span>
<span style="color: #f8f8f2">api_checknelems(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,t);</span>
<span style="color: #f8f8f2">setsvalue(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key,luaS_new(L,k));</span>
<span style="color: #f8f8f2">luaV_settable(L,t,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">key,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_rawset</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">t;</span>
<span style="color: #f8f8f2">api_checknelems(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">luai_apicheck(L,ttistable(t));</span>
<span style="color: #f8f8f2">setobj(L,luaH_set(L,hvalue(t),L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">),L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaC_barriert(L,hvalue(t),L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_rawseti</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o;</span>
<span style="color: #f8f8f2">api_checknelems(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">luai_apicheck(L,ttistable(o));</span>
<span style="color: #f8f8f2">setobj(L,luaH_setnum(L,hvalue(o),n),L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaC_barriert(L,hvalue(o),L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_setmetatable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">objindex){</span>
<span style="color: #f8f8f2">TValue</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">obj;</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mt;</span>
<span style="color: #f8f8f2">api_checknelems(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">obj</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,objindex);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,obj);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ttisnil(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">mt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luai_apicheck(L,ttistable(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">mt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(obj)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">hvalue(obj)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">mt;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(mt)</span>
<span style="color: #f8f8f2">luaC_objbarriert(L,hvalue(obj),mt);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">7</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">uvalue(obj)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">metatable</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">mt;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(mt)</span>
<span style="color: #f8f8f2">luaC_objbarrier(L,rawuvalue(obj),mt);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">G(L)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">mt[ttype(obj)]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">mt;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_setfenv</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">api_checknelems(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,o);</span>
<span style="color: #f8f8f2">luai_apicheck(L,ttistable(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(ttype(o)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">6</span>:
<span style="color: #f8f8f2">clvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">c.env</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">7</span>:
<span style="color: #f8f8f2">uvalue(o)</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">env</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">8</span>:
<span style="color: #f8f8f2">sethvalue(L,gt(thvalue(o)),hvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:</span>
<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(res)luaC_objbarrier(L,gcvalue(o),hvalue(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define adjustresults(L,nres){if(nres==(-1)&amp;&amp;L-&gt;top&gt;=L-&gt;ci-&gt;top)L-&gt;ci-&gt;top=L-&gt;top;}</span>
<span style="color: #75715e">#define checkresults(L,na,nr)luai_apicheck(L,(nr)==(-1)||(L-&gt;ci-&gt;top-L-&gt;top&gt;=(nr)-(na)))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_call</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nargs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nresults){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">func;</span>
<span style="color: #f8f8f2">api_checknelems(L,nargs</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">checkresults(L,nargs,nresults);</span>
<span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">(nargs</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaD_call(L,func,nresults);</span>
<span style="color: #f8f8f2">adjustresults(L,nresults);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">CallS{</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">func;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nresults;</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">f_call</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud){</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">CallS</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cast(</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">CallS</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">,ud);</span>
<span style="color: #f8f8f2">luaD_call(L,c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func,c</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">nresults);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_pcall</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nargs,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nresults,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">errfunc){</span>
<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">CallS</span> <span style="color: #f8f8f2">c;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">func;</span>
<span style="color: #f8f8f2">api_checknelems(L,nargs</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">checkresults(L,nargs,nresults);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(errfunc</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">o</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,errfunc);</span>
<span style="color: #f8f8f2">api_checkvalidindex(L,o);</span>
<span style="color: #f8f8f2">func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">savestack(L,o);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">c.func</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">(nargs</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">c.nresults</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">nresults;</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaD_pcall(L,f_call,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">c,savestack(L,c.func),func);</span>
<span style="color: #f8f8f2">adjustresults(L,nresults);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_load</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_Reader</span> <span style="color: #f8f8f2">reader,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">data,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">chunkname){</span>
<span style="color: #f8f8f2">ZIO</span> <span style="color: #f8f8f2">z;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">chunkname)chunkname</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;?&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaZ_init(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">z,reader,data);</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaD_protectedparser(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">z,chunkname);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_error</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">api_checknelems(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaG_errormsg(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lua_next</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #f8f8f2">StkId</span> <span style="color: #f8f8f2">t;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">more;</span>
<span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">index2adr(L,idx);</span>
<span style="color: #f8f8f2">luai_apicheck(L,ttistable(t));</span>
<span style="color: #f8f8f2">more</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaH_next(L,hvalue(t),L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(more){</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">more;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">lua_concat</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #f8f8f2">api_checknelems(L,n);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">luaV_concat(L,n,cast_int(L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">base)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">setsvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,luaS_newlstr(L,</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #a6e22e">lua_newuserdata</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">size){</span>
<span style="color: #f8f8f2">Udata</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">u;</span>
<span style="color: #f8f8f2">luaC_checkGC(L);</span>
<span style="color: #f8f8f2">u</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaS_newudata(L,size,getcurrenv(L));</span>
<span style="color: #f8f8f2">setuvalue(L,L</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">top,u);</span>
<span style="color: #f8f8f2">api_incr_top(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">u</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define luaL_getn(L,i)((int)lua_objlen(L,i))</span>
<span style="color: #75715e">#define luaL_setn(L,i,j)((void)0)</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">luaL_Reg{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name;</span>
<span style="color: #f8f8f2">lua_CFunction</span> <span style="color: #f8f8f2">func;</span>
<span style="color: #f8f8f2">}luaL_Reg;</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaI_openlib</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">libname,</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nup);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaL_argerror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">numarg,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">extramsg);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span> <span style="color: #a6e22e">luaL_checklstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">numArg,</span>
<span style="color: #66d9ef">size_t</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span> <span style="color: #a6e22e">luaL_optlstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">numArg,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">def,</span><span style="color: #66d9ef">size_t</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l);</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_Integer</span> <span style="color: #a6e22e">luaL_checkinteger</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">numArg);</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_Integer</span> <span style="color: #a6e22e">luaL_optinteger</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nArg,</span>
<span style="color: #f8f8f2">lua_Integer</span> <span style="color: #f8f8f2">def);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaL_error</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fmt,...);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span> <span style="color: #a6e22e">luaL_findtable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fname,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">szhint);</span>
<span style="color: #75715e">#define luaL_argcheck(L,cond,numarg,extramsg)((void)((cond)||luaL_argerror(L,(numarg),(extramsg))))</span>
<span style="color: #75715e">#define luaL_checkstring(L,n)(luaL_checklstring(L,(n),NULL))</span>
<span style="color: #75715e">#define luaL_optstring(L,n,d)(luaL_optlstring(L,(n),(d),NULL))</span>
<span style="color: #75715e">#define luaL_checkint(L,n)((int)luaL_checkinteger(L,(n)))</span>
<span style="color: #75715e">#define luaL_optint(L,n,d)((int)luaL_optinteger(L,(n),(d)))</span>
<span style="color: #75715e">#define luaL_typename(L,i)lua_typename(L,lua_type(L,(i)))</span>
<span style="color: #75715e">#define luaL_getmetatable(L,n)(lua_getfield(L,(-10000),(n)))</span>
<span style="color: #75715e">#define luaL_opt(L,f,n,d)(lua_isnoneornil(L,(n))?(d):f(L,(n)))</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">luaL_Buffer{</span>
<span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">lvl;</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L;</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buffer[BUFSIZ];</span>
<span style="color: #f8f8f2">}luaL_Buffer;</span>
<span style="color: #75715e">#define luaL_addchar(B,c)((void)((B)-&gt;p&lt;((B)-&gt;buffer+BUFSIZ)||luaL_prepbuffer(B)),(*(B)-&gt;p++=(char)(c)))</span>
<span style="color: #75715e">#define luaL_addsize(B,n)((B)-&gt;p+=(n))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span> <span style="color: #a6e22e">luaL_prepbuffer</span><span style="color: #f8f8f2">(luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">B);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaL_argerror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narg,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">extramsg){</span>
<span style="color: #f8f8f2">lua_Debug</span> <span style="color: #f8f8f2">ar;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_getstack(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ar))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;bad argument #%d (%s)&quot;</span><span style="color: #f8f8f2">,narg,extramsg);</span>
<span style="color: #f8f8f2">lua_getinfo(L,</span><span style="color: #e6db74">&quot;n&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ar);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(strcmp(ar.namewhat,</span><span style="color: #e6db74">&quot;method&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">narg</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(narg</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;calling &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; on bad self (%s)&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">ar.name,extramsg);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ar.name</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">ar.name</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;?&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;bad argument #%d to &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; (%s)&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">narg,ar.name,extramsg);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaL_typerror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narg,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tname){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">msg</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_pushfstring(L,</span><span style="color: #e6db74">&quot;%s expected, got %s&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">tname,luaL_typename(L,narg));</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_argerror(L,narg,msg);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">tag_error</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narg,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">tag){</span>
<span style="color: #f8f8f2">luaL_typerror(L,narg,lua_typename(L,tag));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaL_where</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">level){</span>
<span style="color: #f8f8f2">lua_Debug</span> <span style="color: #f8f8f2">ar;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_getstack(L,level,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ar)){</span>
<span style="color: #f8f8f2">lua_getinfo(L,</span><span style="color: #e6db74">&quot;Sl&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ar);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ar.currentline</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_pushfstring(L,</span><span style="color: #e6db74">&quot;%s:%d: &quot;</span><span style="color: #f8f8f2">,ar.short_src,ar.currentline);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_pushliteral(L,</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaL_error</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fmt,...){</span>
<span style="color: #66d9ef">va_list</span> <span style="color: #f8f8f2">argp;</span>
<span style="color: #f8f8f2">va_start(argp,fmt);</span>
<span style="color: #f8f8f2">luaL_where(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvfstring(L,fmt,argp);</span>
<span style="color: #f8f8f2">va_end(argp);</span>
<span style="color: #f8f8f2">lua_concat(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">lua_error(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaL_newmetatable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tname){</span>
<span style="color: #f8f8f2">lua_getfield(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10000</span><span style="color: #f8f8f2">),tname);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_isnil(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_newtable(L);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setfield(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10000</span><span style="color: #f8f8f2">),tname);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaL_checkudata</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">ud,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">tname){</span>
<span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_touserdata(L,ud);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_getmetatable(L,ud)){</span>
<span style="color: #f8f8f2">lua_getfield(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10000</span><span style="color: #f8f8f2">),tname);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_rawequal(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaL_typerror(L,ud,tname);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaL_checkstack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">space,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mes){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_checkstack(L,space))</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;stack overflow (%s)&quot;</span><span style="color: #f8f8f2">,mes);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaL_checktype</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narg,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">t){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_type(L,narg)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">t)</span>
<span style="color: #f8f8f2">tag_error(L,narg,t);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaL_checkany</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narg){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_type(L,narg)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaL_argerror(L,narg,</span><span style="color: #e6db74">&quot;value expected&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaL_checklstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narg,</span><span style="color: #66d9ef">size_t</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">len){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tolstring(L,narg,len);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">s)tag_error(L,narg,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">s;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaL_optlstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narg,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">def,</span><span style="color: #66d9ef">size_t</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">len){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isnoneornil(L,narg)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(len)</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(def</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">strlen(def)</span><span style="color: #f92672">:</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">def;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_checklstring(L,narg,len);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_Number</span> <span style="color: #a6e22e">luaL_checknumber</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narg){</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">d</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tonumber(L,narg);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(d</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;!</span><span style="color: #f8f8f2">lua_isnumber(L,narg))</span>
<span style="color: #f8f8f2">tag_error(L,narg,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">d;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_Integer</span> <span style="color: #a6e22e">luaL_checkinteger</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narg){</span>
<span style="color: #f8f8f2">lua_Integer</span> <span style="color: #f8f8f2">d</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tointeger(L,narg);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(d</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;!</span><span style="color: #f8f8f2">lua_isnumber(L,narg))</span>
<span style="color: #f8f8f2">tag_error(L,narg,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">d;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_Integer</span> <span style="color: #a6e22e">luaL_optinteger</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">narg,</span>
<span style="color: #f8f8f2">lua_Integer</span> <span style="color: #f8f8f2">def){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_opt(L,luaL_checkinteger,narg,def);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaL_getmetafield</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">obj,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">event){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_getmetatable(L,obj))</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lua_pushstring(L,event);</span>
<span style="color: #f8f8f2">lua_rawget(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isnil(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_remove(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaL_register</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">libname,</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l){</span>
<span style="color: #f8f8f2">luaI_openlib(L,libname,l,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">libsize</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">size</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;l</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">name;l</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)size</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">size;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaI_openlib</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">libname,</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">l,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nup){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(libname){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">libsize(l);</span>
<span style="color: #f8f8f2">luaL_findtable(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10000</span><span style="color: #f8f8f2">),</span><span style="color: #e6db74">&quot;_LOADED&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_getfield(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,libname);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_istable(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaL_findtable(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10002</span><span style="color: #f8f8f2">),libname,size)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;name conflict for module &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">),libname);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setfield(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,libname);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_remove(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_insert(L,</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">(nup</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;l</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">name;l</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">nup;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">nup);</span>
<span style="color: #f8f8f2">lua_pushcclosure(L,l</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func,nup);</span>
<span style="color: #f8f8f2">lua_setfield(L,</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">(nup</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">),l</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">name);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_pop(L,nup);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaL_findtable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fname,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">szhint){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e;</span>
<span style="color: #f8f8f2">lua_pushvalue(L,idx);</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strchr(fname,</span><span style="color: #e6db74">&#39;.&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fname</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">strlen(fname);</span>
<span style="color: #f8f8f2">lua_pushlstring(L,fname,e</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">fname);</span>
<span style="color: #f8f8f2">lua_rawget(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isnil(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_createtable(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;.&#39;</span><span style="color: #f92672">?</span><span style="color: #ae81ff">1</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">szhint));</span>
<span style="color: #f8f8f2">lua_pushlstring(L,fname,e</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">fname);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_settable(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_istable(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">fname;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_remove(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">fname</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;.&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define bufflen(B)((B)-&gt;p-(B)-&gt;buffer)</span>
<span style="color: #75715e">#define bufffree(B)((size_t)(BUFSIZ-bufflen(B)))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">emptybuffer</span><span style="color: #f8f8f2">(luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">B){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">bufflen(B);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_pushlstring(B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buffer,l);</span>
<span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buffer;</span>
<span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lvl</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">adjuststack</span><span style="color: #f8f8f2">(luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">B){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lvl</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">toget</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">toplen</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_strlen(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_strlen(L,</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">(toget</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lvl</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">toget</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">20</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">toplen</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">l){</span>
<span style="color: #f8f8f2">toplen</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">toget</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(toget</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lvl);</span>
<span style="color: #f8f8f2">lua_concat(L,toget);</span>
<span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lvl</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lvl</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">toget</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaL_prepbuffer</span><span style="color: #f8f8f2">(luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">B){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(emptybuffer(B))</span>
<span style="color: #f8f8f2">adjuststack(B);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buffer;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaL_addlstring</span><span style="color: #f8f8f2">(luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">B,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l){</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_addchar(B,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaL_pushresult</span><span style="color: #f8f8f2">(luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">B){</span>
<span style="color: #f8f8f2">emptybuffer(B);</span>
<span style="color: #f8f8f2">lua_concat(B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lvl);</span>
<span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lvl</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaL_addvalue</span><span style="color: #f8f8f2">(luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">B){</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">vl;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tolstring(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">vl);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(vl</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">bufffree(B)){</span>
<span style="color: #f8f8f2">memcpy(B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p,s,vl);</span>
<span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">vl;</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(emptybuffer(B))</span>
<span style="color: #f8f8f2">lua_insert(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lvl</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">adjuststack(B);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaL_buffinit</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">B){</span>
<span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buffer;</span>
<span style="color: #f8f8f2">B</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">lvl</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LoadF{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">extraline;</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f;</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buff[BUFSIZ];</span>
<span style="color: #f8f8f2">}LoadF;</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">getF</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud,</span><span style="color: #66d9ef">size_t</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">size){</span>
<span style="color: #f8f8f2">LoadF</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lf</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(LoadF</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)ud;</span>
<span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">)L;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lf</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">extraline){</span>
<span style="color: #f8f8f2">lf</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">extraline</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span><span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(feof(lf</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f))</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fread(lf</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(lf</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff),lf</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">f);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">lf</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">buff</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">errfile</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">what,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">fnameindex){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">serr</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strerror(errno);</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">filename</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tostring(L,fnameindex)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lua_pushfstring(L,</span><span style="color: #e6db74">&quot;cannot %s %s: %s&quot;</span><span style="color: #f8f8f2">,what,filename,serr);</span>
<span style="color: #f8f8f2">lua_remove(L,fnameindex);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">5</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaL_loadfile</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">filename){</span>
<span style="color: #f8f8f2">LoadF</span> <span style="color: #f8f8f2">lf;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status,readstatus;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">fnameindex</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_gettop(L)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lf.extraline</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(filename</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">lua_pushliteral(L,</span><span style="color: #e6db74">&quot;=stdin&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lf.f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">stdin;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_pushfstring(L,</span><span style="color: #e6db74">&quot;@%s&quot;</span><span style="color: #f8f8f2">,filename);</span>
<span style="color: #f8f8f2">lf.f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fopen(filename,</span><span style="color: #e6db74">&quot;r&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lf.f</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">errfile(L,</span><span style="color: #e6db74">&quot;open&quot;</span><span style="color: #f8f8f2">,fnameindex);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getc(lf.f);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(c</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;#&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lf.extraline</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">((c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getc(lf.f))</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">EOF</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">c</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;\n&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(c</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;\n&#39;</span><span style="color: #f8f8f2">)c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getc(lf.f);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(c</span><span style="color: #f92672">==</span><span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\033</span><span style="color: #e6db74">Lua&quot;</span><span style="color: #f8f8f2">[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">filename){</span>
<span style="color: #f8f8f2">lf.f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">freopen(filename,</span><span style="color: #e6db74">&quot;rb&quot;</span><span style="color: #f8f8f2">,lf.f);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lf.f</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">errfile(L,</span><span style="color: #e6db74">&quot;reopen&quot;</span><span style="color: #f8f8f2">,fnameindex);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">((c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getc(lf.f))</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">EOF</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">c</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\033</span><span style="color: #e6db74">Lua&quot;</span><span style="color: #f8f8f2">[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]);</span>
<span style="color: #f8f8f2">lf.extraline</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">ungetc(c,lf.f);</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_load(L,getF,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lf,lua_tostring(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">readstatus</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ferror(lf.f);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(filename)fclose(lf.f);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(readstatus){</span>
<span style="color: #f8f8f2">lua_settop(L,fnameindex);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">errfile(L,</span><span style="color: #e6db74">&quot;read&quot;</span><span style="color: #f8f8f2">,fnameindex);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_remove(L,fnameindex);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">LoadS{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">size;</span>
<span style="color: #f8f8f2">}LoadS;</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">getS</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud,</span><span style="color: #66d9ef">size_t</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">size){</span>
<span style="color: #f8f8f2">LoadS</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(LoadS</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)ud;</span>
<span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">)L;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size;</span>
<span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">size</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">ls</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">s;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaL_loadbuffer</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">buff,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">size,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name){</span>
<span style="color: #f8f8f2">LoadS</span> <span style="color: #f8f8f2">ls;</span>
<span style="color: #f8f8f2">ls.s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">buff;</span>
<span style="color: #f8f8f2">ls.size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">size;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">lua_load(L,getS,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ls,name);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #a6e22e">l_alloc</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud,</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ptr,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">osize,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">nsize){</span>
<span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">)ud;</span>
<span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">)osize;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nsize</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">free(ptr);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">realloc(ptr,nsize);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">panic</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">)L;</span>
<span style="color: #f8f8f2">fprintf(stderr,</span><span style="color: #e6db74">&quot;PANIC: unprotected error in call to Lua API (%s)</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">lua_tostring(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #a6e22e">luaL_newstate</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_newstate(l_alloc,NULL);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(L)lua_atpanic(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">panic);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_tonumber</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">base</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_optint(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(base</span><span style="color: #f92672">==</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">luaL_checkany(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isnumber(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">lua_pushnumber(L,lua_tonumber(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checkstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s2;</span>
<span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">long</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">luaL_argcheck(L,</span><span style="color: #ae81ff">2</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">base</span><span style="color: #f92672">&lt;=</span><span style="color: #ae81ff">36</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;base out of range&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strtoul(s1,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">s2,base);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(s1</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">s2){</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(isspace((</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">char</span><span style="color: #f8f8f2">)(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s2)))s2</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s2</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_pushnumber(L,(lua_Number)n);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_error</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">level</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_optint(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_settop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">level</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">luaL_where(L,level);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_concat(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">lua_error(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_setmetatable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">t</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_type(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_checktype(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_argcheck(L,t</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">t</span><span style="color: #f92672">==</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;nil or table expected&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaL_getmetafield(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__metatable&quot;</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;cannot change a protected metatable&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_settop(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setmetatable(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">getfunc</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">opt){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isfunction(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))lua_pushvalue(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_Debug</span> <span style="color: #f8f8f2">ar;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">level</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">opt</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">luaL_optint(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">luaL_checkint(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_argcheck(L,level</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;level must be non-negative&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_getstack(L,level,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ar)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_argerror(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;invalid level&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_getinfo(L,</span><span style="color: #e6db74">&quot;f&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ar);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isnil(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;no function environment for tail call at level %d&quot;</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">level);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_setfenv</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_checktype(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">getfunc(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isnumber(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">lua_tonumber(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_pushthread(L);</span>
<span style="color: #f8f8f2">lua_insert(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setfenv(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_iscfunction(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">lua_setfenv(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_error(L,</span>
<span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;setfenv&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; cannot change environment of given object&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_rawget</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_checktype(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_checkany(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_settop(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_rawget(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_type</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_checkany(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushstring(L,luaL_typename(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_next</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_checktype(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_settop(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_next(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_pairs</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_checktype(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,lua_upvalueindex(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">ipairsaux</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checkint(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_checktype(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lua_pushinteger(L,i);</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(lua_isnil(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">?</span><span style="color: #ae81ff">0</span><span style="color: #f92672">:</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_ipairs</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_checktype(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,lua_upvalueindex(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushinteger(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">load_aux</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(status</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #f8f8f2">lua_insert(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_loadstring</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l);</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">chunkname</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_optstring(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,s);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">load_aux(L,luaL_loadbuffer(L,s,l,chunkname));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_loadfile</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fname</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_optstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,NULL);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">load_aux(L,luaL_loadfile(L,fname));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_assert</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_checkany(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_toboolean(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">,luaL_optstring(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;assertion failed!&quot;</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">lua_gettop(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_unpack</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i,e,n;</span>
<span style="color: #f8f8f2">luaL_checktype(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_optint(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_opt(L,luaL_checkint,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,luaL_getn(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">e)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">&lt;=</span><span style="color: #ae81ff">0</span><span style="color: #f92672">||!</span><span style="color: #f8f8f2">lua_checkstack(L,n))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;too many results to unpack&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">++&lt;</span><span style="color: #f8f8f2">e)</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_pcall</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status;</span>
<span style="color: #f8f8f2">luaL_checkany(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_pcall(L,lua_gettop(L)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushboolean(L,(status</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">lua_insert(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">lua_gettop(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaB_newproxy</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">lua_settop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_newuserdata(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_toboolean(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isboolean(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">lua_newtable(L);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushboolean(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_rawset(L,lua_upvalueindex(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">validproxy</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_getmetatable(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">lua_rawget(L,lua_upvalueindex(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">validproxy</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_toboolean(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaL_argcheck(L,validproxy,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;boolean or proxy expected&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_getmetatable(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_setmetatable(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span> <span style="color: #f8f8f2">base_funcs[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;assert&quot;</span><span style="color: #f8f8f2">,luaB_assert},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;error&quot;</span><span style="color: #f8f8f2">,luaB_error},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;loadfile&quot;</span><span style="color: #f8f8f2">,luaB_loadfile},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;loadstring&quot;</span><span style="color: #f8f8f2">,luaB_loadstring},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;next&quot;</span><span style="color: #f8f8f2">,luaB_next},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;pcall&quot;</span><span style="color: #f8f8f2">,luaB_pcall},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;rawget&quot;</span><span style="color: #f8f8f2">,luaB_rawget},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;setfenv&quot;</span><span style="color: #f8f8f2">,luaB_setfenv},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;setmetatable&quot;</span><span style="color: #f8f8f2">,luaB_setmetatable},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;tonumber&quot;</span><span style="color: #f8f8f2">,luaB_tonumber},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;type&quot;</span><span style="color: #f8f8f2">,luaB_type},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;unpack&quot;</span><span style="color: #f8f8f2">,luaB_unpack},</span>
<span style="color: #f8f8f2">{NULL,NULL}</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">auxopen</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">name,</span>
<span style="color: #f8f8f2">lua_CFunction</span> <span style="color: #f8f8f2">f,lua_CFunction</span> <span style="color: #f8f8f2">u){</span>
<span style="color: #f8f8f2">lua_pushcfunction(L,u);</span>
<span style="color: #f8f8f2">lua_pushcclosure(L,f,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setfield(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,name);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">base_open</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">lua_pushvalue(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10002</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">lua_setglobal(L,</span><span style="color: #e6db74">&quot;_G&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_register(L,</span><span style="color: #e6db74">&quot;_G&quot;</span><span style="color: #f8f8f2">,base_funcs);</span>
<span style="color: #f8f8f2">lua_pushliteral(L,</span><span style="color: #e6db74">&quot;Lua 5.1&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setglobal(L,</span><span style="color: #e6db74">&quot;_VERSION&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">auxopen(L,</span><span style="color: #e6db74">&quot;ipairs&quot;</span><span style="color: #f8f8f2">,luaB_ipairs,ipairsaux);</span>
<span style="color: #f8f8f2">auxopen(L,</span><span style="color: #e6db74">&quot;pairs&quot;</span><span style="color: #f8f8f2">,luaB_pairs,luaB_next);</span>
<span style="color: #f8f8f2">lua_createtable(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setmetatable(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushliteral(L,</span><span style="color: #e6db74">&quot;kv&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setfield(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__mode&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushcclosure(L,luaB_newproxy,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setglobal(L,</span><span style="color: #e6db74">&quot;newproxy&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaopen_base</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">base_open(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define aux_getn(L,n)(luaL_checktype(L,n,5),luaL_getn(L,n))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">tinsert</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">aux_getn(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pos;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(lua_gettop(L)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">2</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">pos</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">3</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">pos</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checkint(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(pos</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">e)e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">pos;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e;i</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">pos;i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_rawseti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;wrong number of arguments to &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;insert&quot;</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaL_setn(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,e);</span>
<span style="color: #f8f8f2">lua_rawseti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,pos);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">tremove</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">aux_getn(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pos</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_optint(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,e);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">1</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">pos</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">pos</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">e))</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">luaL_setn(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,e</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,pos);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;pos</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">e;pos</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,pos</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_rawseti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,pos);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #f8f8f2">lua_rawseti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,e);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">addfield</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">b,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i){</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_isstring(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;invalid value (%s) at index %d in table for &quot;</span>
<span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;concat&quot;</span><span style="color: #f8f8f2">),luaL_typename(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),i);</span>
<span style="color: #f8f8f2">luaL_addvalue(b);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">tconcat</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_Buffer</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">lsep;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i,last;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">sep</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_optlstring(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">lsep);</span>
<span style="color: #f8f8f2">luaL_checktype(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_optint(L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">last</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_opt(L,luaL_checkint,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,luaL_getn(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">luaL_buffinit(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">last;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">addfield(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,i);</span>
<span style="color: #f8f8f2">luaL_addlstring(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,sep,lsep);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">last)</span>
<span style="color: #f8f8f2">addfield(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,i);</span>
<span style="color: #f8f8f2">luaL_pushresult(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">set2</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">j){</span>
<span style="color: #f8f8f2">lua_rawseti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i);</span>
<span style="color: #f8f8f2">lua_rawseti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,j);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">sort_comp</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">a,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_isnil(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,a</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,b</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_call(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_toboolean(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">lua_lessthan(L,a,b);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">auxsort</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">l,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">u){</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">u){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i,j;</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,l);</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,u);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(sort_comp(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">set2(L,l,u);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(u</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">==</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">u)</span><span style="color: #f92672">/</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i);</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,l);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(sort_comp(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">set2(L,i,l);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,u);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(sort_comp(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">set2(L,i,u);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(u</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">==</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,u</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">set2(L,i,u</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l;j</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">u</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;;){</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">i),sort_comp(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">u)luaL_error(L,</span><span style="color: #e6db74">&quot;invalid order function for sorting&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">j),sort_comp(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(j</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">l)luaL_error(L,</span><span style="color: #e6db74">&quot;invalid order function for sorting&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(j</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">i){</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">set2(L,i,j);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,u</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_rawgeti(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i);</span>
<span style="color: #f8f8f2">set2(L,u</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,i);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">u</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">i){</span>
<span style="color: #f8f8f2">j</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l;i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">j</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">u;u</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">j</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">auxsort(L,j,i);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">sort</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">aux_getn(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_checkstack(L,</span><span style="color: #ae81ff">40</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_isnoneornil(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaL_checktype(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">6</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_settop(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">auxsort(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,n);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span> <span style="color: #f8f8f2">tab_funcs[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;concat&quot;</span><span style="color: #f8f8f2">,tconcat},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;insert&quot;</span><span style="color: #f8f8f2">,tinsert},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;remove&quot;</span><span style="color: #f8f8f2">,tremove},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;sort&quot;</span><span style="color: #f8f8f2">,sort},</span>
<span style="color: #f8f8f2">{NULL,NULL}</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaopen_table</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_register(L,</span><span style="color: #e6db74">&quot;table&quot;</span><span style="color: #f8f8f2">,tab_funcs);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">fnames[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;input&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;output&quot;</span><span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">pushresult</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">filename){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">en</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">errno;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(i){</span>
<span style="color: #f8f8f2">lua_pushboolean(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(filename)</span>
<span style="color: #f8f8f2">lua_pushfstring(L,</span><span style="color: #e6db74">&quot;%s: %s&quot;</span><span style="color: #f8f8f2">,filename,strerror(en));</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">lua_pushfstring(L,</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">,strerror(en));</span>
<span style="color: #f8f8f2">lua_pushinteger(L,en);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">fileerror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">arg,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">filename){</span>
<span style="color: #f8f8f2">lua_pushfstring(L,</span><span style="color: #e6db74">&quot;%s: %s&quot;</span><span style="color: #f8f8f2">,filename,strerror(errno));</span>
<span style="color: #f8f8f2">luaL_argerror(L,arg,lua_tostring(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define tofilep(L)((FILE**)luaL_checkudata(L,1,&quot;FILE*&quot;))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_type</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ud;</span>
<span style="color: #f8f8f2">luaL_checkany(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">ud</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_touserdata(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_getfield(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10000</span><span style="color: #f8f8f2">),</span><span style="color: #e6db74">&quot;FILE*&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ud</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL</span><span style="color: #f92672">||!</span><span style="color: #f8f8f2">lua_getmetatable(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">||!</span><span style="color: #f8f8f2">lua_rawequal(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">((</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">)ud)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">lua_pushliteral(L,</span><span style="color: #e6db74">&quot;closed file&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">lua_pushliteral(L,</span><span style="color: #e6db74">&quot;file&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #a6e22e">tofile</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tofilep(L);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;attempt to use a closed file&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #a6e22e">newfile</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">)lua_newuserdata(L,</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">));</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">luaL_getmetatable(L,</span><span style="color: #e6db74">&quot;FILE*&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setmetatable(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pf;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_noclose</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #f8f8f2">lua_pushliteral(L,</span><span style="color: #e6db74">&quot;cannot close standard file&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_pclose</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tofilep(L);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">ok</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_pclose(L,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p);</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pushresult(L,ok,NULL);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_fclose</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">tofilep(L);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">ok</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(fclose(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pushresult(L,ok,NULL);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">aux_close</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">lua_getfenv(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_getfield(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__close&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(lua_tocfunction(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_close</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isnone(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">lua_rawgeti(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10001</span><span style="color: #f8f8f2">),</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">tofile(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">aux_close(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_gc</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">tofilep(L);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">aux_close(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_open</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">filename</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checkstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mode</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_optstring(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;r&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">newfile(L);</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fopen(filename,mode);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">pushresult(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,filename)</span><span style="color: #f92672">:</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #a6e22e">getiofile</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">findex){</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">lua_rawgeti(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10001</span><span style="color: #f8f8f2">),findex);</span>
<span style="color: #f8f8f2">f</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">)lua_touserdata(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;standard %s file is closed&quot;</span><span style="color: #f8f8f2">,fnames[findex</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">f;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">g_iofile</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">f,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">mode){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_isnoneornil(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">filename</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tostring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(filename){</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">newfile(L);</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fopen(filename,mode);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">fileerror(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,filename);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">tofile(L);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_rawseti(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10001</span><span style="color: #f8f8f2">),f);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_rawgeti(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10001</span><span style="color: #f8f8f2">),f);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_input</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">g_iofile(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;r&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_output</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">g_iofile(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;w&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_readline</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">aux_lines</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">toclose){</span>
<span style="color: #f8f8f2">lua_pushvalue(L,idx);</span>
<span style="color: #f8f8f2">lua_pushboolean(L,toclose);</span>
<span style="color: #f8f8f2">lua_pushcclosure(L,io_readline,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">f_lines</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">tofile(L);</span>
<span style="color: #f8f8f2">aux_lines(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_lines</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_isnoneornil(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">lua_rawgeti(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10001</span><span style="color: #f8f8f2">),</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">f_lines(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">filename</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checkstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">newfile(L);</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fopen(filename,</span><span style="color: #e6db74">&quot;r&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">pf</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">fileerror(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,filename);</span>
<span style="color: #f8f8f2">aux_lines(L,lua_gettop(L),</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">read_number</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f){</span>
<span style="color: #f8f8f2">lua_Number</span> <span style="color: #f8f8f2">d;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fscanf(f,</span><span style="color: #e6db74">&quot;%lf&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">d)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_pushnumber(L,d);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">test_eof</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">getc(f);</span>
<span style="color: #f8f8f2">ungetc(c,f);</span>
<span style="color: #f8f8f2">lua_pushlstring(L,NULL,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(c</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">EOF);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">read_line</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f){</span>
<span style="color: #f8f8f2">luaL_Buffer</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #f8f8f2">luaL_buffinit(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;;){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_prepbuffer(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fgets(p,BUFSIZ,f)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">luaL_pushresult(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(lua_objlen(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strlen(p);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">p[l</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;\n&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_addsize(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,l);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaL_addsize(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,l</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_pushresult(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">read_chars</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">n){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">rlen;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">nr;</span>
<span style="color: #f8f8f2">luaL_Buffer</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #f8f8f2">luaL_buffinit(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #f8f8f2">rlen</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">BUFSIZ;</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_prepbuffer(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(rlen</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">n)rlen</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">nr</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">fread(p,</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">char</span><span style="color: #f8f8f2">),rlen,f);</span>
<span style="color: #f8f8f2">luaL_addsize(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,nr);</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">nr;</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">nr</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">rlen);</span>
<span style="color: #f8f8f2">luaL_pushresult(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">lua_objlen(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">g_read</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">first){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nargs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_gettop(L)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">success;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">clearerr(f);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(nargs</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">success</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">read_line(L,f);</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">first</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaL_checkstack(L,nargs</span><span style="color: #f92672">+</span><span style="color: #ae81ff">20</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;too many arguments&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">success</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">first;nargs</span><span style="color: #f92672">--&amp;&amp;</span><span style="color: #f8f8f2">success;n</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_type(L,n)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)lua_tointeger(L,n);</span>
<span style="color: #f8f8f2">success</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">test_eof(L,f)</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">read_chars(L,f,l);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tostring(L,n);</span>
<span style="color: #f8f8f2">luaL_argcheck(L,p</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">p[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;*&#39;</span><span style="color: #f8f8f2">,n,</span><span style="color: #e6db74">&quot;invalid option&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(p[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;n&#39;</span>:
<span style="color: #f8f8f2">success</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">read_number(L,f);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;l&#39;</span>:
<span style="color: #f8f8f2">success</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">read_line(L,f);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;a&#39;</span>:
<span style="color: #f8f8f2">read_chars(L,f,</span><span style="color: #f92672">~</span><span style="color: #f8f8f2">((</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">success</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_argerror(L,n,</span><span style="color: #e6db74">&quot;invalid format&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ferror(f))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pushresult(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,NULL);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">success){</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">first;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_read</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">g_read(L,getiofile(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">f_read</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">g_read(L,tofile(L),</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_readline</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">)lua_touserdata(L,lua_upvalueindex(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sucess;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(f</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;file is already closed&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">sucess</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">read_line(L,f);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ferror(f))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;%s&quot;</span><span style="color: #f8f8f2">,strerror(errno));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(sucess)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_toboolean(L,lua_upvalueindex(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))){</span>
<span style="color: #f8f8f2">lua_settop(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,lua_upvalueindex(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">aux_close(L);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">g_write</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">arg){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nargs</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_gettop(L)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;nargs</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;arg</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_type(L,arg)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">status</span><span style="color: #f92672">&amp;&amp;</span>
<span style="color: #f8f8f2">fprintf(f,</span><span style="color: #e6db74">&quot;%.14g&quot;</span><span style="color: #f8f8f2">,lua_tonumber(L,arg))</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,arg,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l);</span>
<span style="color: #f8f8f2">status</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">status</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">(fwrite(s,</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">char</span><span style="color: #f8f8f2">),l,f)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">l);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pushresult(L,status,NULL);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_write</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">g_write(L,getiofile(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">),</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">f_write</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">g_write(L,tofile(L),</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">io_flush</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pushresult(L,fflush(getiofile(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,NULL);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">f_flush</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">pushresult(L,fflush(tofile(L))</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,NULL);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span> <span style="color: #f8f8f2">iolib[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;close&quot;</span><span style="color: #f8f8f2">,io_close},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;flush&quot;</span><span style="color: #f8f8f2">,io_flush},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;input&quot;</span><span style="color: #f8f8f2">,io_input},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;lines&quot;</span><span style="color: #f8f8f2">,io_lines},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;open&quot;</span><span style="color: #f8f8f2">,io_open},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;output&quot;</span><span style="color: #f8f8f2">,io_output},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;read&quot;</span><span style="color: #f8f8f2">,io_read},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;type&quot;</span><span style="color: #f8f8f2">,io_type},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;write&quot;</span><span style="color: #f8f8f2">,io_write},</span>
<span style="color: #f8f8f2">{NULL,NULL}</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span> <span style="color: #f8f8f2">flib[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;close&quot;</span><span style="color: #f8f8f2">,io_close},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;flush&quot;</span><span style="color: #f8f8f2">,f_flush},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;lines&quot;</span><span style="color: #f8f8f2">,f_lines},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;read&quot;</span><span style="color: #f8f8f2">,f_read},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;write&quot;</span><span style="color: #f8f8f2">,f_write},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;__gc&quot;</span><span style="color: #f8f8f2">,io_gc},</span>
<span style="color: #f8f8f2">{NULL,NULL}</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">createmeta</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_newmetatable(L,</span><span style="color: #e6db74">&quot;FILE*&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setfield(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__index&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_register(L,NULL,flib);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">createstdfile</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">FILE</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">f,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">k,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fname){</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">newfile(L)</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">f;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(k</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_rawseti(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10001</span><span style="color: #f8f8f2">),k);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setfenv(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setfield(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,fname);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">newfenv</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,lua_CFunction</span> <span style="color: #f8f8f2">cls){</span>
<span style="color: #f8f8f2">lua_createtable(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushcfunction(L,cls);</span>
<span style="color: #f8f8f2">lua_setfield(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__close&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaopen_io</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">createmeta(L);</span>
<span style="color: #f8f8f2">newfenv(L,io_fclose);</span>
<span style="color: #f8f8f2">lua_replace(L,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">10001</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">luaL_register(L,</span><span style="color: #e6db74">&quot;io&quot;</span><span style="color: #f8f8f2">,iolib);</span>
<span style="color: #f8f8f2">newfenv(L,io_noclose);</span>
<span style="color: #f8f8f2">createstdfile(L,stdin,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;stdin&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">createstdfile(L,stdout,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;stdout&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">createstdfile(L,stderr,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;stderr&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_getfield(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;popen&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">newfenv(L,io_pclose);</span>
<span style="color: #f8f8f2">lua_setfenv(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">os_pushresult</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">filename){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">en</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">errno;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(i){</span>
<span style="color: #f8f8f2">lua_pushboolean(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #f8f8f2">lua_pushfstring(L,</span><span style="color: #e6db74">&quot;%s: %s&quot;</span><span style="color: #f8f8f2">,filename,strerror(en));</span>
<span style="color: #f8f8f2">lua_pushinteger(L,en);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">os_remove</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">filename</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checkstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">os_pushresult(L,remove(filename)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,filename);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">os_exit</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">exit(luaL_optint(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,EXIT_SUCCESS));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span> <span style="color: #f8f8f2">syslib[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;exit&quot;</span><span style="color: #f8f8f2">,os_exit},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;remove&quot;</span><span style="color: #f8f8f2">,os_remove},</span>
<span style="color: #f8f8f2">{NULL,NULL}</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaopen_os</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_register(L,</span><span style="color: #e6db74">&quot;os&quot;</span><span style="color: #f8f8f2">,syslib);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define uchar(c)((unsigned char)(c))</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #a6e22e">posrelat</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">pos,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">len){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(pos</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)pos</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">ptrdiff_t</span><span style="color: #f8f8f2">)len</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(pos</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">pos</span><span style="color: #f92672">:</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_sub</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l);</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">start</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">posrelat(luaL_checkinteger(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">),l);</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">end</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">posrelat(luaL_optinteger(L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),l);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(start</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)start</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(end</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">ptrdiff_t</span><span style="color: #f8f8f2">)l)end</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">ptrdiff_t</span><span style="color: #f8f8f2">)l;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(start</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">end)</span>
<span style="color: #f8f8f2">lua_pushlstring(L,s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">start</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,end</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">start</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">lua_pushliteral(L,</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_lower</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">luaL_Buffer</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l);</span>
<span style="color: #f8f8f2">luaL_buffinit(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">l;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_addchar(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,tolower(uchar(s[i])));</span>
<span style="color: #f8f8f2">luaL_pushresult(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_upper</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">luaL_Buffer</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l);</span>
<span style="color: #f8f8f2">luaL_buffinit(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">l;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_addchar(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,toupper(uchar(s[i])));</span>
<span style="color: #f8f8f2">luaL_pushresult(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_rep</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">luaL_Buffer</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checkint(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_buffinit(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">--&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_addlstring(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,s,l);</span>
<span style="color: #f8f8f2">luaL_pushresult(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_byte</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l);</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">posi</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">posrelat(luaL_optinteger(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),l);</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">pose</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">posrelat(luaL_optinteger(L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,posi),l);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n,i;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(posi</span><span style="color: #f92672">&lt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)posi</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)pose</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">l)pose</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(posi</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">pose)</span><span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">)(pose</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">posi</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(posi</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">n</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">pose)</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;string slice too long&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_checkstack(L,n,</span><span style="color: #e6db74">&quot;string slice too long&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">n;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">lua_pushinteger(L,uchar(s[posi</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]));</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_char</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_gettop(L);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">luaL_Buffer</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #f8f8f2">luaL_buffinit(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">n;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checkint(L,i);</span>
<span style="color: #f8f8f2">luaL_argcheck(L,uchar(c)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">c,i,</span><span style="color: #e6db74">&quot;invalid value&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_addchar(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,uchar(c));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaL_pushresult(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">MatchState{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">src_init;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">src_end;</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">level;</span>
<span style="color: #66d9ef">struct</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">init;</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">len;</span>
<span style="color: #f8f8f2">}capture[</span><span style="color: #ae81ff">32</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">}MatchState;</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">check_capture</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">l){</span>
<span style="color: #f8f8f2">l</span><span style="color: #f92672">-=</span><span style="color: #e6db74">&#39;1&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">0</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">level</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[l].len</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_error(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;invalid capture index&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">capture_to_close</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">level</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">level;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(level</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;level</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;level</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[level].len</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">level;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_error(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;invalid pattern capture&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">classend</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;%&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_error(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;malformed pattern (ends with &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;%%&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot;)&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;[&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;^&#39;</span><span style="color: #f8f8f2">)p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_error(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;malformed pattern (missing &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;]&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot;)&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;%&#39;</span><span style="color: #f92672">&amp;&amp;*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;]&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">match_class</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">cl){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(tolower(cl)){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;a&#39;</span>:<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">isalpha(c);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;c&#39;</span>:<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">iscntrl(c);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;d&#39;</span>:<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">isdigit(c);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;l&#39;</span>:<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">islower(c);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;p&#39;</span>:<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ispunct(c);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;s&#39;</span>:<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">isspace(c);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;u&#39;</span>:<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">isupper(c);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;w&#39;</span>:<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">isalnum(c);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;x&#39;</span>:<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">isxdigit(c);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;z&#39;</span>:<span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(c</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(cl</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">c);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(islower(cl)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">res</span><span style="color: #f92672">:!</span><span style="color: #f8f8f2">res);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">matchbracketclass</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ec){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">sig</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;^&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">sig</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ec){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;%&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(match_class(c,uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p)))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">sig;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;-&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ec)){</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">+=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">c</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">c</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">sig;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">c)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">sig;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">sig;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">singlematch</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ep){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;.&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;%&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">match_class(c,uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)));</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;[&#39;</span>:<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">matchbracketclass(c,p,ep</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">default:</span><span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">c);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">match</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p);</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">matchbalance</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f92672">||*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_error(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;unbalanced pattern&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">!=*</span><span style="color: #f8f8f2">p)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">p;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">=*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">cont</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">src_end){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">cont</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">s</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">b)cont</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">max_expand</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ep){</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">((s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">i)</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">src_end</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">singlematch(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">i)),p,ep))</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">match(ms,(s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">i),ep</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(res)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">min_expand</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ep){</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;;){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">match(ms,s,ep</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(res</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(s</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">src_end</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">singlematch(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s),p,ep))</span>
<span style="color: #f8f8f2">s</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">start_capture</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">what){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">level</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">level;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(level</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">32</span><span style="color: #f8f8f2">)luaL_error(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;too many captures&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[level].init</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">s;</span>
<span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[level].len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">what;</span>
<span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">level</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">level</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">match(ms,s,p))</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">level</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">end_capture</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">capture_to_close(ms);</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[l].len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[l].init;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">match(ms,s,p))</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span>
<span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[l].len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">match_capture</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">l){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">len;</span>
<span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">check_capture(ms,l);</span>
<span style="color: #f8f8f2">len</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[l].len;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">src_end</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">s)</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">len</span><span style="color: #f92672">&amp;&amp;</span>
<span style="color: #f8f8f2">memcmp(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[l].init,s,len)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">len;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">match</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p){</span>
<span style="color: #f8f8f2">init:</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;(&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;)&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">start_capture(ms,s,p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">start_capture(ms,s,p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;)&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">end_capture(ms,s,p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;%&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;b&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">matchbalance(ms,s,p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(s</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">+=</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">init;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;f&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ep;</span><span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">previous;</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">+=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;[&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_error(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;missing &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;[&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; after &quot;</span>
<span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;%%f&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; in pattern&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">ep</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">classend(ms,p);</span>
<span style="color: #f8f8f2">previous</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(s</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">src_init)</span><span style="color: #f92672">?</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f92672">:*</span><span style="color: #f8f8f2">(s</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(matchbracketclass(uchar(previous),p,ep</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">||</span>
<span style="color: #f92672">!</span><span style="color: #f8f8f2">matchbracketclass(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s),p,ep</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ep;</span><span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">init;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isdigit(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)))){</span>
<span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">match_capture(ms,s,uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)));</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(s</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">+=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">init;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">dflt;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\0&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">s;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;$&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(s</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">src_end)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">dflt;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:dflt</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ep</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">classend(ms,p);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">m</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">src_end</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">singlematch(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s),p,ep);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ep){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;?&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">res;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(m</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">((res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">match(ms,s</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,ep</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL))</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ep</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span><span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">init;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;*&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">max_expand(ms,s,p,ep);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;+&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(m</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">max_expand(ms,s</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,p,ep)</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">NULL);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;-&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">min_expand(ms,s,p,ep);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">m)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">s</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ep;</span><span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">init;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">lmemfind</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s1,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l1,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s2,</span><span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l2){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l2</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">s1;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l2</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">l1)</span><span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">init;</span>
<span style="color: #f8f8f2">l2</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">l1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">l1</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">l2;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(l1</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">(init</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)memchr(s1,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s2,l1))</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">init</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(memcmp(init,s2</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,l2)</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">init</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">l1</span><span style="color: #f92672">-=</span><span style="color: #f8f8f2">init</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">s1;</span>
<span style="color: #f8f8f2">s1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">init;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">NULL;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">push_onecapture</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">&gt;=</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">level){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">lua_pushlstring(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,s,e</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">s);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">luaL_error(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;invalid capture index&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[i].len;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))luaL_error(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #e6db74">&quot;unfinished capture&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">lua_pushinteger(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[i].init</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">src_init</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span>
<span style="color: #f8f8f2">lua_pushlstring(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">capture[i].init,l);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">push_captures</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nlevels</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">level</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">s)</span><span style="color: #f92672">?</span><span style="color: #ae81ff">1</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">level;</span>
<span style="color: #f8f8f2">luaL_checkstack(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,nlevels,</span><span style="color: #e6db74">&quot;too many captures&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">nlevels;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">push_onecapture(ms,i,s,e);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">nlevels;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_find_aux</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">find){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l1,l2;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l1);</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l2);</span>
<span style="color: #66d9ef">ptrdiff_t</span> <span style="color: #f8f8f2">init</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">posrelat(luaL_optinteger(L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),l1)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(init</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)init</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)(init)</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">l1)init</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">ptrdiff_t</span><span style="color: #f8f8f2">)l1;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(find</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">(lua_toboolean(L,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">||</span>
<span style="color: #f8f8f2">strpbrk(p,</span><span style="color: #e6db74">&quot;^$*+?.([%-&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">NULL)){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s2</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lmemfind(s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">init,l1</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">init,p,l2);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(s2){</span>
<span style="color: #f8f8f2">lua_pushinteger(L,s2</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushinteger(L,s2</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">l2);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">MatchState</span> <span style="color: #f8f8f2">ms;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">anchor</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;^&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">:</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s1</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">init;</span>
<span style="color: #f8f8f2">ms.L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">ms.src_init</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">s;</span>
<span style="color: #f8f8f2">ms.src_end</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">l1;</span>
<span style="color: #66d9ef">do</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">res;</span>
<span style="color: #f8f8f2">ms.level</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((res</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">match(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ms,s1,p))</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(find){</span>
<span style="color: #f8f8f2">lua_pushinteger(L,s1</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushinteger(L,res</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">s);</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">push_captures(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ms,NULL,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">push_captures(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ms,s1,res);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span><span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(s1</span><span style="color: #f92672">++&lt;</span><span style="color: #f8f8f2">ms.src_end</span><span style="color: #f92672">&amp;&amp;!</span><span style="color: #f8f8f2">anchor);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_pushnil(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_find</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">str_find_aux(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_match</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">str_find_aux(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">gmatch_aux</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">MatchState</span> <span style="color: #f8f8f2">ms;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">ls;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tolstring(L,lua_upvalueindex(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ls);</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tostring(L,lua_upvalueindex(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">src;</span>
<span style="color: #f8f8f2">ms.L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">ms.src_init</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">s;</span>
<span style="color: #f8f8f2">ms.src_end</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">ls;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(src</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)lua_tointeger(L,lua_upvalueindex(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">src</span><span style="color: #f92672">&lt;=</span><span style="color: #f8f8f2">ms.src_end;</span>
<span style="color: #f8f8f2">src</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e;</span>
<span style="color: #f8f8f2">ms.level</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">match(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ms,src,p))</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL){</span>
<span style="color: #f8f8f2">lua_Integer</span> <span style="color: #f8f8f2">newstart</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">s;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">==</span><span style="color: #f8f8f2">src)newstart</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">lua_pushinteger(L,newstart);</span>
<span style="color: #f8f8f2">lua_replace(L,lua_upvalueindex(</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">push_captures(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ms,src,e);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">gmatch</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_checkstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_checkstring(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_settop(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushinteger(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushcclosure(L,gmatch_aux,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">add_s</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">b,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l,i;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">news</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tolstring(ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l);</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">l;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(news[i]</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;%&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_addchar(b,news[i]);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">isdigit(uchar(news[i])))</span>
<span style="color: #f8f8f2">luaL_addchar(b,news[i]);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(news[i]</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;0&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_addlstring(b,s,e</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">s);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">push_onecapture(ms,news[i]</span><span style="color: #f92672">-</span><span style="color: #e6db74">&#39;1&#39;</span><span style="color: #f8f8f2">,s,e);</span>
<span style="color: #f8f8f2">luaL_addvalue(b);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">add_value</span><span style="color: #f8f8f2">(MatchState</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">ms,luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">b,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s,</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e){</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">ms</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">L;</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(lua_type(L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)){</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">3</span>:
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">4</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">add_s(ms,b,s,e);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">6</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n;</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">push_captures(ms,s,e);</span>
<span style="color: #f8f8f2">lua_call(L,n,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span> <span style="color: #ae81ff">5</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">push_onecapture(ms,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,s,e);</span>
<span style="color: #f8f8f2">lua_gettable(L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_toboolean(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushlstring(L,s,e</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">s);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">lua_isstring(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;invalid replacement value (a %s)&quot;</span><span style="color: #f8f8f2">,luaL_typename(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">luaL_addvalue(b);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_gsub</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">srcl;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">src</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">srcl);</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checkstring(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">tr</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_type(L,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">max_s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_optint(L,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">,srcl</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">anchor</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;^&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">:</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">MatchState</span> <span style="color: #f8f8f2">ms;</span>
<span style="color: #f8f8f2">luaL_Buffer</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #f8f8f2">luaL_argcheck(L,tr</span><span style="color: #f92672">==</span><span style="color: #ae81ff">3</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">tr</span><span style="color: #f92672">==</span><span style="color: #ae81ff">4</span><span style="color: #f92672">||</span>
<span style="color: #f8f8f2">tr</span><span style="color: #f92672">==</span><span style="color: #ae81ff">6</span><span style="color: #f92672">||</span><span style="color: #f8f8f2">tr</span><span style="color: #f92672">==</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span>
<span style="color: #e6db74">&quot;string/function/table expected&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_buffinit(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #f8f8f2">ms.L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">L;</span>
<span style="color: #f8f8f2">ms.src_init</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">src;</span>
<span style="color: #f8f8f2">ms.src_end</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">src</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">srcl;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">max_s){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">e;</span>
<span style="color: #f8f8f2">ms.level</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">e</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">match(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ms,src,p);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e){</span>
<span style="color: #f8f8f2">n</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">add_value(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">ms,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,src,e);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(e</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">e</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">src)</span>
<span style="color: #f8f8f2">src</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">e;</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(src</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ms.src_end)</span>
<span style="color: #f8f8f2">luaL_addchar(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">src</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(anchor)</span><span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaL_addlstring(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,src,ms.src_end</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">src);</span>
<span style="color: #f8f8f2">luaL_pushresult(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #f8f8f2">lua_pushinteger(L,n);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">addquoted</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,luaL_Buffer</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">b,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">arg){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,arg,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l);</span>
<span style="color: #f8f8f2">luaL_addchar(b,</span><span style="color: #e6db74">&#39;&quot;&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(l</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;&quot;&#39;</span>:<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\\&#39;</span>:<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\n&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaL_addchar(b,</span><span style="color: #e6db74">&#39;\\&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">luaL_addchar(b,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\r&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaL_addlstring(b,</span><span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\\</span><span style="color: #e6db74">r&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;\0&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">luaL_addlstring(b,</span><span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\\</span><span style="color: #e6db74">000&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #f8f8f2">luaL_addchar(b,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">s</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaL_addchar(b,</span><span style="color: #e6db74">&#39;&quot;&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #a6e22e">scanformat</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">strfrmt,</span><span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">form){</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strfrmt;</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">strchr(</span><span style="color: #e6db74">&quot;-+ #0&quot;</span><span style="color: #f8f8f2">,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p)</span><span style="color: #f92672">!=</span><span style="color: #f8f8f2">NULL)p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">((</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)(p</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">strfrmt)</span><span style="color: #f92672">&gt;=</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;-+ #0&quot;</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;invalid format (repeated flags)&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isdigit(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p)))p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isdigit(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p)))p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;.&#39;</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isdigit(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p)))p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isdigit(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p)))p</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(isdigit(uchar(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">p)))</span>
<span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;invalid format (width or precision too long)&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">(form</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;%&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">strncpy(form,strfrmt,p</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">strfrmt</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">form</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">p</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">strfrmt</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f92672">*</span><span style="color: #f8f8f2">form</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">p;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">addintlen</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">form){</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strlen(form);</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">spec</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">form[l</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">strcpy(form</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;l&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">form[l</span><span style="color: #f92672">+</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;l&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">spec;</span>
<span style="color: #f8f8f2">form[l</span><span style="color: #f92672">+</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;l&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;\0&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">str_format</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">top</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_gettop(L);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">arg</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">sfl;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">strfrmt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,arg,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">sfl);</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">strfrmt_end</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">strfrmt</span><span style="color: #f92672">+</span><span style="color: #f8f8f2">sfl;</span>
<span style="color: #f8f8f2">luaL_Buffer</span> <span style="color: #f8f8f2">b;</span>
<span style="color: #f8f8f2">luaL_buffinit(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(strfrmt</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">strfrmt_end){</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">strfrmt</span><span style="color: #f92672">!=</span><span style="color: #e6db74">&#39;%&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_addchar(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">strfrmt</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*++</span><span style="color: #f8f8f2">strfrmt</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;%&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">luaL_addchar(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">strfrmt</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">form[(</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;-+ #0&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;l&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2">)];</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buff[</span><span style="color: #ae81ff">512</span><span style="color: #f8f8f2">];</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">arg</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">top)</span>
<span style="color: #f8f8f2">luaL_argerror(L,arg,</span><span style="color: #e6db74">&quot;no value&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">strfrmt</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">scanformat(L,strfrmt,form);</span>
<span style="color: #66d9ef">switch</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">strfrmt</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;c&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">sprintf(buff,form,(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">)luaL_checknumber(L,arg));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;d&#39;</span>:<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;i&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">addintlen(form);</span>
<span style="color: #f8f8f2">sprintf(buff,form,(</span><span style="color: #66d9ef">long</span><span style="color: #f8f8f2">)luaL_checknumber(L,arg));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;o&#39;</span>:<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;u&#39;</span>:<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;x&#39;</span>:<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;X&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">addintlen(form);</span>
<span style="color: #f8f8f2">sprintf(buff,form,(</span><span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">long</span><span style="color: #f8f8f2">)luaL_checknumber(L,arg));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;e&#39;</span>:<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;E&#39;</span>:<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;f&#39;</span>:
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;g&#39;</span>:<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;G&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">sprintf(buff,form,(</span><span style="color: #66d9ef">double</span><span style="color: #f8f8f2">)luaL_checknumber(L,arg));</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;q&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">addquoted(L,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,arg);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">case</span><span style="color: #e6db74">&#39;s&#39;</span>:<span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">size_t</span> <span style="color: #f8f8f2">l;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">s</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_checklstring(L,arg,</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">l);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #f8f8f2">strchr(form,</span><span style="color: #e6db74">&#39;.&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;&amp;</span><span style="color: #f8f8f2">l</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">100</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_pushvalue(L,arg);</span>
<span style="color: #f8f8f2">luaL_addvalue(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">continue</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">sprintf(buff,form,s);</span>
<span style="color: #66d9ef">break</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">default:{</span>
<span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">luaL_error(L,</span><span style="color: #e6db74">&quot;invalid option &quot;</span><span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;%%%c&quot;</span><span style="color: #f8f8f2">)</span><span style="color: #e6db74">&quot; to &quot;</span>
<span style="color: #f8f8f2">LUA_QL(</span><span style="color: #e6db74">&quot;format&quot;</span><span style="color: #f8f8f2">),</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">(strfrmt</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaL_addlstring(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b,buff,strlen(buff));</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">luaL_pushresult(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">b);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span> <span style="color: #f8f8f2">strlib[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;byte&quot;</span><span style="color: #f8f8f2">,str_byte},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;char&quot;</span><span style="color: #f8f8f2">,str_char},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;find&quot;</span><span style="color: #f8f8f2">,str_find},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;format&quot;</span><span style="color: #f8f8f2">,str_format},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;gmatch&quot;</span><span style="color: #f8f8f2">,gmatch},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;gsub&quot;</span><span style="color: #f8f8f2">,str_gsub},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;lower&quot;</span><span style="color: #f8f8f2">,str_lower},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;match&quot;</span><span style="color: #f8f8f2">,str_match},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;rep&quot;</span><span style="color: #f8f8f2">,str_rep},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;sub&quot;</span><span style="color: #f8f8f2">,str_sub},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;upper&quot;</span><span style="color: #f8f8f2">,str_upper},</span>
<span style="color: #f8f8f2">{NULL,NULL}</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">createmetatable</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">lua_createtable(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushliteral(L,</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setmetatable(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushvalue(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setfield(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #e6db74">&quot;__index&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pop(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">luaopen_string</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">luaL_register(L,</span><span style="color: #e6db74">&quot;string&quot;</span><span style="color: #f8f8f2">,strlib);</span>
<span style="color: #f8f8f2">createmetatable(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span> <span style="color: #f8f8f2">lualibs[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;&quot;</span><span style="color: #f8f8f2">,luaopen_base},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;table&quot;</span><span style="color: #f8f8f2">,luaopen_table},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;io&quot;</span><span style="color: #f8f8f2">,luaopen_io},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;os&quot;</span><span style="color: #f8f8f2">,luaopen_os},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;string&quot;</span><span style="color: #f8f8f2">,luaopen_string},</span>
<span style="color: #f8f8f2">{NULL,NULL}</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">luaL_openlibs</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">luaL_Reg</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">lib</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lualibs;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(;lib</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func;lib</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">){</span>
<span style="color: #f8f8f2">lua_pushcfunction(L,lib</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">func);</span>
<span style="color: #f8f8f2">lua_pushstring(L,lib</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">name);</span>
<span style="color: #f8f8f2">lua_call(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">typedef</span> <span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">UB;</span>
<span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">UB</span> <span style="color: #a6e22e">barg</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L,</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">idx){</span>
<span style="color: #66d9ef">union</span><span style="color: #f8f8f2">{lua_Number</span> <span style="color: #f8f8f2">n;U64</span> <span style="color: #f8f8f2">b;}bn;</span>
<span style="color: #f8f8f2">bn.n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_tonumber(L,idx)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">6755399441055744.0</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(bn.n</span><span style="color: #f92672">==</span><span style="color: #ae81ff">0.0</span><span style="color: #f92672">&amp;&amp;!</span><span style="color: #f8f8f2">lua_isnumber(L,idx))luaL_typerror(L,idx,</span><span style="color: #e6db74">&quot;number&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">(UB)bn.b;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#define BRET(b)lua_pushnumber(L,(lua_Number)(int)(b));return 1;</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">tobit</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">BRET(barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">bnot</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">BRET(</span><span style="color: #f92672">~</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">band</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;UB</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span><span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_gettop(L);i</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)b</span><span style="color: #f92672">&amp;=</span><span style="color: #f8f8f2">barg(L,i);BRET(b)}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">bor</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;UB</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span><span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_gettop(L);i</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)b</span><span style="color: #f92672">|=</span><span style="color: #f8f8f2">barg(L,i);BRET(b)}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">bxor</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;UB</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span><span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_gettop(L);i</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)b</span><span style="color: #f92672">^=</span><span style="color: #f8f8f2">barg(L,i);BRET(b)}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">lshift</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">UB</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">31</span><span style="color: #f8f8f2">;BRET(b</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">n)}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">rshift</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">UB</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">31</span><span style="color: #f8f8f2">;BRET(b</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #f8f8f2">n)}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">arshift</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">UB</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">31</span><span style="color: #f8f8f2">;BRET((</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">)b</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #f8f8f2">n)}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">rol</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">UB</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">31</span><span style="color: #f8f8f2">;BRET((b</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">n)</span><span style="color: #f92672">|</span><span style="color: #f8f8f2">(b</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">32</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">n)))}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">ror</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">UB</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">31</span><span style="color: #f8f8f2">;BRET((b</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #f8f8f2">n)</span><span style="color: #f92672">|</span><span style="color: #f8f8f2">(b</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">32</span><span style="color: #f92672">-</span><span style="color: #f8f8f2">n)))}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">bswap</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">UB</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(b</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #ae81ff">24</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">|</span><span style="color: #f8f8f2">((b</span><span style="color: #f92672">&gt;&gt;</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">0xff00</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">|</span><span style="color: #f8f8f2">((b</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">0xff00</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">|</span><span style="color: #f8f8f2">(b</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #ae81ff">24</span><span style="color: #f8f8f2">);BRET(b)}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">int</span> <span style="color: #a6e22e">tohex</span><span style="color: #f8f8f2">(lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L){</span>
<span style="color: #f8f8f2">UB</span> <span style="color: #f8f8f2">b</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">barg(L,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">n</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">lua_isnone(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">?</span><span style="color: #ae81ff">8</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">)barg(L,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">hexdigits</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;0123456789abcdef&quot;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buf[</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">];</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">){n</span><span style="color: #f92672">=-</span><span style="color: #f8f8f2">n;hexdigits</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;0123456789ABCDEF&quot;</span><span style="color: #f8f8f2">;}</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(n</span><span style="color: #f92672">&gt;</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">)n</span><span style="color: #f92672">=</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">)n;</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">&gt;=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;){buf[i]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">hexdigits[b</span><span style="color: #f92672">&amp;</span><span style="color: #ae81ff">15</span><span style="color: #f8f8f2">];b</span><span style="color: #f92672">&gt;&gt;=</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">;}</span>
<span style="color: #f8f8f2">lua_pushlstring(L,buf,(</span><span style="color: #66d9ef">size_t</span><span style="color: #f8f8f2">)n);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">luaL_Reg</span> <span style="color: #f8f8f2">bitlib[]</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">{</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;tobit&quot;</span><span style="color: #f8f8f2">,tobit},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;bnot&quot;</span><span style="color: #f8f8f2">,bnot},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;band&quot;</span><span style="color: #f8f8f2">,band},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;bor&quot;</span><span style="color: #f8f8f2">,bor},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;bxor&quot;</span><span style="color: #f8f8f2">,bxor},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;lshift&quot;</span><span style="color: #f8f8f2">,lshift},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;rshift&quot;</span><span style="color: #f8f8f2">,rshift},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;arshift&quot;</span><span style="color: #f8f8f2">,arshift},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;rol&quot;</span><span style="color: #f8f8f2">,rol},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;ror&quot;</span><span style="color: #f8f8f2">,ror},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;bswap&quot;</span><span style="color: #f8f8f2">,bswap},</span>
<span style="color: #f8f8f2">{</span><span style="color: #e6db74">&quot;tohex&quot;</span><span style="color: #f8f8f2">,tohex},</span>
<span style="color: #f8f8f2">{NULL,NULL}</span>
<span style="color: #f8f8f2">};</span>
<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">main</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">argc,</span><span style="color: #66d9ef">char</span><span style="color: #f92672">**</span><span style="color: #f8f8f2">argv){</span>
<span style="color: #f8f8f2">lua_State</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">L</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">luaL_newstate();</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>
<span style="color: #f8f8f2">luaL_openlibs(L);</span>
<span style="color: #f8f8f2">luaL_register(L,</span><span style="color: #e6db74">&quot;bit&quot;</span><span style="color: #f8f8f2">,bitlib);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(argc</span><span style="color: #f92672">&lt;</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span><span style="color: #66d9ef">return</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_createtable(L,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_pushstring(L,argv[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]);</span>
<span style="color: #f8f8f2">lua_rawseti(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">lua_setglobal(L,</span><span style="color: #e6db74">&quot;arg&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(luaL_loadfile(L,argv[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]))</span>
<span style="color: #66d9ef">goto</span> <span style="color: #f8f8f2">err;</span>
<span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;i</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">argc;i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">lua_pushstring(L,argv[i]);</span>
<span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(lua_pcall(L,argc</span><span style="color: #f92672">-</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)){</span>
<span style="color: #f8f8f2">err:</span>
<span style="color: #f8f8f2">fprintf(stderr,</span><span style="color: #e6db74">&quot;Error: %s</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,lua_tostring(L,</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">));</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">lua_close(L);</span>
<span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
</pre></div>
